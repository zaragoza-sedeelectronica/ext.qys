var ieArrayVersion=null;var ieVersion=null;if(navigator.appName=="Microsoft Internet Explorer"){ieArrayVersion=navigator.appVersion.split("MSIE");ieVersion=parseFloat(ieArrayVersion[1])}if(!((ieVersion!=null)&&(ieVersion>=9))){OpenLayers.Layer.Vector.prototype.renderers=["VML","SVG","Canvas"]}if(mobileNavigator){var isAndroid4=false;try{var version=navigator.appVersion.toLowerCase();var versionNumber;var indexIni;if(version.indexOf("android")!=-1){indexIni=version.indexOf("android");versionNumber=version.substring(indexIni+8,indexIni+version.substring(indexIni).indexOf(";"));indexString=versionNumber.indexOf("4.");if(indexString==0){isAndroid4=true}}}catch(e){isAndroid4=false}function closeExpandedPopup(){var a=document.getElementById("expandedPopupDiv");if(a&&a.style&&a.style.display&&(a.style.display=="block")){if(document.getElementById("expandedPopup")){a.removeChild(document.getElementById("expandedPopup"))}a.style.display="none";a.style.visibility="hidden"}if((mobileNavigator)&&parent&&parent.getFacade){if(parent.getFacade().habilitaBotones){parent.getFacade().habilitaBotones()}}return false}function scrollUpPopupContent(){nodo=document.getElementById("expandedPopupContent");if((parseInt(nodo.scrollHeight)>parseInt(nodo.clientHeight))&&(parseInt(nodo.scrollTop)>0)){nodo.scrollTop-=Math.ceil(parseInt(nodo.clientHeight)/2)}return false}function scrollDownPopupContent(){nodo=document.getElementById("expandedPopupContent");if((parseInt(nodo.scrollHeight)>parseInt(nodo.clientHeight))&&(parseInt(nodo.scrollTop)<parseInt(nodo.scrollHeight))){nodo.scrollTop+=Math.ceil(parseInt(nodo.clientHeight)/2)}return false}if(isAndroid4){OpenLayers.Tile.IAAA_Image.prototype.initialize=function(f,a,g,c,d,b){OpenLayers.Tile.Image.prototype.initialize.apply(this,[f,a,g,c,d,b]);OpenLayers.Util.extend(this,b);this.events.register("loadend",null,this.onLoadHandler);if(OpenLayers.IAAA_Utils.drawTilesInSpecificDocument){this.frame=OpenLayers.IAAA_Utils.specificDocument.createElement("div");this.frame.style.overflow="hidden";this.frame.style.position="absolute";this.initImgDiv=function(){var l=this.layer.imageOffset;var h=this.layer.getImageSize();if(this.layer.alpha){this.imgDiv=OpenLayers.IAAA_Utils.specificDocument.createElement("div");OpenLayers.Util.modifyDOMElement(this.imgDiv,OpenLayers.Util.createUniqueID("OpenLayersDiv"),null,null,"absolute",null,null,null);var k=OpenLayers.IAAA_Utils.specificDocument.createElement("img");var m=OpenLayers.Util.createUniqueID("OpenLayersDiv");OpenLayers.Util.modifyDOMElement(k,m,null,null,"relative",null,null,false);k.style.alt=m;k.galleryImg="no";this.imgDiv.appendChild(k);this.imgDiv.style.display="none";OpenLayers.Event.observe(this.imgDiv,"load",OpenLayers.Function.bind(OpenLayers.Util.onImageLoad,this.imgDiv));OpenLayers.Event.observe(this.imgDiv,"error",OpenLayers.Function.bind(OpenLayers.Util.onImageLoadError,this.imgDiv));OpenLayers.Util.modifyAlphaImageDiv(this.imgDiv,null,l,h,null,"relative",null,null,null)}else{this.imgDiv=OpenLayers.IAAA_Utils.specificDocument.createElement("img");var m=OpenLayers.Util.createUniqueID("OpenLayersDiv");OpenLayers.Util.modifyDOMElement(this.imgDiv,m,l,h,"relative",null,null,null);this.imgDiv.style.display="none";OpenLayers.Event.observe(this.imgDiv,"load",OpenLayers.Function.bind(OpenLayers.Util.onImageLoad,this.imgDiv));OpenLayers.Event.observe(this.imgDiv,"error",OpenLayers.Function.bind(OpenLayers.Util.onImageLoadError,this.imgDiv));this.imgDiv.style.alt=m;this.imgDiv.galleryImg="no"}this.imgDiv.className="olTileImage";this.imgDiv.setAttribute("unselectable","on");this.frame.setAttribute("unselectable","on");this.frame.style.MozUserSelect="none";this.imgDiv.tile=this;this.frame.appendChild(this.imgDiv);this.layer.div.appendChild(this.frame);if(this.layer.opacity!=null){OpenLayers.Util.modifyDOMElement(this.imgDiv,null,null,null,null,null,null,this.layer.opacity)}this.imgDiv.map=this.layer.map;var i=function(){if(this.layer.singleTile){OpenLayers.Util.modifyDOMElement(this.frame,null,this.position,this.size)}this.frame.style.display="block";if(this.isLoading){this.isLoading=false;this.events.triggerEvent("loadend")}}}}};OpenLayers.Tile.IAAA_Image.prototype.initImgDiv=function(){if(this.imgDiv==null){var c=this.layer.imageOffset;var a=this.size;if(this.layer.alpha){this.imgDiv=OpenLayers.Util.createAlphaImageDiv(null,c,a,null,"relative",null,null,null,this.delayDisplay)}else{this.imgDiv=OpenLayers.Util.createImage(null,c,a,null,"relative",null,null,this.delayDisplay)}this.imgDiv.className="olTileImage";this.imgDiv.setAttribute("unselectable","on");this.frame.setAttribute("unselectable","on");this.frame.style.MozUserSelect="none";this.imgDiv.tile=this;this.frame.appendChild(this.imgDiv);this.layer.div.appendChild(this.frame);if(this.layer.opacity!=null){OpenLayers.Util.modifyDOMElement(this.imgDiv,null,null,null,null,null,null,this.layer.opacity)}this.imgDiv.map=this.layer.map;var b=function(){if(this.layer.singleTile){OpenLayers.Util.modifyDOMElement(this.frame,null,this.position,this.size)}this.frame.style.display="block";if(this.isLoading){this.isLoading=false;this.events.triggerEvent("loadend")}this.frame.style.backgroundImage="url("+this.imgDiv.src+")";this.imgDiv.style.display="none"};OpenLayers.Event.observe(this.imgDiv,"load",OpenLayers.Function.bind(b,this))}}}OpenLayers.Popup.IAAA_FramedCloud.prototype.updateBlocks=function(){if(!this.blocks){this.createBlocks()}if(this.size&&this.relativePosition){var E=this.positionBlocks[this.relativePosition];var f,v;for(var x=0;x<E.blocks.length;x++){var a=E.blocks[x];var m=this.blocks[x];var u=a.anchor.left;var C=a.anchor.bottom;var q=a.anchor.right;var o=a.anchor.top;var n=(isNaN(a.size.w))?this.size.w-(q+u):a.size.w;var y=(isNaN(a.size.h))?this.size.h-(C+o):a.size.h;m.div.style.width=(n<0?0:n)+"px";m.div.style.height=(y<0?0:y)+"px";var k=0;var z=0;var B=0;var D=0;if((this.stemDivOffset!=null)&&(this.stemDivOffset!=undefined)&&(x==4)){if((this.stemDivOffset[this.relativePosition]!=null)&&(this.stemDivOffset[this.relativePosition]!=undefined)){if((this.stemDivOffset[this.relativePosition].left!=undefined)&&(this.stemDivOffset[this.relativePosition].left!=null)){k=this.stemDivOffset[this.relativePosition].left}if((this.stemDivOffset[this.relativePosition].top!=undefined)&&(this.stemDivOffset[this.relativePosition].top!=null)){z=this.stemDivOffset[this.relativePosition].top}if((this.stemDivOffset[this.relativePosition].right!=undefined)&&(this.stemDivOffset[this.relativePosition].right!=null)){B=this.stemDivOffset[this.relativePosition].right}if((this.stemDivOffset[this.relativePosition].bottom!=undefined)&&(this.stemDivOffset[this.relativePosition].bottom!=null)){D=this.stemDivOffset[this.relativePosition].bottom}}}m.div.style.left=(u!=null)?(u+k)+"px":"";m.div.style.bottom=(C!=null)?(C+D)+"px":"";m.div.style.right=(q!=null)?(q+B)+"px":"";m.div.style.top=(o!=null)?(o+z)+"px":"";if((m.div!=null)&&(this.opacity!=null)&&(this.opacity!=undefined)){if((this.opacity<1)||this.useOpacityFilter){m.div.style.opacity=this.opacity;m.div.style.filter="alpha(opacity="+this.opacity*100+")"}}if((x==4)&&(this.blockOpacity!=null)&&(this.blockOpacity!=undefined)&&(this.blockOpacity.stem!=null)&&(this.blockOpacity.stem!=undefined)){if((this.blockOpacity.stem<1)||this.useOpacityFilter){m.div.style.opacity=this.blockOpacity.stem;m.div.style.filter="alpha(opacity="+this.blockOpacity.stem*100+")"}}m.image.style.left=a.position.x+"px";m.image.style.top=a.position.y+"px";if((this.stemSize!=null)&&(this.stemSize!=undefined)&&(x==4)){switch(this.relativePosition){case"tr":case"br":m.image.style.left=a.position.x-this.stemSize.w-this.stemSizeOffsetRight+"px";break;case"tl":case"bl":m.image.style.left=a.position.x-this.stemSize.w-this.stemSizeOffsetLeft+"px";break;default:break}}if((this.stemImageOffset!=null)&&(this.stemImageOffset!=undefined)&&(x==4)){if((this.stemImageOffset[this.relativePosition]!=null)&&(this.stemImageOffset[this.relativePosition]!=undefined)){if((this.stemImageOffset[this.relativePosition].left!=undefined)&&(this.stemImageOffset[this.relativePosition].left!=null)){m.image.style.left=a.position.x+this.stemImageOffset[this.relativePosition].left+"px"}if((this.stemImageOffset[this.relativePosition].top!=undefined)&&(this.stemImageOffset[this.relativePosition].top!=null)){m.image.style.top=a.position.y+this.stemImageOffset[this.relativePosition].top+"px"}}}if((this.addLogo)&&(x==this.logoPosition)){this.logoDiv.align="center";if(this.logoSize!=null){this.logoDiv.style.width=this.logoSize.w+((this.useLogoDivBackground)?2:0);this.logoDiv.style.height=this.logoSize.h+((this.useLogoDivBackground)?2:0)}this.logoDiv.style.left=m.div.style.left;this.logoDiv.style.bottom=m.div.style.bottom;this.logoDiv.style.right=m.div.style.right;this.logoDiv.style.top=m.div.style.top;if(this.useLogoDivBackground){this.imgLogoDiv.style.top=1}var s;switch(this.logoPosition){case 0:if((typeof this.logoDiv.style.left).toLowerCase()=="string"){s=parseInt(this.logoDiv.style.left.substring(0,(this.logoDiv.style.left.indexOf("px"))));this.logoDiv.style.left=s+this.popupMargin+"px"}else{this.logoDiv.style.left+=this.popupMargin}if((typeof this.logoDiv.style.top).toLowerCase()=="string"){s=parseInt(this.logoDiv.style.top.substring(0,(this.logoDiv.style.top.indexOf("px"))));this.logoDiv.style.top=s+this.popupMargin+"px"}else{this.logoDiv.style.top+=this.popupMargin}break;case 1:if((typeof this.logoDiv.style.right).toLowerCase()=="string"){s=parseInt(this.logoDiv.style.right.substring(0,(this.logoDiv.style.right.indexOf("px"))));this.logoDiv.style.right=s+this.popupMargin+"px"}else{this.logoDiv.style.right+=this.popupMargin}if((typeof this.logoDiv.style.top).toLowerCase()=="string"){s=parseInt(this.logoDiv.style.top.substring(0,(this.logoDiv.style.top.indexOf("px"))));this.logoDiv.style.top=s+this.popupMargin+"px"}else{this.logoDiv.style.top+=this.popupMargin}break;case 2:if((typeof this.logoDiv.style.left).toLowerCase()=="string"){s=parseInt(this.logoDiv.style.left.substring(0,(this.logoDiv.style.left.indexOf("px"))));this.logoDiv.style.left=s+this.popupMargin+"px"}else{this.logoDiv.style.left+=this.popupMargin}if((typeof this.logoDiv.style.bottom).toLowerCase()=="string"){s=parseInt(this.logoDiv.style.bottom.substring(0,(this.logoDiv.style.bottom.indexOf("px"))));this.logoDiv.style.bottom=s+this.popupMargin+"px"}else{this.logoDiv.style.bottom+=this.popupMargin}break;case 3:if((typeof this.logoDiv.style.bottom).toLowerCase()=="string"){s=parseInt(this.logoDiv.style.bottom.substring(0,(this.logoDiv.style.bottom.indexOf("px"))));this.logoDiv.style.bottom=s+this.popupMargin+"px"}else{this.logoDiv.style.bottom+=this.popupMargin}if((typeof this.logoDiv.style.right).toLowerCase()=="string"){s=parseInt(this.logoDiv.style.right.substring(0,(this.logoDiv.style.right.indexOf("px"))));this.logoDiv.style.right=s+this.popupMargin+"px"}else{this.logoDiv.style.right+=this.popupMargin}break;default:break}if(this.logoDivUseOpacity&&(this.opacity!=null)&&(this.opacity!=undefined)){if((this.opacity<1)||this.useOpacityFilter){this.logoDiv.style.opacity=this.opacity;this.logoDiv.style.filter="alpha(opacity="+this.opacity*100+")"}}}if(isAndroid4){if(m.image){m.div.style.backgroundImage="url("+m.image.src+")";m.div.style.backgroundPosition=m.image.style.left+" "+m.image.style.top;m.image.style.display="none"}}}this.contentDiv.style.left=this.padding.left+"px";this.contentDiv.style.top=this.padding.top+"px"}if(this.closeDivUseOpacity&&(this.closeDiv!=null)&&(this.closeDiv!=undefined)&&(this.opacity!=null)&&(this.opacity!=undefined)){if((this.opacity<1)||this.useOpacityFilter){this.closeDiv.style.opacity=this.opacity;this.closeDiv.style.filter="alpha(opacity="+this.opacity*100+")"}}if(this.showShadow){if(this.relativePosition){var E=this.positionShadowBlocks[this.relativePosition];var a,m,d,c,g,A,p;var k,z,B,D;for(var x=0;x<E.blocks.length;x++){a=E.blocks[x];m=this.blocks[x];d=this.shadowBlocks[x];c=((m.div.style.left!=null)&&(m.div.style.left!=undefined)?m.div.style.left:"");g=((m.div.style.bottom!=null)&&(m.div.style.bottom!=undefined)?m.div.style.bottom:"");A=((m.div.style.right!=null)&&(m.div.style.right!=undefined)?m.div.style.right:"");p=((m.div.style.top!=null)&&(m.div.style.top!=undefined)?m.div.style.top:"");d.div.style.width=m.div.style.width;d.div.style.height=m.div.style.height;k=0;z=0;B=0;D=0;if((this.stemDivOffset!=null)&&(this.stemDivOffset!=undefined)&&(x==4)){if((this.stemDivOffset[this.relativePosition]!=null)&&(this.stemDivOffset[this.relativePosition]!=undefined)){if((this.stemDivOffset[this.relativePosition].left!=undefined)&&(this.stemDivOffset[this.relativePosition].left!=null)){k-=this.stemDivOffset[this.relativePosition].left}if((this.stemDivOffset[this.relativePosition].top!=undefined)&&(this.stemDivOffset[this.relativePosition].top!=null)){z-=this.stemDivOffset[this.relativePosition].top}if((this.stemDivOffset[this.relativePosition].right!=undefined)&&(this.stemDivOffset[this.relativePosition].right!=null)){B-=this.stemDivOffset[this.relativePosition].right}if((this.stemDivOffset[this.relativePosition].bottom!=undefined)&&(this.stemDivOffset[this.relativePosition].bottom!=null)){D-=this.stemDivOffset[this.relativePosition].bottom}}}if((this.shadowStemDivOffset!=null)&&(this.shadowStemDivOffset!=undefined)&&(x==4)){if((this.shadowStemDivOffset[this.relativePosition]!=null)&&(this.shadowStemDivOffset[this.relativePosition]!=undefined)){if((this.shadowStemDivOffset[this.relativePosition].left!=undefined)&&(this.shadowStemDivOffset[this.relativePosition].left!=null)){k+=this.shadowStemDivOffset[this.relativePosition].left}if((this.shadowStemDivOffset[this.relativePosition].top!=undefined)&&(this.shadowStemDivOffset[this.relativePosition].top!=null)){z+=this.shadowStemDivOffset[this.relativePosition].top}if((this.shadowStemDivOffset[this.relativePosition].right!=undefined)&&(this.shadowStemDivOffset[this.relativePosition].right!=null)){B+=this.shadowStemDivOffset[this.relativePosition].right}if((this.shadowStemDivOffset[this.relativePosition].bottom!=undefined)&&(this.shadowStemDivOffset[this.relativePosition].bottom!=null)){D+=this.shadowStemDivOffset[this.relativePosition].bottom}}}d.div.style.left=((c!="")?(parseInt(c)-this.shadowRelX+k)+"px":c);d.div.style.bottom=((g!="")?(parseInt(g)-this.shadowRelY+D)+"px":g);d.div.style.right=((A!="")?(parseInt(A)+this.shadowRelX+B)+"px":A);d.div.style.top=((p!="")?(parseInt(p)+this.shadowRelY+z)+"px":p);d.image.style.left=m.image.style.left;d.image.style.top=m.image.style.top;if((this.stemImageOffset!=null)&&(this.stemImageOffset!=undefined)&&(x==4)){if((this.stemImageOffset[this.relativePosition]!=null)&&(this.stemImageOffset[this.relativePosition]!=undefined)){if((this.stemImageOffset[this.relativePosition].left!=undefined)&&(this.stemImageOffset[this.relativePosition].left!=null)){d.image.style.left=parseInt(d.image.style.left)-this.stemImageOffset[this.relativePosition].left+"px"}if((this.stemImageOffset[this.relativePosition].top!=undefined)&&(this.stemImageOffset[this.relativePosition].top!=null)){d.image.style.top=parseInt(d.image.style.top)-this.stemImageOffset[this.relativePosition].top+"px"}}}if((this.shadowStemImageOffset!=null)&&(this.shadowStemImageOffset!=undefined)&&(x==4)){if((this.shadowStemImageOffset[this.relativePosition]!=null)&&(this.shadowStemImageOffset[this.relativePosition]!=undefined)){if((this.shadowStemImageOffset[this.relativePosition].left!=undefined)&&(this.shadowStemImageOffset[this.relativePosition].left!=null)){d.image.style.left=parseInt(d.image.style.left)+this.shadowStemImageOffset[this.relativePosition].left+"px"}if((this.shadowStemImageOffset[this.relativePosition].top!=undefined)&&(this.shadowStemImageOffset[this.relativePosition].top!=null)){d.image.style.top=parseInt(d.image.style.top)+this.shadowStemImageOffset[this.relativePosition].top+"px"}}}if((d.div!=null)&&(this.shadowOpacity!=null)&&(this.shadowOpacity!=undefined)){if((this.shadowOpacity<1)||this.useOpacityFilter){d.div.style.opacity=this.shadowOpacity;d.div.style.filter="alpha(opacity="+this.shadowOpacity*100+")"}}}}this.contentDiv.parentNode.style.overflowX="visible";this.contentDiv.parentNode.style.overflowY="visible";this.contentDiv.parentNode.parentNode.style.overflowX="visible";this.contentDiv.parentNode.parentNode.style.overflowY="visible"}};OpenLayers.Map.IAAA_Map.prototype.updateSize=function(l){var h;if(l&&l.h&&l.w){h=l}else{h=this.getCurrentSize()}var f=false;if(h&&!isNaN(h.h)&&!isNaN(h.w)){this.events.clearMouseCache();var a=this.getSize();if(a==null){this.size=a=h}this.div.style.width="";this.div.style.height="";if(!h.equals(a)){this.size=h;for(var c=0,k=this.layers.length;c<k;c++){this.layers[c].onMapResize()}var b=this.getCachedCenter();if(this.baseLayer!=null&&b!=null){var m=this.getZoom();this.zoom=null;if(mobileNavigator){this.moveToFromUpdateSize=true}this.setCenter(b,m);if(mobileNavigator){this.moveToFromUpdateSize=false}}f=true}else{if(l&&l.h&&l.w){this.div.style.width=l.w;this.div.style.height=l.h;f=true}}if(this.layerContainerDiv&&this.layerContainerDiv.style){this.layerContainerDiv.style.height="100%"}if(this.layerContainerDiv&&this.layerContainerDiv.style){this.layerContainerDiv.style.width="100%"}}if(mobileNavigator&&f){if(this.popups&&this.popups.length){var d=[];for(var c=this.popups.length-1;c>=0;c--){g=null;if(this.popups[c].feature){if(this.popups[c].closeDiv){d.push(this.popups[c].feature)}this.popups[c].feature.popup=null;this.popups[c].feature.attributes.openedOnInit=false;this.popups[c].feature=null}this.popups[c].destroy()}if(this.eventsDiv.style.display=="none"){this.eventsDiv.style.display="block"}if(d.length){var g;for(var c=d.length-1;c>=0;c--){g=d[c];if(g.attributes&&(parseInt(g.attributes.priority)==1)){_showPopup(g,true,"poisPopupPriorityFixed");g.attributes.openedOnInit=true}}}d=[]}else{if(this.eventsDiv.style.display=="none"){this.eventsDiv.style.display="block"}}this.events.triggerEvent("mapsizeupdated")}else{if(mobileNavigator){if(this.eventsDiv.style.display=="none"){this.eventsDiv.style.display="block"}}}};OpenLayers.Map.IAAA_Map.prototype.EVENT_TYPES.push("mapsizeupdated");OpenLayers.Map.IAAA_Map.prototype.moveTo=function(m,b,f){if(!f){f={}}if(b!=null){b=parseFloat(b);if(!this.fractionalZoom){b=Math.round(b)}}var u=f.dragging||this.dragging;var o=f.forceZoomChange;if(!this.getCachedCenter()&&!this.isValidLonLat(m)){m=this.maxExtent.getCenterLonLat();this.center=m.clone()}if(this.restrictedExtent!=null){if(m==null){m=this.center}if(b==null){b=this.getZoom()}var v=this.getResolutionForZoom(b);var q=this.calculateBounds(m,v);if(!this.restrictedExtent.containsBounds(q)){var F=this.restrictedExtent.getCenterLonLat();if(q.getWidth()>this.restrictedExtent.getWidth()){m=new OpenLayers.LonLat(F.lon,m.lat)}else{if(q.left<this.restrictedExtent.left){m=m.add(this.restrictedExtent.left-q.left,0)}else{if(q.right>this.restrictedExtent.right){m=m.add(this.restrictedExtent.right-q.right,0)}}}if(q.getHeight()>this.restrictedExtent.getHeight()){m=new OpenLayers.LonLat(m.lon,F.lat)}else{if(q.bottom<this.restrictedExtent.bottom){m=m.add(0,this.restrictedExtent.bottom-q.bottom)}else{if(q.top>this.restrictedExtent.top){m=m.add(0,this.restrictedExtent.top-q.top)}}}}}var p=o||((this.isValidZoomLevel(b))&&(b!=this.getZoom()));var l=(this.isValidLonLat(m))&&(!m.equals(this.center));var t=!p&&!l&&!u&&(this.layerContainerOrigin==null);if(p||l||u||t){u||this.events.triggerEvent("movestart");if(l){if(!p&&this.center){this.centerLayerContainer(m)}this.center=m.clone()}var G=p?this.getResolutionForZoom(b):this.getResolution();if(p||this.layerContainerOrigin==null){this.layerContainerOrigin=this.getCachedCenter();this.layerContainerDiv.style.left="0px";this.layerContainerDiv.style.top="0px";var s=this.getMaxExtent({restricted:true});var d=s.getCenterLonLat();var n=this.center.lon-d.lon;var c=d.lat-this.center.lat;var C=Math.round(s.getWidth()/G);var z=Math.round(s.getHeight()/G);var h=(parseInt(this.size.w)-C)/2-n/G;var r=(parseInt(this.size.h)-z)/2-c/G;this.minPx=new OpenLayers.Pixel(h,r);this.maxPx=new OpenLayers.Pixel(h+C,r+z)}if(t){return}if(p){this.zoom=b;this.resolution=G;this.viewRequestID++}var k=this.getExtent();var g=[];if(mobileNavigator&&p){var E;for(var x=this.layers.length-1;x>=0;--x){E=this.layers[x];if(E&&E.visibility&&((E.CLASS_NAME=="OpenLayers.Layer.IAAA_GenericVector")||(E.CLASS_NAME=="OpenLayers.Layer.Vector.RootContainer"))){if(E.CLASS_NAME=="OpenLayers.Layer.IAAA_GenericVector"){E.display(false)}else{E.div.style.display="none"}g.push(x)}}}if(this.baseLayer&&this.baseLayer.visibility){this.baseLayer.moveTo(k,p,f.dragging);f.dragging||this.baseLayer.events.triggerEvent("moveend",{zoomChanged:p});if(((this.baseLayer.CLASS_NAME=="OpenLayers.Layer.Google")||(this.baseLayer.CLASS_NAME=="OpenLayers.Layer.IAAA_Google"))&&OpenLayers.IAAA_Utils.getGoogleAPIVersion()==3){var D=function(){try{var H=this.baseLayer.mapObject&&this.baseLayer.mapObject.getDiv()&&this.baseLayer.mapObject.getDiv().firstChild;if(H){H.style.display="block"}if(this.baseLayer.repositionContainer){google.maps.event.removeListener(this.baseLayer.repositionContainer);this.baseLayer.repositionContainer=null;var i=document.getElementById("googleCloneNode");if(i){i.style.display="none"}}}catch(I){}};var A=function(){try{var H=this.baseLayer.mapObject&&this.baseLayer.mapObject.getDiv()&&this.baseLayer.mapObject.getDiv().firstChild;if(H){H.style.display="block"}if(this.baseLayer.tilesLoaded){google.maps.event.removeListener(this.baseLayer.tilesLoaded);this.baseLayer.tilesLoaded=null;var i=document.getElementById("googleCloneNode");if(i){i.style.display="none"}}}catch(I){}};this.baseLayer.tilesLoaded=google.maps.event.addListenerOnce(this.baseLayer.mapObject,"tilesloaded",OpenLayers.Function.bind(A,this));this.baseLayer.repositionContainer=google.maps.event.addListenerOnce(this.baseLayer.mapObject,"idle",OpenLayers.Function.bind(D,this))}}if(this.baseLayer){k=this.baseLayer.getExtent()}for(var x=this.layers.length-1;x>=0;--x){var E=this.layers[x];if(E!==this.baseLayer&&!E.isBaseLayer){var a=E.calculateInRange();if(E.inRange!=a){E.inRange=a;if(!a){E.display(false)}this.events.triggerEvent("changelayer",{layer:E,property:"visibility"})}if(a&&E.visibility){E.moveTo(k,p,f.dragging);f.dragging||E.events.triggerEvent("moveend",{zoomChanged:p})}}}this.events.triggerEvent("move");u||this.events.triggerEvent("moveend");if(p){for(var x=0,y=this.popups.length;x<y;x++){this.popups[x].updatePosition()}this.events.triggerEvent("zoomend");if(mobileNavigator){if(g&&g.length>0){var E;for(var w=0,B=g.length;w<B;w++){E=this.layers[g[w]];if(E.CLASS_NAME=="OpenLayers.Layer.IAAA_GenericVector"){E.display(true)}else{E.div.style.display="block"}}}}}}}}OpenLayers.Map.IAAA_Map.prototype.setCenter=function(f,G,c,g){this.alreadyInSetCenter++;if(this.alreadyInSetCenter==1){this.indexSLDList=[];for(I=0,d=this.layers.length;I<d;I++){if((this.layers[I].CLASS_NAME=="OpenLayers.Layer.IAAA_ServerSLD")&&this.layers[I].visibility){this.indexSLDList.push(I);this.layers[I].setVisibility(false)}}}var O=false;var J=null;if(!this.mapUpdated){var L=this.extentAux;var N=this.getZoom();var E=this.extentAux.getWidth()*((f.lon-L.left)/L.getWidth());var o=this.extentAux.getHeight()*((f.lat-L.bottom)/L.getHeight());f=new OpenLayers.LonLat(E,o);if(G){J=G-N;G=this.getZoomForExtent(this.extentAux,true)+J}this.mapUpdated=true;this.zoomToExtent(this.extentAux);O=true}N=G||this.getZoom();if(this.automaticSrs&&this.baseLayer){var z=this.baseLayer.scales[N];if(this.getExtent()){var l=this.getAutomaticSrs(z);if(l!=this.getProjection()){g=true}}else{g=true}}newArguments=[f,G,c,g];if(((G!=undefined)&&(G!=null)&&(G!=this.getZoom())&&(G>=0)&&((!this.resolutions)||(G<this.resolutions.length)))){for(var I=0,d=this.layers.length;I<d;I++){var a=this.layers[I];if((a.CLASS_NAME=="OpenLayers.Layer.IAAA_IconsWMS")||((a.CLASS_NAME=="OpenLayers.Layer.IAAA_WMS")&&((a.clearOnZoom!=null)&&(a.clearOnZoom!=undefined)&&a.clearOnZoom))){a.clearTiles()}}}var K=false;if(this.automaticSrs&&this.baseLayer){try{var z=this.baseLayer.scales[N];var l=this.getAutomaticSrs(z);if(l!=this.getProjection()){K=true}}catch(M){}}var b=null;if(K){for(var H=0;H<this.controls.length;H++){if(this.controls[H].CLASS_NAME=="OpenLayers.Control.IAAA_NavigationHistory"){this.controls[H].deactivate();b=this.controls[H];continue}}}var F=false;if(this.getControlsByClass("OpenLayers.Control.IAAA_GoogleLayerSelector").length>0){var D=this.getControlsByClass("OpenLayers.Control.IAAA_GoogleLayerSelector")[0];var y=(this.getControlsByClass("OpenLayers.Control.DragPan")&&(this.getControlsByClass("OpenLayers.Control.DragPan").length>0))?(this.getControlsByClass("OpenLayers.Control.DragPan")[0]):null;var p=(this.getControlsByClass("OpenLayers.Control.IAAA_DragPan")&&(this.getControlsByClass("OpenLayers.Control.IAAA_DragPan").length>0))?(this.getControlsByClass("OpenLayers.Control.IAAA_DragPan")[0]):null;var m=(y)?y:((p)?p:null);if(D&&D.additionalLayer&&D.additionalLayer.getVisibility()&&m&&m.handler&&!(m.handler.dragging)){D.additionalLayer.setVisibility(false);F=true}}if(this.viewControls.length>0){var h=this.getViewControlActive();var y=(this.getControlsByClass("OpenLayers.Control.DragPan")&&(this.getControlsByClass("OpenLayers.Control.DragPan").length>0))?(this.getControlsByClass("OpenLayers.Control.DragPan")[0]):null;var p=(this.getControlsByClass("OpenLayers.Control.IAAA_DragPan")&&(this.getControlsByClass("OpenLayers.Control.IAAA_DragPan").length>0))?(this.getControlsByClass("OpenLayers.Control.IAAA_DragPan")[0]):null;var m=(y)?y:((p)?p:null);if(h){h.hideConstrainedAdditionalLayers((m&&m.handler&&!(m.handler.dragging)))}}if((navigator.appName=="Microsoft Internet Explorer")&&(this.div.style.display=="none")){if(!this.fullHeight&&!this.fullWidth){this.size.w=this.div.style.width;this.size.h=this.div.style.height}else{this.size=this.getCurrentSize();if(!this.fullHeight){this.size.h=this.div.style.height}if(!this.fullWidth){this.size.w=this.div.style.width}}if(this.useWCTS&&K){this.zoom=N;this.resolution=this.getResolutionForZoom(N);this.center=f.clone()}else{this.panTween&&this.panTween.stop();this.moveTo(f,G,{dragging:c,forceZoomChange:g,caller:"setCenter",noEvent:true})}}else{if(this.useWCTS&&K){this.zoom=N;this.resolution=this.getResolutionForZoom(N);this.center=f.clone()}else{OpenLayers.Map.prototype.setCenter.apply(this,newArguments)}}if(O){if(this.resAux!=null){var q=this.resAux;this.resAux=null;this.zoomToScale(q);if(J!=null){this.zoomTo(this.getZoom()+J)}}}if(b){b.activate()}var C=false;if(this.automaticSrs&&this.baseLayer){var z=this.baseLayer.scales[this.getZoom()];var l=this.getAutomaticSrs(z);if(l!=this.getProjection()){this.changeSrs(l);C=true}}this.events.triggerEvent("newExtent");for(var I=0,w=this.controls.length;I<w;I++){if(this.controls[I].CLASS_NAME=="OpenLayers.Control.IAAA_ToolBar"){if(this.controls[I].analysisMenu!=null){this.controls[I].events.triggerEvent("newExtent")}}else{if((this.controls[I].CLASS_NAME=="OpenLayers.Control.IAAA_AspectAnalyzer")||(this.controls[I].CLASS_NAME=="OpenLayers.Control.IAAA_GradientAnalyzer")||(this.controls[I].CLASS_NAME=="OpenLayers.Control.IAAA_HeightAnalyzer")){this.controls[I].events.triggerEvent("newExtent");if(C){this.controls[I].events.triggerEvent("newSrs")}}else{if(this.controls[I].CLASS_NAME=="OpenLayers.Control.IAAA_TerritorialAnalyzer"){this.controls[I].events.triggerEvent("newExtent")}else{if(this.controls[I].CLASS_NAME=="OpenLayers.Control.IAAA_BufferOperation"){if(C){this.controls[I].events.triggerEvent("newSrs")}}else{if(this.controls[I].CLASS_NAME=="OpenLayers.Control.IAAA_AreaSelectorByUserZone"){if(C){this.controls[I].events.triggerEvent("newSrs")}}}}}}}for(var I=0,d=this.layers.length;I<d;I++){if((this.layers[I].CLASS_NAME=="OpenLayers.Layer.IAAA_Vector_PLZ")&&(this.layers[I].features)){for(var t=0,n=this.layers[I].features.length;t<n;t++){var A=this.layers[I].features[t];if(A.geometry.CLASS_NAME=="OpenLayers.Geometry.Point"){if(this.layers[I].defineIconStyle){this.layers[I].defineIconStyle(A,null)}}else{if(!A.style||(A.style=={})){A.style=OpenLayers.Feature.Vector.style["default"]}this.layers[I].drawFeature(A,this.layers[I].defaultStyle);if(this.layers[I].defineGeometryStyle){this.layers[I].defineGeometryStyle(A)}}}}}var x=this.getControlsByClass("OpenLayers.Control.IAAA_ModifyFeature_PLZ");var v=null;if(x.length>0){v=x[0];if(v.feature!=null){v.resetVertices()}}if(this.getControlsByClass("OpenLayers.Control.IAAA_GoogleLayerSelector").length>0){var D=this.getControlsByClass("OpenLayers.Control.IAAA_GoogleLayerSelector")[0];var B=this.getLayerIndex(D.additionalLayer);if(D&&D.additionalLayer&&catastroMapServerLayersList){var r=OpenLayers.Util.indexOf(this.getLayersByName(mapServersTitlesList[0])[0].resolutions,this.getLayersByName(mapServersTitlesList[0])[0].getResolution());if(catastroMapServerLayersList[r]){D.additionalLayer.params.LAYERS=catastroMapServerLayersList[r];if(F){D.additionalLayer.setVisibility(true);F=false}}else{D.additionalLayer.params.LAYERS=catastroMapServerLayersListDefault;if(F){D.additionalLayer.setVisibility(true);F=false}}}if(D&&D.additionalLayer&&D.additionalLayerScaleLimit&&D.additionalLayerButtonDisabledImg){if(this.getActualScale()>D.additionalLayerScaleLimit){OpenLayers.Util.modifyAlphaImageDiv(D.additionalLayerButton,null,null,null,D.additionalLayerButtonDisabledImg);D.additionalLayer.setVisibility(false);if(this.layerVisibilityInResizeMethod&&this.layerVisibilityInResizeMethod[B]){this.layerVisibilityInResizeMethod[B]=false}}else{if(this.resizing){if(this.layerVisibilityInResizeMethod[B]==true){OpenLayers.Util.modifyAlphaImageDiv(D.additionalLayerButton,null,null,null,D.additionalLayerButtonSelectedImg)}else{OpenLayers.Util.modifyAlphaImageDiv(D.additionalLayerButton,null,null,null,D.additionalLayerButtonStableImg)}}else{if(D.additionalLayer.getVisibility()==true){OpenLayers.Util.modifyAlphaImageDiv(D.additionalLayerButton,null,null,null,D.additionalLayerButtonSelectedImg)}else{OpenLayers.Util.modifyAlphaImageDiv(D.additionalLayerButton,null,null,null,D.additionalLayerButtonStableImg)}}}}}if(this.viewControls.length>0){var h=this.getViewControlActive();if(h){h.changeExtentRestriction();h.checkAdditionalLayerConstraints()}}this.alreadyInSetCenter--;if(this.alreadyInSetCenter==0){if(this.indexSLDList.length>0){for(I=0,indexSLDLen=this.indexSLDList.length;I<indexSLDLen;I++){this.layers[this.indexSLDList[I]].visibility=true}this.hasSLD=true;if(!this.dragInMotion&&(!this.isLoading())){for(var I=0,s=this.layers.length;I<s;I++){if(this.layers[I].CLASS_NAME=="OpenLayers.Layer.IAAA_ServerSLD"){var u=this.layers[I].getVisibility();this.layers[I].display(u);this.layers[I].setVisibility(false);this.layers[I].setVisibility(u)}}}}else{this.hasSLD=false}}};OpenLayers.Layer.prototype.getZoomForExtent=function(b,c){var d=this.map.getSize();if(!d||(d&&(isNaN(d.w)||isNaN(d.h)))){d=this.map.getCurrentSize()}var a=Math.max(b.getWidth()/d.w,b.getHeight()/d.h);return this.getZoomForResolution(a,c)};OpenLayers.Map.IAAA_Map.prototype.resize=function(b,m,z){z=((z!=null)&&(z!=undefined))?z:false;this.resizing=true;var G=this.getWindowSizeForMinMapSize().w;var A=this.getWindowSizeForMinMapSize().h;var y=this.size;var v=((y)?y.w:0);var a=this.getCurrentSize();factorX=b/G;factorY=m/A;var x=this.getExtent();var B=(navigator.appName=="Microsoft Internet Explorer")?12:6;if(!this.fullWidth){if(factorX>=1){if((this.getMaxWidth()!=null)&&((this.getMinWidth()*factorX)>this.getMaxWidth())){this.div.style.width=this.getMaxWidth()-B+"px"}else{this.div.style.width=parseInt(this.getMinWidth()*factorX)-B+"px"}}else{this.div.style.width=this.getMinWidth()-B+"px"}}else{var F=getStyle("map",(((navigator.appName!="Microsoft Internet Explorer")&&(navigator.appName!="Opera"))?"padding-left":"paddingLeft"));F=(F?parseInt(F):"0");if(isNaN(F)){F=0}this.div.style.width="";var r;if((navigator.appName!="Microsoft Internet Explorer")&&(navigator.appName!="Opera")){r=parseInt(getStyle("map","width"));F+=F}else{r=parseInt(this.div.offsetWidth);var H=null;var h=null;if(navigator.appName=="Microsoft Internet Explorer"){H=navigator.appVersion.split("MSIE");h=parseFloat(H[1])}if((navigator.appName=="Opera")||((h!=null)&&(h>=9))){F+=F+F}}if((this.getMaxWidth()!=null)&&(r>this.getMaxWidth())){r=this.getMaxWidth()}else{if((this.getMinWidth()!=null)&&(r<this.getMinWidth())){r=this.getMinWidth()}}this.div.style.width=(r-F)+"px"}if(!this.fullHeight){if(factorY>=1){if((this.getMaxHeight()!=null)&&((this.getMinHeight()*factorY)>this.getMaxHeight())){this.div.style.height=(this.getMaxHeight()-B)-this.notMapHeight+"px"}else{this.div.style.height=(parseInt(this.getMinHeight()*factorY)-B)-this.notMapHeight+"px"}}else{this.div.style.height=this.getMinHeight()-B+"px"}}else{var w=getStyle("map",(((navigator.appName!="Microsoft Internet Explorer")&&(navigator.appName!="Opera"))?"padding-top":"paddingTop"));w=(w?parseInt(w):"0");if(isNaN(w)){w=0}this.div.style.height="";var C;if((navigator.appName!="Microsoft Internet Explorer")&&(navigator.appName!="Opera")){C=parseInt(getStyle("map","height"));w+=w}else{C=parseInt(this.div.offsetHeight);var H=null;var h=null;if(navigator.appName=="Microsoft Internet Explorer"){H=navigator.appVersion.split("MSIE");h=parseFloat(H[1])}if((navigator.appName=="Opera")||((h!=null)&&(h>=9))){w+=w+w}}if((this.getMaxHeight()!=null)&&(C>this.getMaxHeight())){C=this.getMaxHeight()}else{if((this.getMinHeight()!=null)&&(C<this.getMinHeight())){C=this.getMinHeight()}}this.div.style.height=(C-w)+"px"}this.size=new OpenLayers.Size(this.div.style.width,this.div.style.height);if(!z){this.layerVisibilityInResizeMethod=[];for(var E in this.layers){this.layerVisibilityInResizeMethod[this.layerVisibilityInResizeMethod.length]=this.layers[E].getVisibility();this.layers[E].processingResize=true;this.layers[E].setVisibility(false);if(((this.layers[E].CLASS_NAME=="OpenLayers.Layer.Grid")||(this.layers[E].CLASS_NAME=="OpenLayers.Layer.WMS")||(this.layers[E].CLASS_NAME=="OpenLayers.Layer.IAAA_WMS")||(this.layers[E].CLASS_NAME=="OpenLayers.Layer.IAAA_IconsWMS")||(this.layers[E].CLASS_NAME=="OpenLayers.Layer.IAAA_Server")||(this.layers[E].CLASS_NAME=="OpenLayers.Layer.IAAA_ServerSLD")||(this.layers[E].CLASS_NAME=="OpenLayers.Layer.IAAA_ServerWMTS")||(this.layers[E].CLASS_NAME=="OpenLayers.Layer.IAAA_ServerWFS"))&&this.layers[E].singleTile){this.layers[E].onMapResize()}}}var J=document.getElementById("fondo_img");if(J){var q=v-J.width;var l=(navigator.appName=="Microsoft Internet Explorer")?6:0;if(this.div.style.width.split("px").length==0){J.width=(this.div.style.width-q)-l}else{J.width=this.div.style.width.split("px")[0]-q-l}}if(!z){if(this.baseLayer&&(this.baseLayer.CLASS_NAME!="OpenLayers.Layer.Google")&&(this.baseLayer.CLASS_NAME!="OpenLayers.Layer.IAAA_Google")&&x){this.zoomToExtent(x,true)}var D=0;for(var E in this.layers){this.layers[E].processingResize=false;this.layers[E].setVisibility(this.layerVisibilityInResizeMethod[D]);D++}if(this.baseLayer&&((this.baseLayer.CLASS_NAME=="OpenLayers.Layer.Google")||(this.baseLayer.CLASS_NAME=="OpenLayers.Layer.IAAA_Google"))){if(x){this.zoomToExtent(x,true);if(this.baseLayer.numZoomLevels<=this.getZoom()){this.zoomTo(this.baseLayer.numZoomLevels-1)}}var d=false;var g=this.getControlsByClass("OpenLayers.Control.IAAA_GoogleLayerSelector");var o=this.getControlsByClass("OpenLayers.Control.IAAA_GoogleViewSelector");var p=null;if((g&&g[0]&&g[0].active)){p=g[0]}else{if((o&&o[0]&&o[0].active)){p=o[0]}}var n=false;if(p&&p.streetViewLayerVisible()){p.setStreetViewLayerVisibility(false);p.streetViewControl.deactivate();n=true}if(this.baseLayer.reset){if(this.baseLayer.setGoogleCenterToUpdate){this.baseLayer.setGoogleCenterToUpdate()}this.baseLayer.reset()}else{var f=parseInt(this.baseLayer.version);if(f==2){delete this.baseLayer.mapObject;this.baseLayer.mapObject=null;this.baseLayer.removeBrandingDivs();delete OpenLayers.Layer.Google.cache[this.id];OpenLayers.Layer.Google.cache[this.id]=null;try{if(this.baseLayer.div.childNodes.length>0){this.baseLayer.div.removeChild(this.baseLayer.div.firstChild)}while(this.baseLayer.pane.childNodes.length>0){this.baseLayer.pane.removeChild(this.baseLayer.pane.firstChild)}this.viewPortDiv.removeChild(document.getElementById(this.id+"_GMap2Container"))}catch(I){OpenLayers.IAAA_Utils.report("error","[ERROR] Resizing Map\n"+I)}this.baseLayer.loadMapObject();this.baseLayer.redraw();if(this.baseLayer.setMapType){this.baseLayer.setMapType()}else{if(OpenLayers.Util.indexOf(this.baseLayer.mapObject.getMapTypes(),this.baseLayer.type)==-1){this.baseLayer.mapObject.addMapType(this.baseLayer.type)}this.baseLayer.mapObject.setMapType(this.baseLayer.type)}}else{if(this.baseLayer.setGoogleCenterToUpdate){this.baseLayer.setGoogleCenterToUpdate()}try{this.baseLayer.removeGMapElements();if(this.baseLayer.repositionListener){google.maps.event.removeListener(this.baseLayer.repositionListener);this.baseLayer.repositionListener=null}}catch(I){OpenLayers.IAAA_Utils.report("error","[ERROR] Resizing Map\n"+I)}delete this.baseLayer.mapObject;this.baseLayer.mapObject=null;delete OpenLayers.Layer.Google.cache[this.baseLayer.map.id];var c;var u=OpenLayers.Layer.Google.cache[this.baseLayer.map.id];var s=this.baseLayer.map.viewPortDiv;var t=document.createElement("div");t.id=this.baseLayer.map.id+"_GMapContainer";t.style.position="absolute";t.style.width="100%";t.style.height="100%";s.appendChild(t);center=this.baseLayer.map.getCenter();c=new google.maps.Map(t,{center:center?new google.maps.LatLng(center.lat,center.lon):new google.maps.LatLng(0,0),zoom:this.baseLayer.map.getZoom()||0,mapTypeId:this.baseLayer.type,disableDefaultUI:true,keyboardShortcuts:false,draggable:false,disableDoubleClickZoom:true,scrollwheel:false,streetViewControl:false});u={mapObject:c,count:1};OpenLayers.Layer.Google.cache[this.baseLayer.map.id]=u;this.baseLayer.mapObject=c;this.baseLayer.redraw();if(this.baseLayer.setMapType){this.baseLayer.setMapType()}else{if(OpenLayers.IAAA_Utils.isGoogleMapTypeAvailable(f,this.baseLayer.mapObject,this.baseLayer.type)){this.baseLayer.type=google.maps.MapTypeId.ROADMAP}this.baseLayer.mapObject.setMapTypeId(this.baseLayer.type)}if(this.baseLayer.repositionMapElements){this.baseLayer.updateMapObjectCenter=true;this.baseLayer.forceReposition=true;this.baseLayer.repositionMapElements()}this.baseLayer.setGMapVisibility(this.baseLayer.visibility)}}if(n){p.setStreetViewLayerVisibility(true);p.streetViewControl.activate();n=false}}for(var E in this.layers){if((this.layers[E].CLASS_NAME=="OpenLayers.Layer.IAAA_WMS")||(this.layers[E].CLASS_NAME=="OpenLayers.Layer.IAAA_IconsWMS")||(this.layers[E].CLASS_NAME=="OpenLayers.Layer.IAAA_JSON")||(this.layers[E].CLASS_NAME=="OpenLayers.Layer.IAAA_Markers")||(this.layers[E].CLASS_NAME=="OpenLayers.Layer.Markers")){this.layers[E].redraw()}else{if((this.layers[E].CLASS_NAME=="OpenLayers.Layer.Vector")||(this.layers[E].CLASS_NAME=="OpenLayers.Layer.IAAA_Vector_PLZ")||(this.layers[E].CLASS_NAME=="OpenLayers.Layer.IAAA_GenericVector")||(this.layers[E].CLASS_NAME=="OpenLayers.Layer.IAAA_GenericVectorWithTolerance")||(this.layers[E].CLASS_NAME=="OpenLayers.Layer.IAAA_VectorGenericPopups")||(this.layers[E].CLASS_NAME=="OpenLayers.Layer.Vector.RootContainer")){this.layers[E].setMap(this);this.layers[E].redraw();if((this.layers[E].CLASS_NAME=="OpenLayers.Layer.IAAA_Vector_PLZ")&&(this.layers[E].features)){for(var K in this.layers[E].features){var k=this.layers[E].features[K];if(k.geometry.CLASS_NAME=="OpenLayers.Geometry.Point"){if(this.layers[E].defineIconStyle){this.layers[E].defineIconStyle(k,null)}}else{k.style=OpenLayers.Feature.Vector.style["default"];this.layers[E].drawFeature(k,this.layers[E].defaultStyle);if(this.layers[E].defineGeometryStyle){this.layers[E].defineGeometryStyle(k)}}}}}}}this.resizeDrawFeatureLayers()}if(this._incompatibleMapServerDialog){this._incompatibleMapServerDialog.style.top=(m/2)-100;this._incompatibleMapServerDialog.style.left=(b/2)-175}if(this._serviceOutOfScopeDialog){this._serviceOutOfScopeDialog.style.top=(m/2)-100;this._serviceOutOfScopeDialog.style.left=(b/2)-275}this.resizing=false;this.events.triggerEvent("resizeend")};function getStyle(c,b){var a=document.getElementById(c);var f;try{if(a.currentStyle&&(navigator.appCodeName!="Mozilla")){f=a.currentStyle[b]}else{if(window.getComputedStyle){f=document.defaultView.getComputedStyle(a,null).getPropertyValue(b)}}return f}catch(d){return null}}OpenLayers.Popup.IAAA_FramedCloud.prototype.getSafeContentSize=function(q){var f=q.clone();var o=this.getContentDivPadding();var p=0;var m=0;if(o){p=(o.left?o.left:0)+(o.right?o.right:0);m=(o.top?o.top:0)+(o.bottom?o.bottom:0)}this.fixPadding();p+=((this.padding&&this.padding.left)?this.padding.left:0)+((this.padding&&this.padding.right)?this.padding.right:0);m+=((this.padding&&this.padding.top)?this.padding.top:0)+((this.padding&&this.padding.bottom)?this.padding.bottom:0);if(this.closeDiv){var c=parseInt(this.closeDiv.style.width);p+=c+o.right}if(this.minSize){f.w=Math.max(f.w,(this.minSize.w-p));f.h=Math.max(f.h,(this.minSize.h-m))}if(this.maxSize){if(this.maxSize.w!=0){f.w=Math.min(f.w,(this.maxSize.w-p))}if(this.maxSize.h!=0){f.h=Math.min(f.h,(this.maxSize.h-m))}}if(this.map&&this.map.size){var k=0,g=0;if(this.keepInMap&&!this.panMapIfOutOfView){var n=this.map.getPixelFromLonLat(this.lonlat);switch(this.relativePosition){case"tr":k=n.x;g=this.map.size.h-n.y;break;case"tl":k=this.map.size.w-n.x;g=this.map.size.h-n.y;break;case"bl":k=this.map.size.w-n.x;g=n.y;break;case"br":k=n.x;g=n.y;break;default:k=n.x;g=this.map.size.h-n.y;break}}var i=this.map.size;var d;if((typeof this.map.size.h).toLowerCase()=="string"){d=parseInt(i.h.substring(0,(i.h.indexOf("px"))))}else{d=i.h}var h;if((typeof this.map.size.w).toLowerCase()=="string"){h=parseInt(i.w.substring(0,(i.w.indexOf("px"))))}else{h=i.w}try{if(this.map.screenPopupLimit){if(this.map.screenPopupLimit.h){d=parseInt(Math.floor(d*this.map.screenPopupLimit.h))}if(this.map.screenPopupLimit.w){h=parseInt(Math.floor(h*this.map.screenPopupLimit.w))}}}catch(l){}var a=d-this.map.paddingForPopups.top-this.map.paddingForPopups.bottom-m-g;var b=h-this.map.paddingForPopups.left-this.map.paddingForPopups.right-p-k;f.w=Math.min(f.w,b);f.h=Math.min(f.h,a)}return f};OpenLayers.Control.IAAA_LoadingMap.prototype.setMap=function(c){OpenLayers.Control.prototype.setMap.apply(this,arguments);this.generateLoadingDiv();for(var a in this.map.layers){var b={layer:this.map.layers[a]};this.generateLoadingVector(b)}this.map.events.register("addlayer",this,this.generateLoadingVector);this.map.events.register("removelayer",this,this.removeLayerHandler);this.map.events.register("resizeend",this,this.readjustLoadingDiv);if(mobileNavigator){this.map.events.register("mapsizeupdated",this,this.readjustLoadingDiv)}};OpenLayers.Control.IAAA_LoadingMap.prototype.generateLoadingVector=function(b){if((b)&&(b.layer)){var a=b.layer;if(((a.CLASS_NAME=="OpenLayers.Layer.IAAA_Server")||(a.CLASS_NAME=="OpenLayers.Layer.IAAA_ServerSLD"))&&(a.showLoadingIcon)&&(!this.layersLoaded["IAAA_Server_"+a.name+"_"+a.url])){a.events.register("tileloaded",this,this.layerLoadedHandler);a.events.register("tileunload",this,this.layerLoadedHandler);a.events.register("loadstart",this,this.layerLoadingHandler);a.events.register("visibilitychanged",this,function(c){if(!c.object.getVisibility()){if(!c.object.processingResize){this.layerLoadedHandler(c)}}});a.events.register("urlchanged",this,this.changeUrlWMS);a.events.register("titlechanged",this,this.changeTitleWMS);if((this.numLoadingTiles==0)||(!a.getVisibility())){this.layersLoaded["IAAA_Server_"+a.name+"_"+a.url]=true}else{this.layersLoaded["IAAA_Server_"+a.name+"_"+a.url]=false;this.showLoadingDiv(a)}}else{if((a.CLASS_NAME=="OpenLayers.Layer.IAAA_ServerWFS")&&(a.showLoadingIcon)&&(!this.layersLoaded["IAAA_ServerWFS_"+a.name+"_"+a.url])){a.events.register("tileloaded",this,this.layerLoadedHandler);a.events.register("tileunload",this,this.layerLoadedHandler);a.events.register("loadstart",this,this.layerLoadingHandler);a.events.register("visibilitychanged",this,function(c){if(!c.object.getVisibility()){if(!c.object.processingResize){this.layerLoadedHandler(c)}}});a.events.register("urlchanged",this,this.changeUrlWMS);a.events.register("titlechanged",this,this.changeTitleWMS);if((this.numLoadingTiles==0)||(!a.getVisibility())){this.layersLoaded["IAAA_ServerWFS_"+a.name+"_"+a.url]=true}else{this.layersLoaded["IAAA_ServerWFS_"+a.name+"_"+a.url]=false;this.showLoadingDiv(a)}}else{if((a.CLASS_NAME=="OpenLayers.Layer.IAAA_ServerWMTS")&&(a.showLoadingIcon)&&(!this.layersLoaded["IAAA_ServerWMTS_"+a.name+"_"+a.url])){a.events.register("tileloaded",this,this.layerLoadedHandler);a.events.register("tileunload",this,this.layerLoadedHandler);a.events.register("loadstart",this,this.layerLoadingHandler);a.events.register("visibilitychanged",this,function(c){if(!c.object.getVisibility()){if(!c.object.processingResize){this.layerLoadedHandler(c)}}});a.events.register("urlchanged",this,this.changeUrlWMS);a.events.register("titlechanged",this,this.changeTitleWMS);if((this.numLoadingTiles==0)||(!a.getVisibility())){this.layersLoaded["IAAA_ServerWMTS_"+a.name+"_"+a.url]=true}else{this.layersLoaded["IAAA_ServerWMTS_"+a.name+"_"+a.url]=false;this.showLoadingDiv(a)}}else{if(((a.CLASS_NAME=="OpenLayers.Layer.WMS")||(a.CLASS_NAME=="OpenLayers.Layer.IAAA_WMS"))&&(a.showLoadingIcon)&&(!this.layersLoaded["IAAA_WMS_"+a.name+"_"+a.url])){a.events.register("loadend",this,this.layerLoadedHandler);a.events.register("loadcancel",this,this.layerLoadedHandler);a.events.register("loadstart",this,this.layerLoadingHandler);a.events.register("visibilitychanged",this,function(c){if(!c.object.getVisibility()){if(!c.object.processingResize){if(c.object.useRequestSequencing){c.seq=-1}this.layerLoadedHandler(c)}}else{if(this.showLoadingDivOnVisibilityChange){if(!c.object.processingResize){this.layerLoadedHandler(c)}}}});if(a.useRequestSequencing){this.waitingSeq["IAAA_WMS_"+a.name+"_"+a.url]=null}if((this.numLoadingTiles==0)||(!a.getVisibility())){this.layersLoaded["IAAA_WMS_"+a.name+"_"+a.url]=true}else{this.layersLoaded["IAAA_WMS_"+a.name+"_"+a.url]=false;this.showLoadingDiv(a)}}else{if((a.CLASS_NAME=="OpenLayers.Layer.IAAA_GML")&&(a.showLoadingIcon)&&(!this.layersLoaded["IAAA_GML_"+a.location+"_"+a.name])){a.events.register("loadend",this,this.layerLoadedHandler);a.events.register("loadstart",this,this.layerLoadingHandler);a.events.register("visibilitychanged",this,function(c){if(!c.object.getVisibility()){if(!c.object.processingResize){this.layerLoadedHandler(c)}}});if(a.loaded){this.layersLoaded["IAAA_GML_"+a.name+"_"+a.url]=true}else{this.layersLoaded["IAAA_GML_"+a.name+"_"+a.url]=false;if(this.timeOutBehavior){window.clearTimeout(this.timeOutRef);if(this.errorMessage){this.timeOutRef=window.setTimeout('OpenLayers.Control.IAAA_LoadingMap.timeOut("'+this.uniqueId+'", "'+this.errorMessage+'");',this.waitingTime)}else{this.timeOutRef=window.setTimeout('OpenLayers.Control.IAAA_LoadingMap.timeOut("'+this.uniqueId+'");',this.waitingTime)}}this.showLoadingDiv(a)}}else{if((a.CLASS_NAME=="OpenLayers.Layer.IAAA_GenericVector")&&(a.showLoadingIcon)&&(!this.layersLoaded["IAAA_GenericVector_"+a.name])){a.events.register("loadend",this,this.layerLoadedHandler);a.events.register("loadstart",this,this.layerLoadingHandler);a.events.register("visibilitychanged",this,function(c){if(!c.object.getVisibility()){if(!c.object.processingResize){this.layerLoadedHandler(c)}}});if(a.loaded){this.layersLoaded["IAAA_GenericVector_"+a.name]=true}else{if((a.showLoadingOnDrawOnce==null)||(a.showLoadingOnDrawOnce==undefined)||(a.showLoadingOnDrawOnce==false)){this.layersLoaded["IAAA_GenericVector_"+a.name]=false;if(this.timeOutBehavior){window.clearTimeout(this.timeOutRef);if(this.errorMessage){this.timeOutRef=window.setTimeout('OpenLayers.Control.IAAA_LoadingMap.timeOut("'+this.uniqueId+'", "'+this.errorMessage+'");',this.waitingTime)}else{this.timeOutRef=window.setTimeout('OpenLayers.Control.IAAA_LoadingMap.timeOut("'+this.uniqueId+'");',this.waitingTime)}}this.showLoadingDiv(a)}else{this.layersLoaded["IAAA_GenericVector_"+a.name]=true}}}else{if((a.CLASS_NAME=="OpenLayers.Layer.IAAA_GenericVectorWithTolerance")&&(a.showLoadingIcon)&&(!this.layersLoaded["IAAA_GenericVectorWithTolerance_"+a.name])){a.events.register("loadend",this,this.layerLoadedHandler);a.events.register("loadstart",this,this.layerLoadingHandler);a.events.register("visibilitychanged",this,function(c){if(!c.object.getVisibility()){if(!c.object.processingResize){this.layerLoadedHandler(c)}}});if(a.loaded){this.layersLoaded["IAAA_GenericVectorWithTolerance_"+a.name]=true}else{this.layersLoaded["IAAA_GenericVectorWithTolerance_"+a.name]=false;if(this.timeOutBehavior){window.clearTimeout(this.timeOutRef);if(this.errorMessage){this.timeOutRef=window.setTimeout('OpenLayers.Control.IAAA_LoadingMap.timeOut("'+this.uniqueId+'", "'+this.errorMessage+'");',this.waitingTime)}else{this.timeOutRef=window.setTimeout('OpenLayers.Control.IAAA_LoadingMap.timeOut("'+this.uniqueId+'");',this.waitingTime)}}this.showLoadingDiv(a)}}else{if((a.CLASS_NAME=="OpenLayers.Layer.IAAA_IconsWMS")&&(a.showLoadingIcon)&&(!this.layersLoaded["SaveImageWMS_"+a.name+"_"+a.url])){this.layersLoaded["SaveImageWMS_"+a.name+"_"+a.url]=true;a.events.register("loadend",this,this.layerLoadedHandler);a.events.register("loadstart",this,this.layerLoadingHandler);a.events.register("visibilitychanged",this,function(c){if(!c.object.getVisibility()){if(!c.object.processingResize){this.layerLoadedHandler(c)}}})}else{if((a.CLASS_NAME=="OpenLayers.Layer.IAAA_GeoRSS")&&(a.showLoadingIcon)&&(!this.layersLoaded["IAAA_GeoRSS_"+a.id])){this.layersLoaded["IAAA_GeoRSS_"+a.id]=true;a.events.register("loadend",this,this.layerLoadedHandler);a.events.register("loadstart",this,this.layerLoadingHandler);a.events.register("visibilitychanged",this,function(c){if(!c.object.getVisibility()){if(!c.object.processingResize){this.layerLoadedHandler(c)}}})}else{if((a.CLASS_NAME=="OpenLayers.Layer.IAAA_TooltipMarkers")&&(a.showLoadingIcon)&&(!this.layersLoaded["TooltipMarkersLayer_"+a.serviceUrl+"_"+a.name])){this.layersLoaded["TooltipMarkersLayer_"+a.serviceUrl+"_"+a.name]=true;a.events.register("loadend",this,this.layerLoadedHandler);a.events.register("loadstart",this,this.layerLoadingHandler);a.events.register("visibilitychanged",this,function(c){if(!c.object.getVisibility()){if(!c.object.processingResize){this.layerLoadedHandler(c)}}})}}}}}}}}}}}};OpenLayers.Control.IAAA_LoadingMap.prototype.readjustLoadingDiv=function(c){var f=0;var d=0;var b=this.loadingDiv;try{this.loadingDiv.style.left=f+((this.map.getSize().w/2)-this.horizontalOffset)+"px";this.loadingDiv.style.top=d+((this.map.getSize().h/2)-this.verticalOffset)+"px"}catch(a){this.loadingDiv.style.left=(f-this.horizontalOffset)+"px";this.loadingDiv.style.top=(d-this.verticalOffset)+"px"}};function localFacade(map,options){this.map=map;this.router=(options?options.router:null);this.centrarMapa=centrarMapa;this.definirCapas=definirCapas;this.actualizarVisibilidad=actualizarVisibilidad;this.actualizarVisibilidadTrafico=actualizarVisibilidadTrafico;this.definirTiempoRefrescoTrafico=definirTiempoRefrescoTrafico;this.destruirMapa=destruirMapa;this.geolocalizarUsuario=geolocalizarUsuario;this.eliminarUsuario=eliminarUsuario;this.eliminarCalle=eliminarCalle;this.georreferenciarCalle=georreferenciarCalle;this.georreferenciarCalleSemantica=georreferenciarCalleSemantica;this.georreferenciarElemento=georreferenciarElemento;this.borrarElementosGeorreferenciados=borrarElementosGeorreferenciados;this.calcularRuta=calcularRuta;this.borrarRutas=borrarRutas;this.transformarCoordenadas=transformarCoordenadas;this._actualizarInformacionSemantica=_actualizarInformacionSemantica;this._updateResultSemanticContent=_updateResultSemanticContent;this.actualizarDimensionesMapa=actualizarDimensionesMapa;this.ocultarMapa=ocultarMapa;this.agregarElementoExterno=agregarElementoExterno;this.closeExpandedPopup=function(){};if(mobileNavigator){this.closeExpandedPopup=closeExpandedPopup}this.cargarScript=cargarScript;this.definirCapaJSON=definirCapaJSON;this.borrarCapasJSON=borrarCapasJSON;this.pintarGeoJSON=pintarGeoJSON;this.contadorCapasVisibles=0;this.capasVisibles=new Object();this.addPoiLayer=_addPoiLayer;this.refreshSelectFeatureControl=_addSelectFeatureControl;this._addRouterBehaviour=_addRouterBehaviour;this.searchResourcesOptions={};this.currentResourcesSearchParams={center:null,scope:0};this.currentResources=[];this.currentResourcesScope=null;this.buscarRecursosCercanos=buscarRecursosCercanos;this.eliminarRecursosCercanos=eliminarRecursosCercanos;this._addSearchNearbyResourcesBehaviour=_addSearchNearbyResourcesBehaviour;this._changeModifyFeatureBehaviour=_changeModifyFeatureBehaviour;this._procesarRecursos=_procesarRecursos;OpenLayers.Element.visible=function(element){if(OpenLayers.Util.getElement(element)&&OpenLayers.Util.getElement(element).style&&OpenLayers.Util.getElement(element).style.display){return(OpenLayers.Util.getElement(element).style.display!="none")}return false};OpenLayers.Element.toggle=function(){for(var i=0,len=arguments.length;i<len;i++){var element=OpenLayers.Util.getElement(arguments[i]);if(element){var display=OpenLayers.Element.visible(element)?"hide":"show";OpenLayers.Element[display](element)}}};OpenLayers.Element.remove=function(element){element=OpenLayers.Util.getElement(element);if(element&&element.parentNode){element.parentNode.removeChild(element)}};OpenLayers.Element.getHeight=function(element){element=OpenLayers.Util.getElement(element);if(element){return element.offsetHeight}return 0},OpenLayers.Element.getDimensions=function(element){element=OpenLayers.Util.getElement(element);if(element){if(OpenLayers.Element.getStyle(element,"display")!="none"){return{width:element.offsetWidth,height:element.offsetHeight}}var els=element.style;var originalVisibility=els.visibility;var originalPosition=els.position;var originalDisplay=els.display;els.visibility="hidden";els.position="absolute";els.display="";var originalWidth=element.clientWidth;var originalHeight=element.clientHeight;els.display=originalDisplay;els.position=originalPosition;els.visibility=originalVisibility;return{width:originalWidth,height:originalHeight}}return{width:0,height:0}},OpenLayers.Element.hasClass=function(element,name){if(element){var names=element.className;return(!!names&&new RegExp("(^|\\s)"+name+"(\\s|$)").test(names))}return false};OpenLayers.Element.removeClass=function(element,name){if(element){var names=element.className;if(names){element.className=OpenLayers.String.trim(names.replace(new RegExp("(^|\\s+)"+name+"(\\s+|$)")," "))}}return element};OpenLayers.Element.toggleClass=function(element,name){if(element){if(OpenLayers.Element.hasClass(element,name)){OpenLayers.Element.removeClass(element,name)}else{OpenLayers.Element.addClass(element,name)}}return element};function agregarElementoExterno(elemento){if(document.getElementById("map")){document.getElementById("map").appendChild(elemento)}}function cargarScript(tipo,url){if(tipo&&((typeof tipo).toLowerCase()=="string")&&url&&((typeof url).toLowerCase()=="string")){var fileref;if(tipo=="script"){fileref=document.createElement("script");fileref.setAttribute("type","text/javascript");fileref.setAttribute("src",url)}else{if(tipo=="css"){fileref=document.createElement("link");fileref.setAttribute("rel","stylesheet");fileref.setAttribute("type","text/css");fileref.setAttribute("href",url)}}if(typeof fileref!="undefined"){document.getElementsByTagName("head")[0].appendChild(fileref)}}}function actualizarDimensionesMapa(){if(this.map){this.map.updateSize(true)}}function ocultarMapa(){if(this.map&&this.map.eventsDiv){this.map.eventsDiv.style.display="none"}}function destruirMapa(){facadeVariables.mapDestroyed=true;_removeTrafficRequestTimeout();this.map.destroy();document.getElementById("container").style.visibility="hidden";document.getElementById("container").style.display="none"}function centrarMapa(xMin,yMin,xMax,yMax,srs,scale,adjustExtentToGeometries){if(this.map&&this.map.layers){var lonlat;var bbox;var reqSrs=(srs?(srs+""):mapSrs);var newSrs=this.map.getProjection();if(adjustExtentToGeometries){var left=null;var top=null;var right=null;var bottom=null;var layer;var layerExtent=null;for(var i=0,ilen=this.map.layers.length;i<ilen;i++){layer=this.map.layers[i];if(layer&&layer.visibility&&((layer.CLASS_NAME=="OpenLayers.Layer.IAAA_GenericVector")&&((layer.layerId!=null)||(layer.name==facadeVariables.capaTrafico.name))&&layer.visibility)||((layer.CLASS_NAME=="OpenLayers.Layer.Vector.RootContainer")&&(layer.features&&layer.features.length>0))){layerExtent=(((layer.originalExtent!=undefined)&&(layer.originalExtent!=null))?layer.originalExtent:layer.getDataExtent());if((layerExtent==null)||(layerExtent==undefined)){continue}if((left==null)||((left>layerExtent.left)&&(layerExtent.left>=this.map.maxExtent.left))){left=layerExtent.left}if((top==null)||((top<layerExtent.top)&&(layerExtent.top<=this.map.maxExtent.top))){top=layerExtent.top}if((right==null)||((right<layerExtent.right)&&(layerExtent.right<=this.map.maxExtent.right))){right=layerExtent.right}if((bottom==null)||((bottom>layerExtent.bottom)&&(layerExtent.bottom>=this.map.maxExtent.bottom))){bottom=layerExtent.bottom}}else{if(layer&&layer.visibility&&((layer.CLASS_NAME=="OpenLayers.Layer.Markers")||(layer.CLASS_NAME=="OpenLayers.Layer.IAAA_Markers"))){if(layer.markers&&(layer.markers.length>0)){var marker;var markerLoc;for(var j=0,jlen=layer.markers.length;j<jlen;j++){marker=layer.markers[j];if(marker&&marker.lonlat){markerLoc=marker.lonlat;if((left==null)||(left>markerLoc.lon)){left=markerLoc.lon}if((top==null)||(top<markerLoc.lat)){top=markerLoc.lat}if((right==null)||(right<markerLoc.lon)){right=markerLoc.lon}if((bottom==null)||(bottom>markerLoc.lat)){bottom=markerLoc.lat}}}}}}}if((left!=null)&&(top!=null)&&(right!=null)&&(bottom!=null)){var mapExtent=this.map.getExtent();var geomExtent=new OpenLayers.Bounds(left,bottom,right,top);var centerLonLat=geomExtent.getCenterLonLat();var zoom=this.map.getZoomForExtent(geomExtent,true);var newExtent=this.map.calculateBounds(centerLonLat,this.map.getResolutionForZoom(zoom));if((zoom>0)&&!newExtent.containsBounds(geomExtent,true)){zoom--}this.map.setCenter(centerLonLat,zoom);if(scale){this.map.zoomToScale(parseFloat(scale),true)}return}}if(xMax&&yMax&&xMin&&yMin&&reqSrs&&newSrs){bbox=new OpenLayers.IAAA_Bounds(parseFloat(xMin),parseFloat(yMin),parseFloat(xMax),parseFloat(yMax));bbox.setSrs(reqSrs);bbox.transformSrs(newSrs)}else{if(xMin&&yMin&&reqSrs&&newSrs){lonlat=new OpenLayers.LonLat(parseFloat(xMin),parseFloat(yMin));if(newSrs!=reqSrs){var punto=coordTransform(reqSrs,newSrs,lonlat.lon,lonlat.lat);lonlat.lon=punto[0];lonlat.lat=punto[1]}}}if(lonlat){this.map.setCenter(lonlat)}else{if(bbox){var centerLonLat=bbox.getCenterLonLat();var zoom=this.map.getZoomForExtent(bbox,true);var newExtent=this.map.calculateBounds(centerLonLat,this.map.getResolutionForZoom(zoom));if((zoom>0)&&!newExtent.containsBounds(bbox,true)){zoom--}this.map.setCenter(centerLonLat,zoom)}}if(scale){this.map.zoomToScale(parseFloat(scale),true)}}}function definirCapas(estructuraCapas,showTree){showTree=((showTree!=undefined)&&(showTree!=null))?showTree:true;if(showTree){var treeHeaderNode=document.getElementById("viewerTreeHeader");if(treeHeaderNode){treeHeaderNode.style.display="block"}}try{if(this.map&&this.map.controls&&this.map.layers){if(facadeVariables._poisLayers.length==0){if((estructuraCapas!=null)&&(estructuraCapas!=undefined)&&_validateJSON(estructuraCapas)){var evalEstructuraCapas=eval("("+estructuraCapas+")");var hierarchy="";_addChildList(this.map,evalEstructuraCapas.layers,hierarchy,[])}else{OpenLayers.IAAA_Utils.report("error","[ERROR]: "+messages.layerStructureJSONError)}_addSelectFeatureControl(facadeVariables._poisLayers.concat((facadeVariables.capaTrafico)?[facadeVariables.capaTrafico]:null));_addClusterStrategy()}else{OpenLayers.IAAA_Utils.report("log","[INFO]: Solo se permite una definicin de capas")}}}catch(e){}if(showTree){if(parent&&parent.getFacade&&parent.getFacade().cargarArbol){parent.getFacade().cargarArbol()}}}function definirCapaJSON(nombreCapa,json,centrarEnGeometrias){_definirCapaJSON(nombreCapa,json,centrarEnGeometrias)}function _definirCapaJSON(nombreCapa,json,centrarEnGeometrias,titulo,forzarPrioridad,opciones){var poiLayerExists=false;var poiLayer;if(this.map){for(var i=0,iLen=this.map.layers.length;i<iLen;i++){poiLayer=this.map.layers[i];if(poiLayer&&(poiLayer.CLASS_NAME=="OpenLayers.Layer.IAAA_GenericVector")&&(poiLayer.name==nombreCapa)){if(poiLayer.isLayerOnTop){_borrarCapaJSON(nombreCapa)}else{poiLayerExists=true;break}}}}if(poiLayerExists){OpenLayers.IAAA_Utils.report("error","[ERROR] Existe una capa de pois con ese mismo nombre");return}forzarPrioridad=((forzarPrioridad!=null)&&(forzarPrioridad=!undefined))?forzarPrioridad:null;facadeVariables.centerInGeometries=(((centrarEnGeometrias!=undefined)&&(centrarEnGeometrias!=null))?centrarEnGeometrias:true);facadeVariables.waitingToLoad++;var dataInfo={title:nombreCapa,definirCapaJSON:true};var textoJSON;var urlJSON="";if(json&&json.indexOf("{")==0){var jsonValid=false;try{eval("("+json+")");jsonValid=true;textoJSON=json}catch(e){}if(!jsonValid){OpenLayers.IAAA_Utils.report("error","[ERROR] Json no vlido: ");return}}else{urlJSON=json}if(urlJSON!=""){dataInfo.url=urlJSON}if(!facadeVariables.clusterStrategy){_addSelectFeatureControl(facadeVariables._poisLayers);_addClusterStrategy()}_addPoiLayer(this.map,dataInfo,urlJSON,[facadeVariables._poisLayers.length],textoJSON,forzarPrioridad,opciones);var newLayer=facadeVariables._poisLayers[facadeVariables._poisLayers.length-1];newLayer.isLayerOnTop=true;if(!facadeVariables.layersOnTopList){facadeVariables.layersOnTopList=[]}facadeVariables.layersOnTopList.push(newLayer);var selectLayers=facadeVariables._poisLayers;if(facadeVariables.capaTrafico){selectLayers=selectLayers.concat([facadeVariables.capaTrafico])}_addSelectFeatureControl(selectLayers);if(newLayer.renderer&&newLayer.renderer.CLASS_NAME=="OpenLayers.Renderer.Canvas"){if(facadeVariables&&facadeVariables.showTooltipControl&&facadeVariables.showTooltipControl.layer){newLayer.setZIndex(parseInt(facadeVariables.showTooltipControl.layer.getZIndex())+1)}}facadeVariables._poisVisibleCount++;facadeVariables._poisLayers[facadeVariables._poisLayers.length-1].setVisibility(true);facadeVariables.layerLegendInfo[nombreCapa].visibility=true;var extentToAdd=(facadeVariables._poisLayers[facadeVariables._poisLayers.length-1].originalExtent)?facadeVariables._poisLayers[facadeVariables._poisLayers.length-1].originalExtent:facadeVariables._poisLayers[facadeVariables._poisLayers.length-1].getDataExtent();if(facadeVariables.mainGeometriesExtent){if(extentToAdd&&(extentToAdd.srs!=facadeVariables.mainGeometriesExtent.srs)){extentToAdd=extentToAdd.clone().transformSrs(facadeVariables.mainGeometriesExtent.srs)}if(extentToAdd){facadeVariables.mainGeometriesExtent.extend(extentToAdd)}}else{if(extentToAdd){facadeVariables.mainGeometriesExtent=extentToAdd.clone()}}if((this.contadorCapasVisibles==undefined)||(this.contadorCapasVisibles==null)){this.contadorCapasVisibles=0}this.contadorCapasVisibles++;if(navigator.appName=="Microsoft Internet Explorer"){if(facadeVariables.layersOnTopList.length>1){for(var jindex=0,jindexLen=facadeVariables.layersOnTopList.length-1;jindex<jindexLen;jindex++){facadeVariables.layersOnTopList[jindex].redraw()}}}}function borrarCapasJSON(){if(!facadeVariables.layersOnTopList||!getMap()){return}else{var forceRecluster=false;if(facadeVariables.clusterStrategy&&facadeVariables.clusterStrategy.features){forceRecluster=true}var newPoisLayers=[];var poisLayerCounter=0;var newLegendNamesList=[];var layerName;for(var i=0,iLen=facadeVariables.layersOnTopList.length;i<iLen;i++){facadeVariables.layersOnTopList[i].setVisibility(false);facadeVariables.layersOnTopList[i].removeAllFeatures();getMap().removeLayer(facadeVariables.layersOnTopList[i]);facadeVariables._poisVisibleCount--;for(var j=poisLayerCounter,jLen=facadeVariables._poisLayers.length;j<jLen;j++){if(facadeVariables.layersOnTopList[i].name!=facadeVariables._poisLayers[j].name){newPoisLayers=newPoisLayers.concat(facadeVariables._poisLayers[j])}else{poisLayerCounter=j+1;break}}layerName=facadeVariables.layersOnTopList[i].name;delete facadeVariables.layerLegendInfo[layerName];newLegendNamesList=[];for(var z=0,zLen=facadeVariables.legendLayerNamesList.length;z<zLen;z++){if(layerName!=facadeVariables.legendLayerNamesList[z]){newLegendNamesList.push(facadeVariables.legendLayerNamesList[z])}}facadeVariables.legendLayerNamesList=newLegendNamesList}this.contadorCapasVisibles=this.contadorCapasVisibles-facadeVariables.layersOnTopList.length;facadeVariables._poisLayers=newPoisLayers;var selectLayers=facadeVariables._poisLayers;if(facadeVariables.capaTrafico){selectLayers=selectLayers.concat([facadeVariables.capaTrafico])}if(facadeVariables.showTooltipControl){facadeVariables.showTooltipControl.unselectAllFeatures()}_addSelectFeatureControl(selectLayers);if(forceRecluster){facadeVariables.clusterStrategy.cluster()}delete facadeVariables.layersOnTopList}}function pintarGeoJSON(geojson,centrarEnGeometrias){if(!facadeVariables.clusterStrategy){_addSelectFeatureControl(facadeVariables._poisLayers);_addClusterStrategy()}var layerName="geoJSONLayer";var id=[facadeVariables._poisLayers.length];var geoJSONLayer=new OpenLayers.Layer.IAAA_GenericVector(layerName,{layerId:_idToString(id),modifiable:true,visibility:true,projection:this.map.projection,additionalInfo:true,popupAnchorSize:poisClientStyle.popupAnchorSize,popupAnchorOffset:poisClientStyle.popupAnchorOffset,scaleIcon:false,showLoadingIcon:false,showLoadingOnDrawOnce:false,hierarchy:"",containsPoints:true});this.map.addLayer(geoJSONLayer);facadeVariables._poisLayers.push(geoJSONLayer);geoJSONLayer.zoomControlIndex=-1;for(var i=0,len=this.map.controls.length;i<len;i++){if(map.controls[i].CLASS_NAME=="OpenLayers.Control.IAAA_ZoomBox"){geoJSONLayer.zoomControlIndex=i;break}}var newLayer=facadeVariables._poisLayers[facadeVariables._poisLayers.length-1];newLayer.isLayerOnTop=true;if(!facadeVariables.layersOnTopList){facadeVariables.layersOnTopList=[]}facadeVariables.layersOnTopList.push(newLayer);var selectLayers=facadeVariables._poisLayers;if(facadeVariables.capaTrafico){selectLayers=selectLayers.concat([facadeVariables.capaTrafico])}_addSelectFeatureControl(selectLayers);if(newLayer.renderer&&newLayer.renderer.CLASS_NAME=="OpenLayers.Renderer.Canvas"){if(facadeVariables&&facadeVariables.showTooltipControl&&facadeVariables.showTooltipControl.layer){newLayer.setZIndex(parseInt(facadeVariables.showTooltipControl.layer.getZIndex())+1)}}facadeVariables._poisVisibleCount++;facadeVariables._poisLayers[facadeVariables._poisLayers.length-1].setVisibility(true);facadeVariables.legendLayerNamesList.push(layerName);facadeVariables.layerLegendInfo[layerName]=new Object();facadeVariables.layerLegendInfo[layerName].visibility=true;var extentToAdd=(facadeVariables._poisLayers[facadeVariables._poisLayers.length-1].originalExtent)?facadeVariables._poisLayers[facadeVariables._poisLayers.length-1].originalExtent:facadeVariables._poisLayers[facadeVariables._poisLayers.length-1].getDataExtent();if(facadeVariables.mainGeometriesExtent){if(extentToAdd&&(extentToAdd.srs!=facadeVariables.mainGeometriesExtent.srs)){extentToAdd=extentToAdd.clone().transformSrs(facadeVariables.mainGeometriesExtent.srs)}if(extentToAdd){facadeVariables.mainGeometriesExtent.extend(extentToAdd)}}else{if(extentToAdd){facadeVariables.mainGeometriesExtent=extentToAdd.clone()}}if((this.contadorCapasVisibles==undefined)||(this.contadorCapasVisibles==null)){this.contadorCapasVisibles=0}this.contadorCapasVisibles++;if(navigator.appName=="Microsoft Internet Explorer"){if(facadeVariables.layersOnTopList.length>1){for(var jindex=0,jindexLen=facadeVariables.layersOnTopList.length-1;jindex<jindexLen;jindex++){facadeVariables.layersOnTopList[jindex].redraw()}}}var parser=new OpenLayers.Format.GeoJSON();parser.parseFeature=function(){var feature=OpenLayers.Format.GeoJSON.prototype.parseFeature.apply(this,arguments);if(typeof feature.attributes.style=="object"){feature.style=feature.attributes.style}return feature};var features=parser.read(geojson);for(var i=0,len=features.length-1;i<=len;i++){var feature=features[i];feature.attributes.disableAsDestination=true}geoJSONLayer.addFeatures(features);if(centrarEnGeometrias){var dataExtent=geoJSONLayer.getDataExtent();if(dataExtent){var centerLonLat=dataExtent.getCenterLonLat();var zoom=this.map.getZoomForExtent(dataExtent);this.map.setCenter(centerLonLat,zoom)}}else{geoJSONLayer.redraw()}}function actualizarVisibilidad(indiceCapa,visibilidad,centrarEnGeometrias){try{if(this.map.layers){if((facadeVariables.actualizandoVisibilidad==undefined)||(facadeVariables.actualizandoVisibilidad==null)){facadeVariables.actualizandoVisibilidad=0}facadeVariables.actualizandoVisibilidad++;for(var i=0,l=this.map.layers.length;i<l;i++){var layer=this.map.layers[i];if((layer.CLASS_NAME=="OpenLayers.Layer.IAAA_GenericVector")&&(layer.layerId!=null)&&(layer.layerId==indiceCapa)){var childLength=((layer.getChildLayerList()!=null)&&(layer.getChildLayerList()!=undefined))?layer.getChildLayerList().length:0;if(visibilidad&&centrarEnGeometrias&&(!facadeVariables.centerInGeometries)){facadeVariables.centerInGeometries=facadeVariables.centerInGeometries||centrarEnGeometrias}if(visibilidad!=layer.getVisibility()){if(!changingVisibilityWithChilds&&(childLength>0)){changingVisibilityWithChilds=true;layerChangingVisibilityWithChilds=layer.id;if(facadeVariables.clusterStrategy){facadeVariables.clusterStrategy.ignoreClusterization=true}}if(layer.protocol.url!=null){if(!facadeVariables.loadData[layer.name]&&(!layer.alreadyLoaded)&&(childLength==0)){facadeVariables.waitingToLoad++;facadeVariables.loadData[layer.name]=true}else{if(!layer.alreadyLoaded&&(childLength==0)){try{loadingMapControl.showLoadingDiv(layer)}catch(e){try{this.map.getControlsByClass("OpenLayers.Control.IAAA_LoadingMap")[0].showLoadingDiv(layer)}catch(ex){}}}}}else{layer.containsPoints=true}if(childLength==0){if(visibilidad){facadeVariables._poisVisibleCount++}}layer.setVisibility(visibilidad);if(childLength==0){if((facade.capasVisibles==null)||(facade.capasVisibles==undefined)){facade.capasVisibles=new Object();facade.contadorCapasVisibles=0}facade.capasVisibles[layer.name]=visibilidad;if(visibilidad){facade.contadorCapasVisibles++}else{facade.contadorCapasVisibles--}if(!visibilidad){facadeVariables._poisVisibleCount--}}if((facadeVariables.layerLegendInfo[layer.hierarchy]!=undefined)&&(facadeVariables.layerLegendInfo[layer.hierarchy]!=null)){facadeVariables.layerLegendInfo[layer.hierarchy].visibility=visibilidad}_updateLayerPopups(layer);if(!visibilidad){if(layer.features){try{layer.eraseFeatures(layer.features)}catch(e){OpenLayers.IAAA_Utils.report("log","[ERROR]: Borrando features de capa a ocultar: "+layer.name)}}}for(var childIndex=0;childIndex<childLength;childIndex++){actualizarVisibilidad(layer.childLayers[childIndex].layerId,visibilidad,centrarEnGeometrias)}}else{if(visibilidad&&childLength){for(var childIndex=0;childIndex<childLength;childIndex++){if(!layer.childLayers[childIndex].visibility){actualizarVisibilidad(layer.childLayers[childIndex].layerId,visibilidad,centrarEnGeometrias)}}}}if(changingVisibilityWithChilds&&(layer.id==layerChangingVisibilityWithChilds)){changingVisibilityWithChilds=false;layerChangingVisibilityWithChilds=null;if(facadeVariables.clusterStrategy){facadeVariables.clusterStrategy.ignoreClusterization=false}if(facadeVariables.waitingToLoad==0){if((facadeVariables._poisVisibleCount==0)&&(!visibilidad)){if(facadeVariables.clusterStrategy){facadeVariables.clusterStrategy.forceClusterization=true}}if(facadeVariables.clusterStrategy){facadeVariables.clusterStrategy.cluster()}if((facadeVariables._poisVisibleCount==0)&&(!visibilidad)){if(facadeVariables.clusterStrategy){facadeVariables.clusterStrategy.forceClusterization=false}}}}facadeVariables.actualizandoVisibilidad--;if(facadeVariables.actualizandoVisibilidad==0){if((visibilidad==true)&&(facadeVariables.centerInGeometries==true)&&(facadeVariables.waitingToLoad==0)){centrarMapa(null,null,null,null,null,null,true);facadeVariables.centerInGeometries=false}if(navigator.appName=="Microsoft Internet Explorer"){if(facadeVariables&&facadeVariables.layersOnTopList&&facadeVariables.layersOnTopList.length){for(var jindex=0,jindexLen=facadeVariables.layersOnTopList.length;jindex<jindexLen;jindex++){facadeVariables.layersOnTopList[jindex].redraw()}}}}return}}facadeVariables.actualizandoVisibilidad=0;facadeVariables.centerInGeometries=false;OpenLayers.IAAA_Utils.report("log","[ERROR]: "+messages.layerIndexError)}}catch(e){OpenLayers.IAAA_Utils.report("log","[ERROR]: "+e)}}function actualizarVisibilidadTrafico(visibilidad){if(this.map&&this.map.layers&&facadeVariables.capaTrafico){if(visibilidad!=facadeVariables.capaTrafico.getVisibility()){facadeVariables.capaTrafico.loadedAndVisible=false}facadeVariables.trafficDataLoadStopped=false;var localTrafficRequestId=null;if(!visibilidad||facadeVariables.tramos){if(visibilidad&&facadeVariables.tramos&&!facadeVariables.estadoTramos){var requestManager;if(useServlet){requestManager=new OpenLayers.IAAA_Request(null,getHost()+servlet,"GET");var params={urlWFS:facadeVariables.capaTrafico.estadoTramosUrl,outputType:1,xmlRequest:false};requestManager.setRequestParams(params)}else{requestManager=new OpenLayers.IAAA_Request(null,facadeVariables.capaTrafico.estadoTramosUrl,"GET")}requestManager.events.register("loaddata",this,function(evt){if(evt&&evt.object&&evt.object.response){successTrafficStateRequest(evt.object.response)}else{failure()}});requestManager._onLoad=function(ajaxRequest){if((this.timeStampMainRequestId!=facadeVariables.currentTrafficRequest)&&(this.timeStampId!=facadeVariables.currentTrafficStateRequest)){return}if(this.responseType=="text"){this.response=ajaxRequest.responseText}else{this.response=ajaxRequest.responseXML}this.events.triggerEvent("loaddata")};requestManager._onFail=function(ajaxRequest){if((this.timeStampMainRequestId!=facadeVariables.currentTrafficRequest)&&(this.timeStampId!=facadeVariables.currentTrafficStateRequest)){return}if(this.responseType=="text"){this.response=ajaxRequest.responseText}else{this.response=ajaxRequest.responseXML}this.events.triggerEvent("faildata")};var timeStamp=new Date();facadeVariables.currentTrafficStateRequest=timeStamp.getTime();requestManager.timeStampId=facadeVariables.currentTrafficStateRequest;requestManager.timeStampMainRequestId=localTrafficRequestId;requestManager.doRequest();facadeVariables.capaTrafico.events.triggerEvent("loadstart");var successTrafficStateRequest=function(response){var parsedResp;eval("parsedResp = "+response);var stateString=parsedResp.estados;facadeVariables.estadoTramos=stateString;if(facadeVariables.tramos&&facadeVariables.estadoTramos){if(!facadeVariables.trafficDataLoadStopped){_pintaTramosTrafico();_setTrafficRequestTimeout();facadeVariables.traficoLoadedOnce=true}else{facadeVariables.capaTrafico.events.triggerEvent("loadend")}facadeVariables.trafficInitialLoad=false}}}else{if((facadeVariables.traficoLoadedOnce)&&(visibilidad==facadeVariables.capaTrafico.getVisibility())){return}facadeVariables.capaTrafico.setVisibility(visibilidad);if((this.capasVisibles==null)||(this.capasVisibles==undefined)){this.capasVisibles=new Object();this.contadorCapasVisibles=0}this.capasVisibles[facadeVariables.capaTrafico.name]=visibilidad;if(visibilidad){this.contadorCapasVisibles++}else{this.contadorCapasVisibles--}if(!visibilidad){if(!facadeVariables.traficoLoadedOnce){facadeVariables.capaTrafico.events.triggerEvent("loadend")}_removeTrafficRequestTimeout();facadeVariables.trafficDataLoadStopped=true;facadeVariables.currentTrafficRequest=null;facadeVariables.currentTrafficStateRequest=null;facadeVariables.currentTrafficTramosRequest=null}else{_forzarRefrescoTrafico()}}return}if(visibilidad){if((this.capasVisibles==null)||(this.capasVisibles==undefined)){this.capasVisibles=new Object();this.contadorCapasVisibles=0}this.capasVisibles[facadeVariables.capaTrafico.name]=true;this.contadorCapasVisibles++}var successTrafficConfigRequest=function(response){if((response==null)||(response==undefined)||(response=="")){OpenLayers.IAAA_Utils.report("error","[ERROR]: No se encuentra la informacin de trafico");return}var parsedResp;eval("parsedResp = "+response);var tramosUrl,estadosUrl;if((parsedResp.estado!=null)&&(parsedResp.estado!=undefined)){estadosUrl=parsedResp.estado}else{OpenLayers.IAAA_Utils.report("error","[ERROR]: No se encuentra el fichero de estados de trafico");return}if((facadeVariables.capaTrafico.filePropertyName!=null)&&(facadeVariables.capaTrafico.filePropertyName!=undefined)&&(parsedResp[facadeVariables.capaTrafico.filePropertyName]!=null)&&(parsedResp[facadeVariables.capaTrafico.filePropertyName]!=undefined)){tramosUrl=parsedResp[facadeVariables.capaTrafico.filePropertyName]}else{OpenLayers.IAAA_Utils.report("error","[ERROR]: No se encuentra el fichero de tramos de trafico");return}if(!facadeVariables.trafficDataLoadStopped){facadeVariables.capaTrafico.estadoTramosUrl=parsedResp.estado;var requestManager;if(useServlet){requestManager=new OpenLayers.IAAA_Request(null,getHost()+servlet,"GET");var params={urlWFS:estadosUrl,outputType:1,xmlRequest:false};requestManager.setRequestParams(params)}else{requestManager=new OpenLayers.IAAA_Request(null,estadosUrl,"GET")}requestManager.events.register("loaddata",this,function(evt){if(evt&&evt.object&&evt.object.response){successTrafficStateRequest(evt.object.response)}else{failure()}});requestManager._onLoad=function(ajaxRequest){if((this.timeStampMainRequestId!=facadeVariables.currentTrafficRequest)&&(this.timeStampId!=facadeVariables.currentTrafficStateRequest)){return}if(this.responseType=="text"){this.response=ajaxRequest.responseText}else{this.response=ajaxRequest.responseXML}this.events.triggerEvent("loaddata")};requestManager._onFail=function(ajaxRequest){if((this.timeStampMainRequestId!=facadeVariables.currentTrafficRequest)&&(this.timeStampId!=facadeVariables.currentTrafficStateRequest)){return}if(this.responseType=="text"){this.response=ajaxRequest.responseText}else{this.response=ajaxRequest.responseXML}this.events.triggerEvent("faildata")};var timeStamp=new Date();facadeVariables.currentTrafficStateRequest=timeStamp.getTime();requestManager.timeStampId=facadeVariables.currentTrafficStateRequest;requestManager.timeStampMainRequestId=localTrafficRequestId;requestManager.doRequest();var requestManager2;if(useServlet){requestManager2=new OpenLayers.IAAA_Request(null,getHost()+servlet,"GET");var params2={urlWFS:tramosUrl,outputType:1,xmlRequest:false};requestManager2.setRequestParams(params2)}else{requestManager2=new OpenLayers.IAAA_Request(null,tramosUrl,"GET")}requestManager2.events.register("loaddata",this,function(evt){if(evt&&evt.object&&evt.object.response){successTrafficTramosRequest(evt.object.response)}else{failure()}});requestManager2._onLoad=function(ajaxRequest){if((this.timeStampMainRequestId!=facadeVariables.currentTrafficRequest)&&(this.timeStampId!=facadeVariables.currentTrafficTramosRequest)){return}if(this.responseType=="text"){this.response=ajaxRequest.responseText}else{this.response=ajaxRequest.responseXML}this.events.triggerEvent("loaddata")};requestManager2._onFail=function(ajaxRequest){if((this.timeStampId!=null)&&(this.timeStampId!=undefined)&&(this.timeStampId!=facadeVariables.currentTrafficTramosRequest)){return}if(this.responseType=="text"){this.response=ajaxRequest.responseText}else{this.response=ajaxRequest.responseXML}this.events.triggerEvent("faildata")};var timeStamp=new Date();facadeVariables.currentTrafficTramosRequest=timeStamp.getTime();requestManager2.timeStampId=facadeVariables.currentTrafficTramosRequest;requestManager2.timeStampMainRequestId=localTrafficRequestId;requestManager2.doRequest()}};var successTrafficStateRequest=function(response){var parsedResp;eval("parsedResp = "+response);var stateString=parsedResp.estados;facadeVariables.estadoTramos=stateString;if(facadeVariables.tramos&&facadeVariables.estadoTramos){if(!facadeVariables.trafficDataLoadStopped){_pintaTramosTrafico();_setTrafficRequestTimeout();facadeVariables.traficoLoadedOnce=true}else{facadeVariables.capaTrafico.events.triggerEvent("loadend")}facadeVariables.trafficInitialLoad=false}};var successTrafficTramosRequest=function(response){var tramos;eval("tramos = "+response);facadeVariables.tramos=tramos.tramos;if(facadeVariables.tramos&&facadeVariables.estadoTramos){if(!facadeVariables.trafficDataLoadStopped){_pintaTramosTrafico();_setTrafficRequestTimeout();facadeVariables.traficoLoadedOnce=true}else{facadeVariables.capaTrafico.events.triggerEvent("loadend")}}};var failure=function(){facadeVariables.tramos=null;facadeVariables.estadoTramos=null;facadeVariables.capaTrafico.events.triggerEvent("loadend");OpenLayers.IAAA_Utils.report("error","[ERROR]: "+messages.trafficDataError)};if(facadeVariables.capaTrafico.configFile){var requestManager;if(useServlet){requestManager=new OpenLayers.IAAA_Request(null,getHost()+servlet,"GET");var params={urlWFS:facadeVariables.capaTrafico.configFile,outputType:1,xmlRequest:false};requestManager.setRequestParams(params)}else{requestManager=new OpenLayers.IAAA_Request(null,facadeVariables.capaTrafico.configFile,"GET")}requestManager._onLoad=function(ajaxRequest){if(this.timeStampId!=facadeVariables.currentTrafficRequest){return}if(this.responseType=="text"){this.response=ajaxRequest.responseText}else{this.response=ajaxRequest.responseXML}this.events.triggerEvent("loaddata")};requestManager._onFail=function(ajaxRequest){if(this.timeStampId!=facadeVariables.currentTrafficRequest){return}if(this.responseType=="text"){this.response=ajaxRequest.responseText}else{this.response=ajaxRequest.responseXML}this.events.triggerEvent("faildata")};requestManager.events.register("loaddata",this,function(evt){if(evt&&evt.object&&evt.object.response){if(!facadeVariables.trafficDataLoadStopped){successTrafficConfigRequest(evt.object.response)}}else{failure()}});var timeStamp=new Date();facadeVariables.currentTrafficRequest=timeStamp.getTime();requestManager.timeStampId=facadeVariables.currentTrafficRequest;localTrafficRequestId=requestManager.timeStampId;requestManager.doRequest();facadeVariables.capaTrafico.events.triggerEvent("loadstart")}}}function definirTiempoRefrescoTrafico(value){facadeVariables.traficoTiempoActualizacion=value}function geolocalizarUsuario(nombre,x,y,srs){this.eliminarUsuario();this.user=this.georreferenciarElemento(nombre,x,y,srs,facadeVariables.geoLocationLayerTitle);if(this.user&&this.user.popup){this.map.removePopup(this.user.popup);this.user.popup=null}}function eliminarUsuario(){if(this.user!=null){this.borrarElementosGeorreferenciados(this.user,facadeVariables.geoLocationLayerTitle);this.user=null;return true}return false}function georreferenciarElemento(elementName,x,y,srs,layerName,description,priority){var elementFeature=null;var centerMap=true;priority=((priority!=undefined)&&(priority!=null))?priority:null;layerName=layerName?layerName:null;var layers=null;if(layerName){layers=this.map.getLayersByName(layerName)}if(layerName&&this.map&&layers&&(layers.length==0)){if((x!=null)&&(x!=undefined)&&(x!="")&&(y!=undefined)&&(y!=null)&&(y!="")){if((srs==null)||(srs==undefined)||(srs=="")){srs="EPSG:25830"}if(srs!=this.map.getProjection()){var resultPointCoords=coordTransform(srs,this.map.getProjection(),x,y);x=resultPointCoords[0];y=resultPointCoords[1]}var iconWidth=((layerName!=facadeVariables.geoLocationLayerTitle)?streetLocationIconWidth:georrefLocationIconWidth);var iconWidths=[iconWidth*0.5,iconWidth*0.66,iconWidth*0.8,iconWidth];var iconHeight=((layerName!=facadeVariables.geoLocationLayerTitle)?streetLocationIconHeight:georrefLocationIconHeight);var iconHeights=[iconHeight*0.5,iconHeight*0.66,iconHeight*0.8,iconHeight];var json='{"type": "FeatureCollection","crs":{"type":"name","properties":{"name":"'+srs+'"}},"features": [{"type": "Feature","properties": { "title":"'+elementName+'",'+((description)?'"description":"'+description+'",':"")+'"icon":"'+((layerName!=facadeVariables.geoLocationLayerTitle)?streetLocationIcon:georrefLocationIcon)+'","style": {"graphicWidth": '+iconWidth+',"graphicHeight": '+iconHeight+',"poisIconsWidths": ['+iconWidths.toString()+'],"poisIconsHeights": ['+iconHeights.toString()+']},"priority": '+((priority==null)?((layerName==facadeVariables.searchLocationLayerTitle)?"1":"2"):priority)+',"showLogo": false,"clusterize": false,"disableAsDestination": '+((layerName==facadeVariables.geoLocationLayerTitle)?"true":"false")+',"getDimensionsFromStyle": true}, "geometry": {"type": "Point", "coordinates": ['+x+","+y+"]} }]}";_definirCapaJSON(layerName,json,false,null,null,{scaleIcon:true});layers=this.map.getLayersByName(layerName);if(layers&&layers.length){if(layers[0].features&&layers[0].features.length){elementFeature=layers[0].features[0]}layers[0].popupAnchorSize=streetLocationStyle.popupAnchorSize;layers[0].popupAnchorOffset=streetLocationStyle.popupAnchorOffset}if(!mobileNavigator&&(layerName==facadeVariables.geoLocationLayerTitle)){centerMap=false}}}else{if(layers&&layers.length){var vectLayer=layers[0];if((x!=null)&&(x!=undefined)&&(x!="")&&(y!=undefined)&&(y!=null)&&(y!="")){var resultPointCoords;if((typeof srs).toLowerCase()=="string"){srs=srs.replace(/\s+/g,"")}if((srs!=undefined)&&(srs!=null)){resultPointCoords=coordTransform(srs,this.map.getProjection(),x,y)}else{resultPointCoords=[x,y]}var resultPoint=new OpenLayers.Geometry.Point(resultPointCoords[0],resultPointCoords[1]);var iconWidth=((layerName!=facadeVariables.geoLocationLayerTitle)?streetLocationIconWidth:georrefLocationIconWidth);var iconWidths=[iconWidth*0.5,iconWidth*0.66,iconWidth*0.8,iconWidth];var iconHeight=((layerName!=facadeVariables.geoLocationLayerTitle)?streetLocationIconHeight:georrefLocationIconHeight);var iconHeights=[iconHeight*0.5,iconHeight*0.66,iconHeight*0.8,iconHeight];elementFeature=new OpenLayers.Feature.Vector(resultPoint,{name:elementName,description:description,title:elementName,icon:((layerName!=facadeVariables.geoLocationLayerTitle)?streetLocationIcon:georrefLocationIcon),graphicWidth:iconWidth,graphicHeight:iconHeight,priority:((priority==null)?((layerName==facadeVariables.searchLocationLayerTitle)?1:2):priority),showLogo:false,clusterize:false,disableAsDestination:((layerName==facadeVariables.geoLocationLayerTitle)?true:false)});if(elementFeature.style){elementFeature.style.externalGraphic=((layerName!=facadeVariables.geoLocationLayerTitle)?streetLocationIcon:georrefLocationIcon);elementFeature.style.graphicWidth=iconWidth;elementFeature.style.graphicHeight=iconHeight;elementFeature.style.poisIconsWidths=iconWidths;elementFeature.style.poisIconsHeights=iconHeights}else{elementFeature.style={externalGraphic:((layerName!=facadeVariables.geoLocationLayerTitle)?streetLocationIcon:georrefLocationIcon),graphicWidth:iconWidth,graphicHeight:iconHeight,poisIconsWidths:iconWidths,poisIconsHeights:iconHeights}}vectLayer.addFeatures([elementFeature]);if(layerName==facadeVariables.geoLocationLayerTitle){centerMap=false}}}}try{if((elementFeature!=null)&&centerMap){this.map.setCenter(new OpenLayers.LonLat(elementFeature.geometry.x,elementFeature.geometry.y))}}catch(e){OpenLayers.IAAA_Utils.report("log","[ERROR]: Center georef element - "+e)}return elementFeature}function borrarElementosGeorreferenciados(elements,layerName){layerName=layerName?layerName:null;if(facadeVariables&&facadeVariables._poisLayers){var vectLayer=null;if(layerName){for(var i=0,iLen=facadeVariables._poisLayers.length;i<iLen;i++){if(facadeVariables._poisLayers[i].name==layerName){vectLayer=facadeVariables._poisLayers[i];break}}}if(vectLayer){var featuresToRemoveList;if(elements!=null){if(((typeof elements).toLowerCase()=="object")&&elements.length){featuresToRemoveList=elements;var el;for(var i=0,iLen=elements.length;i<iLen;i++){el=elements[i];if(el.popup){this.map.removePopup(el.popup)}}vectLayer.removeFeatures(elements)}else{featuresToRemoveList=[elements];if(elements.popup){this.map.removePopup(elements.popup)}vectLayer.removeFeatures([elements])}}else{var elements=vectLayer.features;featuresToRemoveList=elements;if(elements){for(var i in elements){el=elements[i];if(elements[i].popup){this.map.removePopup(elements[i].popup)}}}vectLayer.removeAllFeatures()}if(facadeVariables&&facadeVariables.clusterStrategy&&facadeVariables.clusterStrategy.features){var feature;var clusterFeatureList=[];var pendingFeaturesToRemove;var found=false;for(var i=0,iLen=facadeVariables.clusterStrategy.features.length;i<iLen;i++){feature=facadeVariables.clusterStrategy.features[i];pendingFeaturesToRemove=[];found=false;for(var j=0,jLen=featuresToRemoveList.length;j<jLen;j++){if(feature.id==featuresToRemoveList[j].id){found=true}else{pendingFeaturesToRemove.push(featuresToRemoveList[j])}}if(!found){clusterFeatureList.push(feature)}featuresToRemoveList=pendingFeaturesToRemove}facadeVariables.clusterStrategy.features=clusterFeatureList}}}}function eliminarCalle(){if(this.searchResult!=null){this.borrarElementosGeorreferenciados(this.searchResult,facadeVariables.searchLocationLayerTitle);this.searchResult=null;return true}return false}function georreferenciarCalle(nombreCalle,x,y,crs){if((typeof nombreCalle=="object")){this.georreferenciarCalleSemantica(nombreCalle)}else{this.eliminarCalle();this.searchResult=this.georreferenciarElemento(nombreCalle,x,y,crs,facadeVariables.searchLocationLayerTitle,null,2)}}function georreferenciarCalleSemantica(obj){var nombreCalle,x,y,crs,idCalle;if(OpenLayers.Util.isArray(obj)){nombreCalle=obj[0];x=obj[1];y=obj[2];crs="EPSG:25830"}else{nombreCalle=obj.name;x=obj.longitude;y=obj.latitude;crs=obj.srs;if(crs==null){crs="EPSG:25830"}idCalle=obj.ine}this.eliminarCalle();if(nombreCalle&&x&&y&&crs){var semanticSearchLoaded=(typeof loadSemanticMappings=="function");var title;if(typeof _getFormattedTitleHTML!="undefined"){title=_getFormattedTitleHTML(nombreCalle)}else{title=nombreCalle}this.searchResult=this.georreferenciarElemento(nombreCalle,x,y,crs,facadeVariables.searchLocationLayerTitle,null);if(semanticSearchLoaded&&idCalle){if((this.searchResult!=null)&&this.searchResult.attributes){this.searchResult.attributes.waitingResultSemanticInfo=idCalle;var streetSemanticInfoHtml='<div style="width:100%;"><table cellspacing="0" cellpadding="0" style="width:auto"><tr style="width:auto"><td style="width:auto" align="left" valign="middle"><span class="maptipDescripcion">'+messages["search-aditional-info-loading"]+'</span></td><td align="left" valign="top"><span style="display:inline-block;"><img height="16" width="16" src="semanticSearchModule/css/callejero/images/node-loader.gif"></span></td></tr></table></div>';this.searchResult.attributes.description=streetSemanticInfoHtml;this.searchResult.data.description=streetSemanticInfoHtml;if(this.searchResult.popup){this.searchResult.popup.destroy();_showPopup(this.searchResult,true,"poisPopupPriorityFixed")}}waitingResultSemanticInfo=idCalle;loadSemanticMappings(idCalle,facade._updateResultSemanticContent)}}}function calcularRuta(origenX,origenY,destinoX,destinoY,opcionesRuta,srs){if(this.router==null){this._addRouterBehaviour();this._addSearchNearbyResourcesBehaviour();this.refreshSelectFeatureControl(facadeVariables._poisLayers)}var coordsSrs=srs;if(coordsSrs==null){coordsSrs=this.map.getProjection()}if(coordsSrs!=this.router.serviceSRS){var origin=coordTransform(coordsSrs,this.router.serviceSRS,origenX,origenY);origenX=origin[0];origenY=origin[1];var destination=coordTransform(coordsSrs,this.router.serviceSRS,destinoX,destinoY);destinoX=destination[0];destinoY=destination[1]}var from=new OpenLayers.LonLat(origenX,origenY);var to=new OpenLayers.LonLat(destinoX,destinoY);this.router.requestDirections(from,to,opcionesRuta)}function borrarRutas(){if(this.router!=null){this.router.routesLayer.removeAllFeatures()}}function _addRouterBehaviour(){var routesLayerId=this.map.layers.length;var routesLayerInfo={title:"Router",id:routesLayerId+""};this.addPoiLayer(this.map,routesLayerInfo,"",[routesLayerId]);var routesLayer=this.map.layers[this.map.layers.length-1];routesLayer.layerId=null;routesLayer.containsPoints=true;this.router=new OpenLayers.Control.IAAA_GoogleDirectionsAPIRouter(routerServiceUrl,{servletURL:((servlet!="")?getHost()+servlet:null),routesLayer:routesLayer,routeStyleImgDir:OpenLayers.Util.getImagesLocation()+"routeIcons/"});this.map.addControl(this.router);var originStyle=this.router.routeStyle.origin;originStyle.poisIconsWidths=[originStyle.graphicWidth*0.5,originStyle.graphicWidth*0.66,originStyle.graphicWidth*0.8,originStyle.graphicWidth];originStyle.poisIconsHeights=[originStyle.graphicHeight*0.5,originStyle.graphicHeight*0.66,originStyle.graphicHeight*0.8,originStyle.graphicHeight];var destinationStyle=this.router.routeStyle.destination;destinationStyle.poisIconsWidths=[destinationStyle.graphicWidth*0.5,destinationStyle.graphicWidth*0.66,destinationStyle.graphicWidth*0.8,destinationStyle.graphicWidth];destinationStyle.poisIconsHeights=[destinationStyle.graphicHeight*0.5,destinationStyle.graphicHeight*0.66,destinationStyle.graphicHeight*0.8,destinationStyle.graphicHeight];this.router.routeErrorCallback=function(){alert("No se ha podido calcular la ruta")}}function transformarCoordenadas(actualSRS,nuevoSRS,x,y){if(nuevoSRS==null){nuevoSRS=this.map.getProjection()}var newCoords=coordTransform(actualSRS,nuevoSRS,x,y);return newCoords}function buscarRecursosCercanos(x,y,srs,distancia,serviceOptions){this.searchResourcesOptions.currentOptions=serviceOptions;if(this.searchResourcesOptions.layer==null){this._addSearchNearbyResourcesBehaviour();this._addRouterBehaviour();this.refreshSelectFeatureControl(facadeVariables._poisLayers)}this.searchResourcesOptions.layer.removeFeatures(this.currentResources,{silent:true});this.currentResources=[];if(this.currentResourcesScope!=null){if(this.searchResourcesOptions.scopeEditionControl!=null){this.searchResourcesOptions.scopeEditionControl.unselectFeature(this.currentResourcesScope)}this.searchResourcesOptions.layer.removeFeatures([this.currentResourcesScope],{silent:true})}if((distancia<this.searchResourcesOptions.minScope)){distancia=this.searchResourcesOptions.minScope}else{if((distancia>this.searchResourcesOptions.maxScope)){distancia=this.searchResourcesOptions.maxScope}}var center;if(srs!=this.map.getProjection()){center=coordTransform(srs,this.map.getProjection(),x,y)}else{center=[x,y]}this.currentResourcesSearchParams={center:new OpenLayers.Geometry.Point(center[0],center[1]),scope:parseInt(distancia)};var point;if(srs!=this.searchResourcesOptions.serviceSRS){point=coordTransform(srs,this.searchResourcesOptions.serviceSRS,x,y)}else{point=[x,y]}var srsId;if(this.searchResourcesOptions.currentOptions&&this.searchResourcesOptions.currentOptions.SRS){srsId=this.searchResourcesOptions.currentOptions.SRS}else{if(this.searchResourcesOptions.serviceSRS=="EPSG:23030"){srsId="utm30n"}else{if(this.searchResourcesOptions.serviceSRS=="EPSG:25830"){srsId="utm30n_etrs89"}else{srsId="wgs84"}}}if(!this.vectorialDataRequester){this.vectorialDataRequester={}}var id=new Date().getTime();var params=[];params.results_only=true;params.srsname=srsId;params.point=point[0]+","+point[1];params.distance=parseInt(distancia);if(this.searchResourcesOptions.currentOptions&&this.searchResourcesOptions.currentOptions.maxResults){params.rows=this.searchResourcesOptions.currentOptions.maxResults}else{if(this.searchResourcesOptions.serviceMaxResults){params.rows=this.searchResourcesOptions.serviceMaxResults}}var loadUrlServlet=!(getHost().contains("zaragoza.es"));var requestURL;if(this.searchResourcesOptions.currentOptions&&this.searchResourcesOptions.currentOptions.URL){requestURL=this.searchResourcesOptions.currentOptions.URL}else{requestURL=this.searchResourcesOptions.serviceURL}if(loadUrlServlet&&(typeof servlet!="undefined")){this.vectorialDataRequester[id]=new OpenLayers.IAAA_Request(null,servlet,"GET");params.urlWFS=requestURL;params.outputType=1;this.vectorialDataRequester[id].setRequestParams(params)}else{for(var key in params){if(requestURL.indexOf("?")==-1){requestURL+="?"}else{requestURL+="&"}requestURL+=key+"="+params[key]}this.vectorialDataRequester[id]=new OpenLayers.IAAA_Request(null,requestURL,"GET")}console.log("Buscando recursos cercanos a "+distancia+" metros...");this.vectorialDataRequester[id].events.register("loaddata",this,this._procesarRecursos);this.vectorialDataRequester[id].requestId=id;this.vectorialDataRequester[id].doRequest();this.vectorialDataRequester[id].cancelRequest=false;var loadingControl=this.map.getControlsByClass("OpenLayers.Control.IAAA_LoadingMap")[0];if(loadingControl){loadingControl.showLoadingDiv()}}function eliminarRecursosCercanos(){if(this.searchResourcesOptions.layer){if(this.searchResourcesOptions.scopeEditionControl!=null){if(this.currentResourcesScope!=null){this.searchResourcesOptions.scopeEditionControl.unselectFeature(this.currentResourcesScope)}this.searchResourcesOptions.scopeEditionControl.deactivate()}if(this.currentResourcesScope!=null){this.searchResourcesOptions.layer.removeFeatures([this.currentResourcesScope],{silent:true})}if(this.currentResources!=null){this.searchResourcesOptions.layer.removeFeatures(this.currentResources,{silent:true})}}}function _addSearchNearbyResourcesBehaviour(){var searchResourcesLayerId=this.map.layers.length;var searchResourcesLayerInfo={title:"NearbyResources",id:searchResourcesLayerId+""};this.addPoiLayer(this.map,searchResourcesLayerInfo,"",[searchResourcesLayerId]);this.searchResourcesOptions.layer=this.map.layers[this.map.layers.length-1];this.searchResourcesOptions.layer.layerId=null;this.map.setLayerIndex(this.searchResourcesOptions.layer,1);this.searchResourcesOptions.layer.style=resourcesScopeEditionPointStyle;this.searchResourcesOptions.layer.containsPoints=true;var resourcesScopeEditionControl=new OpenLayers.Control.ModifyFeature(this.searchResourcesOptions.layer,{standalone:true,mode:OpenLayers.Control.ModifyFeature.RESIZE});this._changeModifyFeatureBehaviour(resourcesScopeEditionControl);this.map.addControl(resourcesScopeEditionControl);this.searchResourcesOptions.scopeEditionControl=resourcesScopeEditionControl}function _changeModifyFeatureBehaviour(control){control.dragControl.handlers.feature.stopClick=false;control.dragControl.handlers.feature.stopDown=false;control.layer.events.register("featuremodified",this,function(evt){var radious=(evt.feature.geometry.getBounds().right-evt.feature.geometry.getBounds().left)/2;var center=evt.feature.geometry.getCentroid();if(radious>resourcesMaxScope){radious=resourcesMaxScope}else{if(radious<resourcesMinScope){radious=resourcesMinScope}}facade.buscarRecursosCercanos(center.x,center.y,getMap().getProjection(),radious,this.searchResourcesOptions.currentOptions)});control.collectRadiusHandle=function(){var geometry=this.feature.geometry;var bounds=geometry.getBounds();var center=bounds.getCenterLonLat();var radiusDistance=(bounds.right-bounds.left)/2;var originGeometry=new OpenLayers.Geometry.Point(center.lon,center.lat);var radiusGeometry=new OpenLayers.Geometry.Point(bounds.right,bounds.bottom);var radiusAtts={};var radiusStyle=OpenLayers.Util.extend({label:parseInt(radiusDistance)+"m"},this.layer.style);var radius=new OpenLayers.Feature.Vector(radiusGeometry,radiusAtts,radiusStyle);radius.attributes.dontScale=true;var resize=(this.mode&OpenLayers.Control.ModifyFeature.RESIZE);var reshape=(this.mode&OpenLayers.Control.ModifyFeature.RESHAPE);var rotate=(this.mode&OpenLayers.Control.ModifyFeature.ROTATE);radiusGeometry.move=function(x,y){OpenLayers.Geometry.Point.prototype.move.call(this,x,y);var dx1=this.x-originGeometry.x;var dy1=this.y-originGeometry.y;var dx0=dx1-x;var dy0=dy1-y;if(rotate){var a0=Math.atan2(dy0,dx0);var a1=Math.atan2(dy1,dx1);var angle=a1-a0;angle*=180/Math.PI;geometry.rotate(angle,originGeometry)}if(resize){var scale,ratio;if(reshape){scale=dy1/dy0;ratio=(dx1/dx0)/scale}else{var l0=Math.sqrt((dx0*dx0)+(dy0*dy0));var l1=Math.sqrt((dx1*dx1)+(dy1*dy1));scale=l1/l0}geometry.resize(scale,originGeometry,ratio)}var radiusDistance=(geometry.getBounds().right-geometry.getBounds().left)/2;radius.style.label=parseInt(radiusDistance)+"m"};radius._sketch=true;this.radiusHandle=radius;this.layer.addFeatures([this.radiusHandle],{silent:true})}}function _procesarRecursos(evt){var id=null;if(this.vectorialDataRequester){var id;if(evt&&evt.object){id=evt.object.requestId}if(!id||!this.vectorialDataRequester[id]){return false}try{res=eval("("+this.vectorialDataRequester[id].getResponse()+")")}catch(e){res=null;OpenLayers.IAAA_Utils.report("log","Error al parsear los recursos prximos:\n"+e)}delete this.vectorialDataRequester[id];this.vectorialDataRequester[id]=undefined;if(res==null){res=[]}var mapSrs=this.map.getProjection();var resourcesFeatures=[];for(var i=0,len=res.length;i<len;i++){var resourceData=res[i];if((resourceData.geometry==null)||(resourceData.geometry.coordinates==null)){continue}var resourceCoords=resourceData.geometry.coordinates;if(mapSrs!=this.searchResourcesOptions.serviceSRS){resourceCoords=coordTransform(this.searchResourcesOptions.serviceSRS,mapSrs,resourceCoords[0],resourceCoords[1])}var resourceGeom=new OpenLayers.Geometry.Point(resourceCoords[0],resourceCoords[1]);var resourceAtts={resource:true,disableAsDestination:true,clusterize:false};for(var attKey in resourceData){if((typeof resourceData[attKey]=="string")||(typeof resourceData[attKey]=="number")){resourceAtts[attKey]=resourceData[attKey]}}var resourceStyle=OpenLayers.Util.extend({},this.searchResourcesOptions.style);if(this.searchResourcesOptions.currentOptions&&this.searchResourcesOptions.currentOptions.icon){resourceStyle.externalGraphic=this.searchResourcesOptions.currentOptions.icon}if(resourceAtts.url){resourceStyle.cursor="pointer"}var resourceFeature=new OpenLayers.Feature.Vector(resourceGeom,resourceAtts,resourceStyle);resourcesFeatures.push(resourceFeature)}var scopeGeom=OpenLayers.Geometry.Polygon.createRegularPolygon(this.currentResourcesSearchParams.center,this.currentResourcesSearchParams.scope,this.searchResourcesOptions.scopeSides);var scopeAtts={resource:true,scope:this.currentResourcesSearchParams.scope,clusterize:false};if(this.searchResourcesOptions.scopeMsg!=null){scopeAtts.title=this.searchResourcesOptions.scopeMsg+this.currentResourcesSearchParams.scope+"m"}this.currentResourcesScope=new OpenLayers.Feature.Vector(scopeGeom,scopeAtts,this.searchResourcesOptions.scopeStyle);this.searchResourcesOptions.layer.addFeatures([this.currentResourcesScope],{silent:true});if(resourcesFeatures.length>0){this.currentResources=resourcesFeatures.slice();this.searchResourcesOptions.layer.addFeatures(resourcesFeatures,{silent:true})}if((this.searchResourcesOptions.scopeEditionControl!=null)&&(this.currentResourcesScope!=null)){this.searchResourcesOptions.scopeEditionControl.activate();this.searchResourcesOptions.scopeEditionControl.selectFeature(this.currentResourcesScope);this.searchResourcesOptions.layer.div.style.zIndex=this.map.layers[0].div.style.zIndex}if(this.searchResourcesOptions.layer.getVisibility()==false){this.searchResourcesOptions.layer.setVisibility(true)}}var loadingControl=this.map.getControlsByClass("OpenLayers.Control.IAAA_LoadingMap")[0];if(loadingControl){loadingControl.hideLoadingDiv()}}function _updateResultSemanticContent(id){if((typeof waitingResultSemanticInfo!="undefined")&&(waitingResultSemanticInfo==id)){var streetSemanticInfoHtml;if(typeof getSemanticContent!="undefined"){streetSemanticInfoHtml=getSemanticContent(id)}if(streetSemanticInfoHtml&&(typeof _getFormattedSemanticHTML!="undefined")){streetSemanticInfoHtml=_getFormattedSemanticHTML(streetSemanticInfoHtml)}facade._actualizarInformacionSemantica(streetSemanticInfoHtml,waitingResultSemanticInfo);waitingResultSemanticInfo=-1}}function _actualizarInformacionSemantica(description,id){if((this.searchResult!=null)&&this.searchResult.attributes&&(this.searchResult.attributes.waitingResultSemanticInfo==id)){if(description==undefined){description=""}if(description!=""){this.searchResult.attributes.hasSemanticInfo=true}this.searchResult.attributes.description=description;this.searchResult.data.description=description;if(this.searchResult.popup){this.searchResult.popup.destroy();_showPopup(this.searchResult,true,"poisPopupPriorityFixed")}}}var changingVisibilityWithChilds=false;var layerChangingVisibilityWithChilds=null;facadeVariables.waitingToLoad=0;facadeVariables.loadData={};facadeVariables.centerInGeometries=false;facadeVariables.layersOnTopList=[];facadeVariables._poisVisibleCount=0;facadeVariables.legendLayerNamesList=new Array();facadeVariables.layerLegendInfo=new Object();facadeVariables.defaultPopupOpacity=((options.facadeLocalOptions!=null)&&(options.facadeLocalOptions!=undefined)&&(options.facadeLocalOptions.defaultPopupOpacity!=null)&&(options.facadeLocalOptions.defaultPopupOpacity!=undefined))?options.facadeLocalOptions.defaultPopupOpacity:0.8;facadeVariables.searchLocationLayerTitle=((options.facadeLocalOptions!=null)&&(options.facadeLocalOptions!=undefined)&&(options.facadeLocalOptions.searchLocationLayerTitle!=null)&&(options.facadeLocalOptions.searchLocationLayerTitle!=undefined))?options.facadeLocalOptions.searchLocationLayerTitle:"Street location";facadeVariables.geoLocationLayerTitle=((options.facadeLocalOptions!=null)&&(options.facadeLocalOptions!=undefined)&&(options.facadeLocalOptions.geoLocationLayerTitle!=null)&&(options.facadeLocalOptions.geoLocationLayerTitle!=undefined))?options.facadeLocalOptions.geoLocationLayerTitle:"User location";facadeVariables._poisLayers=new Array();facadeVariables._poisLayers=[];facadeVariables._georreferenceLayers={};facadeVariables.popupOptions=((options.facadeLocalOptions!=null)&&(options.facadeLocalOptions!=undefined)&&(options.facadeLocalOptions.popupOptions!=null)&&(options.facadeLocalOptions.popupOptions!=undefined))?options.facadeLocalOptions.popupOptions:null;facadeVariables.garbageCollectionList=new Array();facadeVariables.garbageCollectionList=[];facadeVariables.streetLocationLayerDiv=null;facadeVariables.georrefLayerDivList=null;facadeVariables.markerLayerDivList=null;facadeVariables.renderLayerDiv=null;facadeVariables.showGeoReferenceLabel=(((options.facadeLocalOptions.showGeoReferenceLabel!=undefined)&&(options.facadeLocalOptions.showGeoReferenceLabel!=null))?options.facadeLocalOptions.showGeoReferenceLabel:true);for(var i=0,iLen=this.map.controls.length;i<iLen;i++){if(this.map.controls[i].CLASS_NAME=="OpenLayers.Control.IAAA_ZoomBox"){this.map.controls[i].handler.destroy();this.map.controls[i].clickDisabled=false;this.map.controls[i].disableClick=function(value){this.clickDisabled=value};this.map.controls[i].zoomBoxClickDisable=function(position){if(position instanceof OpenLayers.Bounds){var bounds;if(!this.out){var minXY=this.map.getLonLatFromPixel(new OpenLayers.Pixel(position.left,position.bottom));var maxXY=this.map.getLonLatFromPixel(new OpenLayers.Pixel(position.right,position.top));bounds=new OpenLayers.Bounds(minXY.lon,minXY.lat,maxXY.lon,maxXY.lat)}else{var pixWidth=Math.abs(position.right-position.left);var pixHeight=Math.abs(position.top-position.bottom);var zoomFactor=Math.min((this.map.size.h/pixHeight),(this.map.size.w/pixWidth));var extent=this.map.getExtent();var center=this.map.getLonLatFromPixel(position.getCenterPixel());var xmin=center.lon-(extent.getWidth()/2)*zoomFactor;var xmax=center.lon+(extent.getWidth()/2)*zoomFactor;var ymin=center.lat-(extent.getHeight()/2)*zoomFactor;var ymax=center.lat+(extent.getHeight()/2)*zoomFactor;bounds=new OpenLayers.Bounds(xmin,ymin,xmax,ymax)}var lastZoom=this.map.getZoom();this.map.zoomToExtent(bounds);if(lastZoom==this.map.getZoom()&&this.alwaysZoom==true){this.map.zoomTo(lastZoom+(this.out?-1:1))}}else{if(!this.clickDisabled){if(!this.out){this.map.setCenter(this.map.getLonLatFromPixel(position),this.map.getZoom()+1)}else{this.map.setCenter(this.map.getLonLatFromPixel(position),this.map.getZoom()-1)}}}};this.map.controls[i].draw=function(){this.handler=new OpenLayers.Handler.IAAA_Box(this,{done:this.zoomBoxClickDisable},{keyMask:this.keyMask,style:this.boxStyle,boxDiplacement:this.boxDiplacement})};this.map.controls[i].handler=new OpenLayers.Handler.IAAA_Box(this.map.controls[i],{done:this.map.controls[i].zoomBoxClickDisable},{keyMask:this.map.controls[i].keyMask,style:this.map.controls[i].boxStyle,boxDiplacement:this.map.controls[i].boxDiplacement})}}if(mobileNavigator){poisClientStyle.maxSize=new OpenLayers.Size(((screen.width*0.5)<600)?(screen.width*0.5):600,((screen.height*0.5)<660)?(screen.height*0.5):660);streetLocationStyle.maxSize=new OpenLayers.Size(((screen.width*0.5)<600)?(screen.width*0.5):600,((screen.height*0.5)<660)?(screen.height*0.5):660);clusterClientStyle.maxSize=new OpenLayers.Size(((screen.width*0.5)<600)?(screen.width*0.5):600,((screen.height*0.5)<660)?(screen.height*0.5):660);this.map.screenPopupLimit={h:popupMapSafeHeight,w:popupMapSafeWidth}}else{if(navigator.appName=="Microsoft Internet Explorer"){try{var ieArrayVersion=navigator.appVersion.split("MSIE");var ieVersion=parseInt(ieArrayVersion[1]);if((ieVersion!=null)&&(ieVersion==8)){poisClientStyle.maxSize={w:maxPopupWidthIE,h:maxPopupHeightIE};streetLocationStyle.maxSize={w:maxPopupWidthIE,h:maxPopupHeightIE};clusterClientStyle.maxSize={w:maxPopupWidthIE,h:maxPopupHeightIE}}}catch(e){}}}var facadeOL=new Object();facadeOL.map=this.map;facadeOL.markerImageUrl=null;facadeOL.markerImageWidth=null;facadeOL.markerImageHeight=null;facadeOL.markerImageOffsetX=null;facadeOL.markerImageOffsetY=null;facadeOL.markerTextOffsetX=null;facadeOL.markerTextOffsetY=null;facadeOL.markerPopupBgColor="white";facadeOL.wmsClientMarkerLabelsColor="black";facadeOL.markerEtFontStyle="bold 8pt arial";if((options!=null)&&(options!=undefined)&&(options.facadeOLOptions!=null)&&(options.facadeOLOptions!=undefined)){for(i in options.facadeOLOptions){facadeOL[i]=options.facadeOLOptions[i]}}facadeOL.addMarker=function(geom,et,tooltip,scale,popupStyle,layerName,centerMap,iconUrl,iconWidth,iconHeight,iconOffsetX,iconOffsetY){popupStyle=((popupStyle!=undefined)&&(popupStyle!=null))?popupStyle:null;var layerName=((layerName!=null)&&(layerName!=undefined)?layerName:null);var geomSrs=(geom.srs)?geom.srs:"EPSG:25830";if((geom.x!=undefined)&&(geom.y!=undefined)){var x=geom.x;var y=geom.y}else{if(geom.width&&geom.height){if(scale){var x=geom.getX()+(geom.getWidth()/2);var y=geom.getY()+(geom.getHeight()/2)}else{var x=geom.getX()+(geom.getWidth()/2);var y=geom.getY()+(geom.getHeight()/2);this.map.zoomToExtent(new OpenLayers.Bounds(geom.getX(),geom.getY(),geom.getX()+geom.getWidth(),geom.getY()+geom.getHeight()));scale=this.map.getScale()}}else{return false}}for(var i in this.map.layers){if(((this.map.layers[i].CLASS_NAME=="OpenLayers.Layer.Markers")||(this.map.layers[i].CLASS_NAME=="OpenLayers.Layer.IAAA_Markers"))&&((layerName==null)||((layerName!=null)&&(layerName==this.map.layers[i].name)))){this.map.layers[i].clearMarkers();if((this.map.getProjection()==geomSrs)&&(this.map.baseLayer.CLASS_NAME!="OpenLayers.Layer.Google")&&(this.map.baseLayer.CLASS_NAME!="OpenLayers.Layer.IAAA_Google")){var posX=x;var posY=y}else{if((this.map.baseLayer.CLASS_NAME!="OpenLayers.Layer.Google")&&(this.map.baseLayer.CLASS_NAME!="OpenLayers.Layer.IAAA_Google")){var punto=coordTransform(geomSrs,this.map.getProjection(),x,y);var posX=punto[0];var posY=punto[1]}else{var centerAux=coordTransform(geomSrs,"EPSG:900913",x,y);var posX=centerAux[0];var posY=centerAux[1]}}var marker=this._getMarkerPoint(posX,posY,et,tooltip,null,null,null,this.map.layers[i],popupStyle,iconUrl,iconWidth,iconHeight,iconOffsetX,iconOffsetY);this.map.layers[i].addMarker(marker);var visibilityArrayAux=new Array();for(var j in this.map.layers){if(this.map.layers[j].CLASS_NAME=="OpenLayers.Layer.IAAA_IconsWMS"){visibilityArrayAux.push(this.map.layers[j].getVisibility());this.map.layers[j].setVisibility(false)}}if(centerMap){if(scale){this.map.zoomToScale(scale)}this.map.setCenter(new OpenLayers.LonLat(posX,posY))}var indAux=0;for(var j in this.map.layers){if(this.map.layers[j].CLASS_NAME=="OpenLayers.Layer.IAAA_IconsWMS"){this.map.layers[j].setVisibility(visibilityArrayAux[indAux]);indAux++}}return}}};facadeOL._getMarkerPoint=function(posX,posY,et,tooltip,name,id,url,layer,popupStyle,markerUrl,markerWidth,markerHeight,markerOffsetX,markerOffsetY){popupStyle=((popupStyle!=undefined)&&(popupStyle!=null))?popupStyle:null;var lonlat=new OpenLayers.LonLat(posX,posY);var markerIconOffset=null;if((markerOffsetX!=null)&&(markerOffsetX!=undefined)&&(markerOffsetY!=null)&&(markerOffsetY!=undefined)){markerIconOffset=new OpenLayers.Pixel(markerOffsetX,markerOffsetY)}else{if((this.markerImageOffsetX!=null)&&(this.markerImageOffsetX!=undefined)&&(this.markerImageOffsetY!=null)&&(this.markerImageOffsetY!=undefined)){markerIconOffset=new OpenLayers.Pixel(this.markerImageOffsetX,this.markerImageOffsetY)}}var markerTextOffset=null;if((this.markerTextOffsetX!=null)&&(this.markerTextOffsetX!=undefined)&&(this.markerTextOffsetY!=null)&&(this.markerTextOffsetY!=undefined)){markerTextOffset=new OpenLayers.Pixel(this.markerTextOffsetX,this.markerTextOffsetY)}var marker=new OpenLayers.Marker.IAAA_Marker(lonlat,new OpenLayers.Icon((markerUrl?markerUrl:this.markerImageUrl),new OpenLayers.Size(((markerWidth?markerWidth:this.markerImageWidth)||10),((markerHeight?markerHeight:this.markerImageHeight)||10)),markerIconOffset),{name:name});if(marker&&marker.icon&&marker.icon.imageDiv){if(marker.icon.imageDiv.style){marker.icon.imageDiv.style.cursor="pointer"}else{marker.icon.imageDiv.style="cursor: pointer"}}if(id){marker.id=id}if(url){marker.url=url}if(et){if(navigator.userAgent.indexOf("MSIE 6.0")>=0){var etMarker=new OpenLayers.Marker(new OpenLayers.LonLat(posX,posY),new OpenLayers.Icon(null,null,new OpenLayers.Pixel(-50+((markerTextOffset!=null)?markerTextOffset.x:0),-10+((markerTextOffset!=null)?markerTextOffset.x:0))));var etDiv=OpenLayers.Util.createDiv("et",new OpenLayers.Pixel(0,0),new OpenLayers.Size("100%",20),null,"relative");etDiv.style.display="block";etDiv.innerHTML='<table width="100px"><tr><td><TEXT><CENTER><font style="font: '+this.markerEtFontStyle+"; color: "+this.wmsClientMarkerLabelsColor+'">'+et+"</Font></CENTER></TEXT></td></tr></table>";etMarker.icon.imageDiv.style.display="none";etMarker.icon.imageDiv.appendChild(etDiv);layer.addMarker(etMarker)}else{var etMarker=new OpenLayers.Marker(new OpenLayers.LonLat(posX,posY),new OpenLayers.Icon(null));var etDiv=OpenLayers.Util.createDiv("et",new OpenLayers.Pixel(0,0),new OpenLayers.Size("100%",20),null,"relative");etDiv.style.left=(((markerTextOffset!=null)?markerTextOffset.x:0)-40)+"px";etDiv.style.top=((markerTextOffset!=null)?markerTextOffset.y:0)+"px";etDiv.style.visibility="visible";etDiv.innerHTML='<table width="100px"><tr><td><TEXT><CENTER><font style="font: '+this.markerEtFontStyle+"; color: "+this.wmsClientMarkerLabelsColor+'">'+et+"</Font></CENTER></TEXT></td></tr></table>";etMarker.icon.imageDiv.style.visibility="hidden";etMarker.icon.imageDiv.appendChild(etDiv);layer.addMarker(etMarker)}}if(tooltip){function mouseOver(evt){if(!this.reactivateZoomBox){for(var j in this.map.controls){if((this.map.controls[j].CLASS_NAME=="OpenLayers.Control.IAAA_ZoomBox")&&this.map.controls[j].active){this.reactivateZoomBox=true;this.controlIndexAux=j;if(this.map.controls[j].disableClick){this.map.controls[j].disableClick(true)}}}}if(this.map.popups){for(var index=0,popupLen=this.map.popups.length;index<popupLen;index++){if(this.map.popups[index].id==this.popupId){this.map.removePopup(this.map.popups[index]);break}}}var contentHTML;if(this.popupStyle==null){contentHTML='<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1"/>';contentHTML+='<div class="olLayerGeoRSSDescription" align="center" style="height:auto; top:50px">';contentHTML+='<font face="Arial" size="1">'+this.description+"</font>";contentHTML+="</div>"}else{contentHTML='<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1"/>';contentHTML+="<div"+((this.popupStyle.containerClass)?' class="'+this.popupStyle.containerClass+'"':"")+((this.popupStyle.contentDivAlignment)?' align="'+this.popupStyle.contentDivAlignment+'"':"")+((this.popupStyle.contentDivStyle)?' style="'+this.popupStyle.contentDivStyle+'"':"")+">";contentHTML+="<font"+((this.popupStyle.fontClass)?' class="'+this.popupStyle.fontClass+'"':' face="Arial" size="1"')+">";contentHTML+=this.description;contentHTML+="</font>";contentHTML+="</div>"}var name=this.description?this.description:"marker";var pixelAux=this.map.getPixelFromLonLat(this.lonlat);var popupPos=new OpenLayers.Pixel(pixelAux.x+15,pixelAux.y+15);var lonlat=this.map.getLonLatFromPixel(popupPos);var anchWidth=this.markerImageWidth?this.markerImageWidth:10;var anchHeight=this.markerImageHeight?this.markerImageHeight:10;var anchor={size:new OpenLayers.Size(anchWidth+2,anchHeight),offset:new OpenLayers.Pixel(-8-this.markerImageWidth,-(this.markerImageHeight))};var popupSize;if(this.popupStyle){if(this.popupStyle.popupSize){popupSize=this.popupStyle.popupSize}else{popupSize=new OpenLayers.IAAA_Size(120,20)}if(this.popupStyle.popupAnchor){anchor=this.popupStyle.popupAnchor}}else{popupSize=new OpenLayers.IAAA_Size(120,20)}var popup;if(this.popupStyle&&this.popupStyle.popupClass){var popupOptions=new Object();for(var att in facadeVariables.popupOptions){popupOptions[att]=facadeVariables.popupOptions[att]}if(this.popupStyle.stemSize){popupOptions.stemSize=this.popupStyle.stemSize}if(this.popupStyle.stemImageOffset){popupOptions.stemImageOffset=this.popupStyle.stemImageOffset}if(this.popupStyle.stemDivOffset){popupOptions.stemDivOffset=this.popupStyle.stemDivOffset}if(this.popupStyle.popupDivOffset){popupOptions.popupDivOffset=this.popupStyle.popupDivOffset}if(this.popupStyle.stemOffsetRight){popupOptions.stemSizeOffsetRight=this.popupStyle.stemSizeOffsetRight}if(this.popupStyle.stemSizeOffsetLeft){popupOptions.stemSizeOffsetLeft=this.popupStyle.stemSizeOffsetLeft}if(this.popupStyle.popupDivOffset){popupOptions.popupDivOffset=this.popupStyle.popupDivOffset}if(this.popupStyle.blockOpacity){if(navigatorInfo){if((navigatorInfo[0]=="msie")&&(parseInt(navigatorInfo[1])<=6)){popupOptions.blockOpacity={stem:1}}else{popupOptions.blockOpacity=this.popupStyle.blockOpacity}}else{popupOptions.blockOpacity={stem:1}}}popupOptions.popupImageSrc=this.popupStyle.popupImageSrc;if(this.popupStyle.popupOpacity){popupOptions.opacity=this.popupStyle.popupOpacity}if(this.popupStyle.imageSize){popupOptions.imageSize=this.popupStyle.imageSize}if(this.popupStyle.positionBlocks){popupOptions.positionBlocks=this.popupStyle.positionBlocks}if(this.popupStyle.maxSize){popupOptions.maxSize=this.popupStyle.maxSize}if(this.popupStyle.blockPositionRightOffset){popupOptions.blockPositionRightOffset=this.popupStyle.blockPositionRightOffset}popupOptions.showLogo=((this.popupStyle&&this.popupStyle.showLogo)?true:false);popupOptions.logoImgSrc=((this.popupStyle&&this.popupStyle.logoImgSrc)?true:undefined);popupOptions.logoSize=((this.popupStyle&&this.popupStyle.logoSize)?true:undefined);popupOptions.panMapIfOutOfView=((this.popupStyle&&this.popupStyle.panMapIfOutOfView)?true:false);popup=new this.popupStyle.popupClass(this.popupId,lonlat,this.popupStyle.popupSize,contentHTML,anchor,(this.popupStyle.popupClass.closeBox?this.popupStyle.popupClass.closeBox:false),(this.popupStyle.popupClass.closeBoxFunc?this.popupStyle.popupClass.closeBoxFunc:null),popupOptions);popup.setBorder=function(border){return;if(border!=undefined){this.border=border}if(this.div!=null){try{this.div.style.border=this.border}catch(e){this.div.style.setAttribute("border",this.border)}}};popup.border=0;popup.events.registerPriority("mouseover",popup.div,function(evt){OpenLayers.Event.stop(evt);return false});popup.events.register("mousemove",popup.div,function(evt){OpenLayers.Event.stop(evt);return false})}else{popup=new OpenLayers.Popup.IAAA_Anchored(this.popupId,lonlat,popupSize,contentHTML,anchor)}var lastPopupZIndex=null;if(this.popupStyle==null){popup.setBackgroundColor(this.markerPopupBgColor);popup.setSize(new OpenLayers.IAAA_Size(120,"auto"));popup.setOpacity(1)}else{if(this.popupStyle.popupOpacity){popup.opacity=this.popupStyle.popupOpacity}if(this.popupStyle.popupBgColor){popup.setBackgroundColor(this.popupStyle.popupBgColor)}if(this.popupStyle.className){popup.contentDiv.className=this.popupStyle.className}if(this.map&&this.map.popups&&(this.map.popups.length>0)){var lastPopup=this.map.popups[this.map.popups.length-1];var contentZIndex=parseInt(lastPopup.contentDiv.style.zIndex);lastPopupZIndex=((contentZIndex>1)?contentZIndex:parseInt(lastPopup.div.style.zIndex))}}this.map.addPopup(popup);if(this.popupStyle==null){popup.div.style.border="2px solid black"}else{if(this.popupStyle.popupBorderWidth&&this.popupStyle.popupBorderColor){popup.border=this.popupStyle.popupBorderWidth+"px solid "+this.popupStyle.popupBorderColor}else{if(this.popupBorderStyle){popup.border=this.popupBorderStyle}}if((lastPopupZIndex!=null)&&(lastPopupZIndex!=undefined)&&(lastPopupZIndex>1)){popup.div.style.zIndex=lastPopupZIndex+1}}}function mouseOut(evt){if(this.reactivateZoomBox){if(this.controlIndexAux&&this.map.controls[this.controlIndexAux]&&this.map.controls[this.controlIndexAux].disableClick){this.map.controls[j].disableClick(false)}this.reactivateZoomBox=false}if(this.map.popups){for(var index=0,popupLen=this.map.popups.length;index<popupLen;index++){if(this.map.popups[index].id==this.popupId){this.map.removePopup(this.map.popups[index]);break}}}OpenLayers.Event.stop(evt)}marker.popupStyle=popupStyle;marker.description=tooltip;marker.reactivateZoomBox=false;marker.controlIndexAux=-1;marker.markerImageWidth=this.markerImageWidth;marker.markerImageHeight=this.markerImageHeight;marker.markerPopupBgColor=this.markerPopupBgColor;marker.popupId=(layer)?layer.name+"_popup":"marker_"+(new Date()).getTime()+"_popup";if(!mobileNavigator){marker.events.registerPriority("mousemove",marker,mouseOver);marker.events.registerPriority("mouseout",marker,mouseOut)}else{marker.popupShown=false;marker.mouseOut=mouseOut;marker.mouseOver=mouseOver;function handlePopup(evt){if(this.popupShown){this.mouseOut(evt);this.popupShown=false}else{this.mouseOver(evt);this.popupShown=true}}function closePopup(evt){if(this.popupShown){this.mouseOut(evt);this.popupShown=false}}marker.closePopup=closePopup;marker.events.registerPriority("touchstart",marker,handlePopup);this.map.events.registerPriority("touchstart",marker,marker.closePopup);marker.destroy=function(){if(this.map.popups){for(var index=0,popupLen=this.map.popups.length;index<popupLen;index++){if(this.map.popups[index].id==this.popupId){this.map.removePopup(this.map.popups[index]);break}}}this.map.events.unregister("touchstart",this,this.closePopup);this.erase();this.map=null;this.events.destroy();this.events=null;if(this.icon!=null){this.icon.destroy();this.icon=null}}}}return marker};var _showTooltipControl=null;facadeVariables.capaTrafico=((options.facadeLocalOptions!=null)&&(options.facadeLocalOptions!=undefined)&&(options.facadeLocalOptions.capaTrafico!=null)&&(options.facadeLocalOptions.capaTrafico!=undefined))?options.facadeLocalOptions.capaTrafico:null;if(facadeVariables.capaTrafico!=null){facadeVariables.capaTrafico.moveTo=function(bounds,zoomChanged,dragging){OpenLayers.Layer.prototype.moveTo.apply(this,arguments);var coordSysUnchanged=true;if(!dragging){this.renderer.root.style.visibility="hidden";this.div.style.left=-parseInt(this.map.layerContainerDiv.style.left)+"px";this.div.style.top=-parseInt(this.map.layerContainerDiv.style.top)+"px";var extent=this.map.getExtent();coordSysUnchanged=this.renderer.setExtent(extent,zoomChanged);this.renderer.root.style.visibility="visible";if(navigator.userAgent.toLowerCase().indexOf("gecko")!=-1){this.div.scrollLeft=this.div.scrollLeft}if(!zoomChanged&&coordSysUnchanged){var feature;for(var i in this.unrenderedFeatures){feature=this.unrenderedFeatures[i];this.drawFeature(feature)}}}var resolution=this.map.getResolution();if(!this.drawn||zoomChanged||!coordSysUnchanged){this.drawn=true;if(zoomChanged){if(this.loadedAndVisible){return}else{this.loadedAndVisible=true}}var feature;for(var i=0,len=this.features.length;i<len;i++){this.renderer.locked=(i!==(len-1));feature=this.features[i];this.drawFeature(feature)}}}}facadeVariables.traficoTiempoActualizacion=300000;facadeVariables.traficoTimeOutHandler=null;facadeVariables.trafficDataLoadStopped=false;facadeVariables.traficoLoadedOnce=false;facadeVariables.currentTrafficRequest=null;facadeVariables.currentTrafficStateRequest=null;facadeVariables.currentTrafficTramosRequest=null;facadeVariables.tramos=null;facadeVariables.estadoTramos=null;facadeVariables.mapDestroyed=false;OpenLayers.Util.modifyDOMElement=function(element,id,px,sz,position,border,overflow,opacity){if(id){element.id=id}if(px){element.style.left=px.x+"px";element.style.top=px.y+"px"}try{if(sz){element.style.width=sz.w+"px";element.style.height=sz.h+"px"}}catch(e){}if(position){element.style.position=position}if(border){element.style.border=border}if(overflow){element.style.overflow=overflow}if(opacity){element.style.opacity=opacity;element.style.filter="alpha(opacity="+(opacity*100)+")"}};function _validateJSON(file){try{var jsonParser=new OpenLayers.Format.JSON();var content=file;if(content.indexOf("'")!=-1){content=file.replace(/'/g,'"')}var obj=jsonParser.read(content);if(obj==null){return false}var evalFile=eval("("+content+")");if((evalFile.layers==null)||(evalFile.layers==undefined)){return false}return true}catch(e){return false}}function _idToString(id){var string="";if(id&&(id[0]!=null)){string=id[0];for(var i=1,l=id.length;i<l;i++){string+="_"+id[i]}}return string}function _addChildList(parent,childDataList,hierarchyName,id){for(var indexChildLayer=childDataList.length-1;indexChildLayer>=0;indexChildLayer--){var newId=id.concat([indexChildLayer]);if((childDataList[indexChildLayer].childs!=null)&&(childDataList[indexChildLayer].childs!=undefined)){var layer=new OpenLayers.Layer.IAAA_GenericVector(childDataList[indexChildLayer].title,{layerId:_idToString(newId),visibility:false,hierarchy:((hierarchyName!="")?hierarchyName+"-":"")+childDataList[indexChildLayer].title});parent.addLayer(layer,false);_addChildList(layer,childDataList[indexChildLayer].childs,((hierarchyName!="")?hierarchyName+"-":"")+childDataList[indexChildLayer].title,newId)}else{_addPoiLayer(parent,childDataList[indexChildLayer],hierarchyName,newId)}}}function _addPoiLayer(parent,data,hierarchyName,id,jsonData,forcePriority,layerOptions){layerOptions=((layerOptions!=undefined)&&(layerOptions!=null))?layerOptions:null;jsonData=((jsonData!=undefined)&&(jsonData!=null))?jsonData:null;var requestParameters=null;var url=null;if(data&&data.url){var ind=data.url.indexOf("?");var paramsUrl={};url=(ind>-1)?data.url.substring(0,ind):data.url;var params=data.url.substring(ind+1,data.url.length).split("&");for(var i=0,l=params.length;i<l;i++){var nameValue=params[i].split("=");if(nameValue.length==2){paramsUrl[nameValue[0]]=(!useServlet)?parseParamValue(nameValue[1]):nameValue[1]}}if(useServlet){requestParameters={urlFile:processURL(url,"http"),outputType:1,encodeQuery:"true"};for(var i in paramsUrl){requestParameters[i]=paramsUrl[i]}}else{requestParameters=paramsUrl}}var geoJSONParser=new OpenLayers.Format.GeoJSON();geoJSONParser.forcePriority=forcePriority;if(url!=null){geoJSONParser.hostUrl=url.substring(0,(url.substring(7,url.length).indexOf("/")+7))}geoJSONParser.parseFeature=function(obj){var feature,geometry,attributes,readStyle,bbox;attributes=(obj.properties)?obj.properties:{};readStyle=((obj.properties!=undefined)&&(obj.properties!=null)&&(obj.properties.style!=undefined)&&(obj.properties.style!=undefined))?obj.properties.style:null;if((attributes.icon==null)||(attributes.icon==undefined)){attributes.icon=null}if((attributes.title==null)||(attributes.title==undefined)){attributes.title="Sin_nombre"}if((this.forcePriority!=null)&&(this.forcePriority!=undefined)){attributes.priority=this.forcePriority}else{if((attributes.priority==null)||(attributes.priority==undefined)){attributes.priority=0}else{if((attributes.priority!=0)&&(attributes.priority!=1)&&(attributes.priority!=2)){attributes.priority=0}}}bbox=(obj.geometry&&obj.geometry.bbox)||obj.bbox;if((obj.geometry==null)||(obj.geometry==undefined)){OpenLayers.IAAA_Utils.report("error","[ERROR] No se ha definido una geometria para la feature");return null}else{try{geometry=this.parseGeometry(obj.geometry)}catch(err){OpenLayers.IAAA_Utils.report("error","[ERROR] Al parsear geometria de una feature");return null}}var style=null;var color,scale;if(geometry.CLASS_NAME=="OpenLayers.Geometry.Point"){var urlProtocol=(window.location.protocol+"");var usingDefaultIcon=false;if((attributes.icon==null)&&(readStyle!=null)&&(readStyle.externalGraphic!=null)&&(readStyle.externalGraphic!=undefined)){attributes.icon=readStyle.externalGraphic;if((attributes.icon.toLowerCase().slice(0,4)!="http")&&(attributes.icon.toLowerCase().slice(0,2)!="//")){if((this.hostUrl!=null)&&(this.hostUrl!=undefined)){attributes.icon=this.hostUrl+attributes.icon}}attributes.icon=processURL(attributes.icon,urlProtocol.slice(0,urlProtocol.length-1))}else{if(attributes.icon==null){usingDefaultIcon=true;attributes.icon=processURL(getGraphicLibFolder()+defaultPointIcon,urlProtocol.slice(0,urlProtocol.length-1))}else{attributes.icon=processURL(attributes.icon,urlProtocol.slice(0,urlProtocol.length-1))}}var styleGraphicWidth=defaultIconWidth;var styleGraphicHeight=defaultIconHeight;if(attributes&&(attributes.getDimensionsFromStyle==true)&&(readStyle!=null)&&(readStyle.graphicWidth!=null)&&(readStyle.graphicHeight!=null)){styleGraphicWidth=readStyle.graphicWidth;styleGraphicHeight=readStyle.graphicHeight}style={externalGraphic:attributes.icon,originalGraphicWidth:(readStyle!=null)?readStyle.graphicWidth:(!usingDefaultIcon)?20:defaultPointIconWidth,originalGraphicHeight:(readStyle!=null)?readStyle.graphicHeight:(!usingDefaultIcon)?20:defaultPointIconHeight,graphicWidth:styleGraphicWidth,graphicHeight:styleGraphicHeight};if(readStyle&&readStyle.poisIconsWidths){style.poisIconsWidths=readStyle.poisIconsWidths}if(readStyle&&readStyle.poisIconsHeights){style.poisIconsHeights=readStyle.poisIconsHeights}if((attributes.description==null)||(attributes.description==undefined)){if((attributes.maptip!=null)&&(attributes.maptip!=undefined)){attributes.description=attributes.maptip}else{attributes.description=null}}}else{if((geometry.CLASS_NAME=="OpenLayers.Geometry.LineString")&&(attributes[carrilesBiciSelectorParameter]!=null)&&(attributes[carrilesBiciSelectorParameter]!=undefined)){color=carrilesBiciStyle[attributes[carrilesBiciSelectorParameter]]?carrilesBiciStyle[attributes[carrilesBiciSelectorParameter]].lineColor:null;scale=facade.map.getActualScale();lineWidth=null;strokeDashstyle="solid";if(carrilesBiciStyle[attributes[carrilesBiciSelectorParameter]]){if(carrilesBiciStyle[attributes[carrilesBiciSelectorParameter]].lineWidth){attributes.lineWidth=carrilesBiciStyle[attributes[carrilesBiciSelectorParameter]].lineWidth;for(var ind in carrilesBiciStyle[attributes[carrilesBiciSelectorParameter]].lineWidth){if(ind>scale){lineWidth=carrilesBiciStyle[attributes[carrilesBiciSelectorParameter]].lineWidth[ind]}}}if(carrilesBiciStyle[attributes[carrilesBiciSelectorParameter]].strokeDashstyle){attributes.strokeDashstyle=carrilesBiciStyle[attributes[carrilesBiciSelectorParameter]].strokeDashstyle;for(var ind in carrilesBiciStyle[attributes[carrilesBiciSelectorParameter]].strokeDashstyle){if(ind>scale){strokeDashstyle=carrilesBiciStyle[attributes[carrilesBiciSelectorParameter]].strokeDashstyle[ind]}}}}style={fillColor:color,fillOpacity:0.4,hoverFillColor:"white",hoverFillOpacity:0.8,strokeColor:color,strokeOpacity:1,strokeWidth:lineWidth,strokeLinecap:"round",strokeDashstyle:strokeDashstyle,hoverStrokeColor:"red",hoverStrokeOpacity:1,hoverStrokeWidth:0.2,pointRadius:6,hoverPointRadius:1,hoverPointUnit:"%",pointerEvents:"visiblePainted",cursor:"inherit"}}else{if(readStyle!=null){style=readStyle}else{style={strokeColor:"#bf402a",fillColor:"#bf402a",fillOpacity:0.45,strokeOpacity:0.75,strokeWidth:2}}if((attributes.description==null)||(attributes.description==undefined)){if((attributes.maptip!=null)&&(attributes.maptip!=undefined)){attributes.description=attributes.maptip;style.cursor="pointer"}else{attributes.description=null}}}}if(attributes.link){style.cursor="pointer";if(mobileNavigator&&(attributes.title=="Sin_nombre")){attributes.title=messages.ViewDetail}}feature=new OpenLayers.Feature.Vector(geometry,attributes,style);if(bbox){feature.bounds=OpenLayers.Bounds.fromArray(bbox)}if(obj.geometry&&obj.geometry.coordinates){feature.attributes.originalCoordinates=obj.geometry.coordinates}if(obj.id){feature.fid=obj.id}return feature};geoJSONParser.read=function(json,type,filter){var layerName="";if((this.layer!=undefined)&&(this.layer!=null)){if((this.layer.name!=undefined)&&(this.layer.name!=null)){layerName=this.layer.name}else{if((this.layer.title!=undefined)&&(this.layer.title!=null)){layerName=this.layer.title}}}type=(type)?type:"FeatureCollection";var results=null;var obj=null;if(typeof json=="string"){obj=OpenLayers.Format.JSON.prototype.read.apply(this,[json,filter])}else{obj=json}if(!obj){OpenLayers.IAAA_Utils.report("error",((layerName!="")?layerName+" - ":"")+"Bad JSON: "+json);return null}else{if(typeof(obj.type)!="string"){OpenLayers.IAAA_Utils.report("error",((layerName!="")?layerName+" - ":"")+"Bad GeoJSON - no type: "+json);return null}}var legendInfo=new Object();var projection="EPSG:4326";var layerEditable=true;if(obj.crs&&obj.crs.type){if(obj.crs.type=="name"){projection=obj.crs.properties.name}else{if(obj.crs.type.toLowerCase()=="epsg"){projection="EPSG:"+obj.crs.properties.code}}}var layerIcon=null;if((obj.properties==null)&&(obj.properties==undefined)){legendInfo.description=null;legendInfo.link=null;legendInfo.name=null;legendInfo.icon=null}else{layerIcon=obj.properties.icon;legendInfo.description=((obj.properties.description!=undefined)&&(obj.properties.description!=null))?obj.properties.description:null;legendInfo.link=((obj.properties.link!=undefined)&&(obj.properties.link!=null))?obj.properties.link:null;legendInfo.name=((obj.properties.title!=undefined)&&(obj.properties.title!=null))?obj.properties.title:null;legendInfo.icon=((obj.properties.icon!=undefined)&&(obj.properties.icon!=null))?obj.properties.icon:null}var featuresParsed=new Array();var errorFeatureVector=new Array();var containsPoints=false;var feature,newFeature,color,lineWidth,strokeDashstyle,style;var scale=facade.map.getActualScale();var results;var featuresExtent=null;if(this.isValidType(obj,type)){if(obj.crs&&obj.crs.type&&obj.crs.properties){if(obj.crs.type.toLowerCase()=="name"){this.layer.geomProjection=obj.crs.properties.name}else{if(obj.crs.type.toLowerCase()=="epsg"){this.layer.geomProjection="EPSG:"+obj.crs.properties.code}}}switch(type){case"Geometry":try{results=this.parseGeometry(obj);if(results!=null){featuresExtent=results.getBounds()}}catch(err){OpenLayers.IAAA_Utils.report("error",err)}break;case"Feature":try{if((layerIcon!=null)&&obj.properties&&(obj.properties.icon==null)&&(obj.properties.style==null)){obj.properties.icon=layerIcon}results=this.parseFeature(obj);results.type="Feature";if((results!=null)&&(results.lonlat!=null)){featuresExtent=new OpenLayers.Bounds(results.lonlat.lon,results.lonlat.lat,results.lonlat.lon,results.lonlat.lat)}}catch(err){OpenLayers.IAAA_Utils.report("error",err)}break;case"FeatureCollection":results=new Array();switch(obj.type){case"Feature":try{if((layerIcon!=null)&&obj.properties&&(obj.properties.icon==null)&&(obj.properties.style==null)){obj.properties.icon=layerIcon}feature=this.parseFeature(obj);results.push(feature);if((feature!=null)&&(feature.lonlat!=null)){if(featuresExtent==null){featuresExtent=new OpenLayers.Bounds(feature.lonlat.lon,feature.lonlat.lat,feature.lonlat.lon,feature.lonlat.lat)}else{featuresExtent.extend(new OpenLayers.Bounds(feature.lonlat.lon,feature.lonlat.lat,feature.lonlat.lon,feature.lonlat.lat))}}}catch(err){results=null;OpenLayers.IAAA_Utils.report("error",err)}break;case"FeatureCollection":for(var i=0,len=obj.features.length;i<len;++i){try{if((layerIcon!=null)&&obj.features[i].properties&&(obj.features[i].properties.icon==null)&&(obj.features[i].properties.style==null)){obj.features[i].properties.icon=layerIcon}feature=this.parseFeature(obj.features[i]);if(feature!=null){results.push(feature);if(feature.geometry&&feature.geometry.getBounds()){if(featuresExtent==null){featuresExtent=new OpenLayers.Bounds(feature.geometry.getBounds().left,feature.geometry.getBounds().bottom,feature.geometry.getBounds().right,feature.geometry.getBounds().top)}else{featuresExtent.extend(new OpenLayers.Bounds(feature.geometry.getBounds().left,feature.geometry.getBounds().bottom,feature.geometry.getBounds().right,feature.geometry.getBounds().top))}}else{if(feature.lonlat!=null){if(featuresExtent==null){featuresExtent=new OpenLayers.Bounds(feature.lonlat.lon,feature.lonlat.lat,feature.lonlat.lon,feature.lonlat.lat)}else{featuresExtent.extend(new OpenLayers.Bounds(feature.lonlat.lon,feature.lonlat.lat,feature.lonlat.lon,feature.lonlat.lat))}}}if((feature.CLASS_NAME=="OpenLayers.Feature.Vector")&&feature.geometry&&(feature.geometry.CLASS_NAME=="OpenLayers.Geometry.LineString")&&(feature.attributes[carrilesBiciSelectorParameter]!=undefined)&&(feature.attributes[carrilesBiciSelectorParameter]!=null)&&carrilesBiciStyle[feature.attributes[carrilesBiciSelectorParameter]].middleLine){color=carrilesBiciStyle[feature.attributes[carrilesBiciSelectorParameter]].middleLine.lineColor;lineWidth=null;strokeDashstyle="solid";if(carrilesBiciStyle[feature.attributes[carrilesBiciSelectorParameter]].middleLine.lineWidth){for(var ind in carrilesBiciStyle[feature.attributes[carrilesBiciSelectorParameter]].middleLine.lineWidth){if(ind>scale){lineWidth=carrilesBiciStyle[feature.attributes[carrilesBiciSelectorParameter]].middleLine.lineWidth[ind]}}}if(carrilesBiciStyle[feature.attributes[carrilesBiciSelectorParameter]].middleLine.strokeDashstyle){for(var ind in carrilesBiciStyle[feature.attributes[carrilesBiciSelectorParameter]].middleLine.strokeDashstyle){if(ind>scale){strokeDashstyle=carrilesBiciStyle[feature.attributes[carrilesBiciSelectorParameter]].middleLine.strokeDashstyle[ind]}}}style={fillColor:color,fillOpacity:0.4,hoverFillColor:"white",hoverFillOpacity:0.8,strokeColor:color,strokeOpacity:1,strokeWidth:lineWidth,strokeLinecap:"round",strokeDashstyle:strokeDashstyle,hoverStrokeColor:"red",hoverStrokeOpacity:1,hoverStrokeWidth:0.2,pointRadius:6,hoverPointRadius:1,hoverPointUnit:"%",pointerEvents:"visiblePainted",cursor:"inherit"};newFeature=new OpenLayers.Feature.Vector((obj.features[i].geometry)?this.parseGeometry(obj.features[i].geometry):feature.geometry.clone(),{lineWidth:(carrilesBiciStyle[feature.attributes[carrilesBiciSelectorParameter]]&&carrilesBiciStyle[feature.attributes[carrilesBiciSelectorParameter]].middleLine)?carrilesBiciStyle[feature.attributes[carrilesBiciSelectorParameter]].middleLine.lineWidth:null,strokeDashstyle:(carrilesBiciStyle[feature.attributes[carrilesBiciSelectorParameter]]&&carrilesBiciStyle[feature.attributes[carrilesBiciSelectorParameter]].middleLine)?carrilesBiciStyle[feature.attributes[carrilesBiciSelectorParameter]].middleLine.strokeDashstyle:null},style);results.push(newFeature)}if((!containsPoints)&&(feature.CLASS_NAME=="OpenLayers.Feature.Vector")&&feature.geometry&&((feature.geometry.CLASS_NAME=="OpenLayers.Geometry.Point")||(feature.geometry.CLASS_NAME=="OpenLayers.Geometry.Polygon")||(feature.geometry.CLASS_NAME=="OpenLayers.Geometry.LineString"))){containsPoints=true}}else{errorFeatureVector.push(i)}}catch(err){results=null;OpenLayers.IAAA_Utils.report("error",err)}}break;default:try{var geom=this.parseGeometry(obj);results.push(new OpenLayers.Feature.Vector(geom))}catch(err){results=null;OpenLayers.IAAA_Utils.report("error",err)}}break;default:results=null;break}}if(results==null){OpenLayers.IAAA_Utils.report("log",((layerName!="")?messages.errorLoadingJSONOf+layerName:messages.errorLoadingJSON))}var respResults=new Object();var featuresString="";if(!containsPoints){var indexFeaturesBegin=json.indexOf("features");var indexFeaturesEnd=json.substring(indexFeaturesBegin).search(/}\s*\n*]/i)+indexFeaturesBegin+1;featuresString='{"'+json.substring(indexFeaturesBegin,indexFeaturesEnd)+"] }"}respResults.results=results;respResults.legendInfo=legendInfo;respResults.containsPoints=containsPoints;respResults.errors=errorFeatureVector;respResults.featuresString=featuresString;respResults.featuresExtent=featuresExtent;OpenLayers.IAAA_Utils.json=obj;if(respResults.featuresExtent){featuresExtent.projection=projection}return respResults};var fixedStrategy=new OpenLayers.Strategy.Fixed();fixedStrategy.load=function(options){var layer=this.layer;if((layer.protocol!=null)&&(layer.protocol.url!=null)){layer.events.triggerEvent("loadstart");layer.protocol.read(OpenLayers.Util.applyDefaults({callback:OpenLayers.Function.bind(this.merge,this,layer.map.getProjectionObject()),filter:layer.filter},options))}else{if(layer.jsonInfo&&layer.protocol){var info=layer.protocol.parseFeatures({responseText:layer.jsonInfo});this.merge(layer.map.projection,{features:info})}}layer.events.un({visibilitychanged:this.load,scope:this})};fixedStrategy.merge=function(mapProjection,resp){if(!facadeVariables.mapDestroyed){this.layer.destroyFeatures();var features;if(resp.features!=null){features=resp.features.results;if(resp.features.errors.length){OpenLayers.IAAA_Utils.report("log",'[ERROR]: Fichero JSON de la capa "'+this.layer.title+'": ');for(var indErr=0;indErr<resp.features.errors.length;indErr++){OpenLayers.IAAA_Utils.report("log",'    Feature "n '+resp.features.errors[indErr]+'" mal construida.')}}}else{OpenLayers.IAAA_Utils.report("log",'[ERROR]: Fichero JSON de la capa "'+this.layer.title+'" mal construido');features=null}facadeVariables.waitingToLoad--;if(features){this.layer.containsPoints=resp.features.containsPoints;facadeVariables.garbageCollectionList.push(this.layer);this.layer.featuresTextFormat=resp.features.featuresString;if(resp.features.legendInfo.name!=null){if((typeof resp.features.legendInfo.name).toLowerCase()!="string"){for(var nameIndex in resp.features.legendInfo.name){if((typeof resp.features.legendInfo.name[nameIndex]).toLowerCase()!="string"){OpenLayers.IAAA_Utils.report("log",'[ERROR]: Fichero JSON de la capa "'+this.layer.title+'" mal construido');facadeVariables.layerLegendInfo[this.layer.hierarchy].name=null;break}}facadeVariables.layerLegendInfo[this.layer.hierarchy].name=resp.features.legendInfo.name}else{facadeVariables.layerLegendInfo[this.layer.hierarchy].name=resp.features.legendInfo.name}}else{facadeVariables.layerLegendInfo[this.layer.hierarchy].name=this.layer.title}if(resp.features.legendInfo.icon!=null){if((typeof resp.features.legendInfo.icon).toLowerCase()!="string"){for(var iconIndex in resp.features.legendInfo.icon){if((typeof resp.features.legendInfo.icon[iconIndex]).toLowerCase()!="string"){OpenLayers.IAAA_Utils.report("log",'[ERROR]: Fichero JSON de la capa "'+this.layer.title+'" mal construido');facadeVariables.layerLegendInfo[this.layer.hierarchy].icon=null;break}}facadeVariables.layerLegendInfo[this.layer.hierarchy].icon=resp.features.legendInfo.icon}else{facadeVariables.layerLegendInfo[this.layer.hierarchy].icon=resp.features.legendInfo.icon}}else{facadeVariables.layerLegendInfo[this.layer.hierarchy].icon=null}facadeVariables.layerLegendInfo[this.layer.hierarchy].description=((resp.features.legendInfo.description!=null)&&((typeof resp.features.legendInfo.description).toLowerCase()=="string"))?resp.features.legendInfo.description:null;facadeVariables.layerLegendInfo[this.layer.hierarchy].link=((resp.features.legendInfo.link!=null)&&((typeof resp.features.legendInfo.link).toLowerCase()=="string"))?resp.features.legendInfo.link:null;if((facadeVariables.layerLegendInfo[this.layer.hierarchy].icon==null)&&(facadeVariables.layerLegendInfo[this.layer.hierarchy].description==null)&&(facadeVariables.layerLegendInfo[this.layer.hierarchy].link==null)){OpenLayers.IAAA_Utils.report("log",'[INFO]: Fichero JSON de la capa "'+this.layer.hierarchy+'":');OpenLayers.IAAA_Utils.report("log","		No tiene definida informacin de leyenda o est incompleta")}if((facadeVariables.layerLegendInfo[this.layer.hierarchy].name!=null)&&(facadeVariables.layerLegendInfo[this.layer.hierarchy].icon!=null)){var tipoName=(typeof facadeVariables.layerLegendInfo[this.layer.hierarchy].name).toLowerCase();if((tipoName=="object")&&(facadeVariables.layerLegendInfo[this.layer.hierarchy].name.length!=undefined)&&(facadeVariables.layerLegendInfo[this.layer.hierarchy].name.length!=null)){tipoName="array"}var tipoIcon=(typeof facadeVariables.layerLegendInfo[this.layer.hierarchy].icon).toLowerCase();if((tipoIcon=="object")&&(facadeVariables.layerLegendInfo[this.layer.hierarchy].icon.length!=undefined)&&(facadeVariables.layerLegendInfo[this.layer.hierarchy].icon.length!=null)){tipoIcon="array"}switch(tipoIcon){case"string":if(tipoName=="array"){if(facadeVariables.layerLegendInfo[this.layer.hierarchy].name.length){var valueTemp=facadeVariables.layerLegendInfo[this.layer.hierarchy].icon;facadeVariables.layerLegendInfo[this.layer.hierarchy].icon=new Array(facadeVariables.layerLegendInfo[this.layer.hierarchy].name.length);for(var indName=0;indName<facadeVariables.layerLegendInfo[this.layer.hierarchy].name.length;indName++){facadeVariables.layerLegendInfo[this.layer.hierarchy].icon[indName]=valueTemp}}else{facadeVariables.layerLegendInfo[this.layer.hierarchy].name=null;facadeVariables.layerLegendInfo[this.layer.hierarchy].icon=null}}else{if(tipoName!="string"){facadeVariables.layerLegendInfo[this.layer.hierarchy].name=null;facadeVariables.layerLegendInfo[this.layer.hierarchy].icon=null}}break;case"array":if(tipoName=="string"){if(facadeVariables.layerLegendInfo[this.layer.hierarchy].name.length){var valueTemp=facadeVariables.layerLegendInfo[this.layer.hierarchy].icon[0];if(valueTemp!=null){facadeVariables.layerLegendInfo[this.layer.hierarchy].icon=valueTemp}else{facadeVariables.layerLegendInfo[this.layer.hierarchy].name=null;facadeVariables.layerLegendInfo[this.layer.hierarchy].icon=null}}else{facadeVariables.layerLegendInfo[this.layer.hierarchy].name=null;facadeVariables.layerLegendInfo[this.layer.hierarchy].icon=null}}else{if(tipoName=="array"){if(facadeVariables.layerLegendInfo[this.layer.hierarchy].name.length){if(facadeVariables.layerLegendInfo[this.layer.hierarchy].name.length>facadeVariables.layerLegendInfo[this.layer.hierarchy].icon.length){for(var ii=0;ii<facadeVariables.layerLegendInfo[this.layer.hierarchy].name.length;ii++){facadeVariables.layerLegendInfo[this.layer.hierarchy].icon.push(facadeVariables.layerLegendInfo[this.layer.hierarchy].icon[0])}}else{if(facadeVariables.layerLegendInfo[this.layer.hierarchy].name.length<facadeVariables.layerLegendInfo[this.layer.hierarchy].icon.length){for(var jj=facadeVariables.layerLegendInfo[this.layer.hierarchy].name.length-1;ii<facadeVariables.layerLegendInfo[this.layer.hierarchy].icon.length;ii++){facadeVariables.layerLegendInfo[this.layer.hierarchy].icon.pop()}}}}else{facadeVariables.layerLegendInfo[this.layer.hierarchy].name=null;facadeVariables.layerLegendInfo[this.layer.hierarchy].icon=null}}else{facadeVariables.layerLegendInfo[this.layer.hierarchy].name=null;facadeVariables.layerLegendInfo[this.layer.hierarchy].icon=null}}break;default:facadeVariables.layerLegendInfo[this.layer.hierarchy].name=null;facadeVariables.layerLegendInfo[this.layer.hierarchy].icon=null;break}}else{if(!facadeVariables.layerLegendInfo[this.layer.hierarchy].name){facadeVariables.layerLegendInfo[this.layer.hierarchy].name=null}if(!facadeVariables.layerLegendInfo[this.layer.hierarchy].icon){facadeVariables.layerLegendInfo[this.layer.hierarchy].icon=null}}var alreadyScaled=false;if(features.length>0){var remote=(this.layer.geomProjection?this.layer.geomProjection:this.layer.projection);var local=this.layer.map.getProjection();if((((typeof local).toLowerCase()=="object")&&!local.equals(remote))||(((typeof local).toLowerCase()=="string")&&(local!=remote))){var geom;for(var i=0,len=features.length;i<len;++i){geom=features[i].geometry;if(geom){var geomSrs=new OpenLayers.IAAA_SRSGeometry(geom,remote);geomSrs.transformSrs(local);features[i].geometry=geomSrs.geometry}}}this.layer.addFeatures(features,{initializing:true})}else{if(facadeVariables.waitingToLoad==0){this.layer.addFeatures(features,{initializing:true})}}if(resp.features.featuresExtent){this.layer.originalExtent=new OpenLayers.IAAA_Bounds(resp.features.featuresExtent.left,resp.features.featuresExtent.bottom,resp.features.featuresExtent.right,resp.features.featuresExtent.top);this.layer.originalExtent.setSrs(resp.features.featuresExtent.projection)}else{this.layer.originalExtent=null}}else{facadeVariables.layerLegendInfo[this.layer.hierarchy].name=null;facadeVariables.layerLegendInfo[this.layer.hierarchy].icon=null;facadeVariables.layerLegendInfo[this.layer.hierarchy].description=null;facadeVariables.layerLegendInfo[this.layer.hierarchy].link=null}facadeVariables.layerLegendInfo[this.layer.hierarchy].loaded=true;this.layer.alreadyLoaded=true;if((facadeVariables.waitingToLoad==0)&&(facadeVariables.centerInGeometries)){centrarMapa(null,null,null,null,null,null,true);facadeVariables.centerInGeometries=false}this.layer.events.triggerEvent("loadend")}};var legendName=((data&&data.definirCapaJSON)?"":((hierarchyName!="")?hierarchyName+"-":""))+data.title;facadeVariables.legendLayerNamesList.push(legendName);facadeVariables.layerLegendInfo[legendName]=new Object();facadeVariables.layerLegendInfo[legendName].name=null;facadeVariables.layerLegendInfo[legendName].icon=null;facadeVariables.layerLegendInfo[legendName].link=null;facadeVariables.layerLegendInfo[legendName].description=null;facadeVariables.layerLegendInfo[legendName].visibility=false;facadeVariables.layerLegendInfo[legendName].loaded=false;facadeVariables.layerLegendInfo[legendName].hierarchy=((data&&data.definirCapaJSON)?"":((hierarchyName!="")?hierarchyName+"-":""))+data.title;var protocolOptions={format:geoJSONParser,params:requestParameters};if(url!=null){protocolOptions.url=((requestParameters!=null)?((useServlet)?(getHost()+servlet):url):null)}if(typeof poisRequestHeaders=="object"){protocolOptions.headers=poisRequestHeaders}var layerProtocol=new OpenLayers.Protocol.HTTP(protocolOptions);layerProtocol.parseFeatures=function(request){if(!facadeVariables.mapDestroyed){var doc=request.responseXML;if(!doc||!doc.documentElement){doc=request.responseText}if(!doc||doc.length<=0){return null}return this.format.read(doc)}};var scaleIcons=scalePOIs;if(layerOptions){if(layerOptions.scaleIcon!=undefined){scaleIcons=layerOptions.scaleIcon}}var singlePoiLayer=new OpenLayers.Layer.IAAA_GenericVector(data.title,{layerId:_idToString(id),modifiable:true,visibility:false,projection:this.map.projection,additionalInfo:true,protocol:layerProtocol,strategies:[fixedStrategy],popupAnchorSize:poisClientStyle.popupAnchorSize,popupAnchorOffset:poisClientStyle.popupAnchorOffset,scaleIcon:scaleIcons,showLoadingIcon:true,showLoadingOnDrawOnce:true,hierarchy:((data&&data.definirCapaJSON)?"":((hierarchyName!="")?hierarchyName+"-":""))+data.title});singlePoiLayer.jsonInfo=jsonData;geoJSONParser.layer=singlePoiLayer;if((data.logoPosition!=undefined)&&(data.logoPosition!=null)){singlePoiLayer.logoPosition=parseInt(data.logoPosition)}else{singlePoiLayer.logoPosition=defaultLogoPosition}singlePoiLayer.alreadyLoaded=false;singlePoiLayer.changeFeaturesSize=function(){if(!this.map){return}if((this.iconsScalesLimits&&(this.iconsScalesLimits.length>=2)&&this.scaleIcon)||this.lineStringVectorLayer){var currentScale=this.map.getActualScale();var height,width;if(this.iconsScalesLimits&&(this.iconsScalesLimits.length>=2)&&this.scaleIcon&&this.getTolerance){if((this.currentIconScale!=null)&&(this.currentIconScale!=undefined)&&(this.currentIconScale==currentScale)){return false}var scaleLimit0=this.iconsScalesLimits[0];var scaleLimit1=this.iconsScalesLimits[1];var newIconSize="";var height,width,realIconSize;var poisIconsHeights=poisIconsSizes;var poisIconsWidths=poisIconsSizes;var feature=this.features[0];if(feature&&feature.style.poisIconsHeights){poisIconsHeights=feature.style.poisIconsHeights}if(feature&&feature.style.poisIconsWidths){poisIconsWidths=feature.style.poisIconsWidths}height=this.getTolerance(this.map,poisIconsScalesLimits,poisIconsHeights,poisIconDefaultHeight);width=this.getTolerance(this.map,poisIconsScalesLimits,poisIconsWidths,poisIconDefaultWidth);var newIconSize=new OpenLayers.Size(width,height);if((this.currentIconSize!=null)&&(this.currentIconSize!=undefined)&&(this.currentIconSize==newIconSize)){return false}return true}else{if(this.lineStringVectorLayer){if((this.currentIconScale!=null)&&(this.currentIconScale!=undefined)&&(this.currentIconScale==currentScale)){return false}else{return true}}else{return false}}}else{return false}};singlePoiLayer.scaleFeature=function(featureIndex){if((this.features!=null)&&(this.features!=undefined)&&(this.features.length>0)&&(this.features.length>featureIndex)){this.eraseFeatures(this.features[featureIndex]);var feature=this.features[featureIndex];if(feature.attributes.dontScale){this.drawFeature(feature);return}var poisIconsHeights=poisIconsSizes;var poisIconsWidths=poisIconsSizes;if(feature.style.poisIconsHeights){poisIconsHeights=feature.style.poisIconsHeights}if(feature.style.poisIconsWidths){poisIconsWidths=feature.style.poisIconsWidths}var height=this.getTolerance(this.map,poisIconsScalesLimits,poisIconsHeights,poisIconDefaultHeight);var width=this.getTolerance(this.map,poisIconsScalesLimits,poisIconsWidths,poisIconDefaultWidth);var currentScale=this.map.getActualScale();var currentInd,index;if(feature.style&&feature.geometry&&(feature.geometry.CLASS_NAME=="OpenLayers.Geometry.Point")){if(height!=null){feature.style.graphicHeight=height}if(width!=null){feature.style.graphicWidth=width}feature.style.originalGraphicHeight=poisOriginalGraphicHeight;feature.style.originalGraphicWidth=poisOriginalGraphicWidth}else{if(feature.style&&feature.geometry&&(feature.geometry.CLASS_NAME=="OpenLayers.Geometry.LineString")&&(feature.attributes[carrilesBiciSelectorParameter]!=undefined)&&(feature.attributes[carrilesBiciSelectorParameter]!=null)){var lineWidth=null;var strokeDashstyle="solid";if(feature.attributes){currentInd=null;if(feature.attributes.lineWidth){for(var ind in feature.attributes.lineWidth){index=parseInt(ind);if(index>currentScale){if((currentInd!=null)&&(currentInd<index)){break}lineWidth=feature.attributes.lineWidth[ind];currentInd=index}}}if(feature.attributes.strokeDashstyle){currentInd=null;for(var ind in feature.attributes.strokeDashstyle){index=parseInt(ind);if(index>currentScale){if((currentInd!=null)&&(currentInd<index)){break}strokeDashstyle=feature.attributes.strokeDashstyle[ind];currentInd=index}}}}feature.style.strokeWidth=lineWidth;feature.style.strokeDashstyle=strokeDashstyle;if(feature.attributes.shadow){feature.style.strokeWidth=parseInt(feature.style.strokeWidth)+facadeVariables.capaTrafico.lineShadowWidthInc}}}}};singlePoiLayer.addFeatures=function(features,options){if(!(OpenLayers.Util.isArray(features))){features=[features]}var notify=!options||!options.silent;var notifyAdd=((options!=null)&&(options!=undefined)&&(options.notifyAdd!=null)&&(options.notifyAdd!=undefined))?options.notifyAdd:false;if(notify){var event={features:features};var ret=this.events.triggerEvent("beforefeaturesadded",event);if(ret===false){return}features=event.features}var skipAdding=((options!=null)&&(options!=undefined)&&(options.initializing!=null)&&(options.initializing!=undefined)&&(options.initializing==true));var scaleFeatures=false;if(this.scaleIcon){scaleFeatures=this.changeFeaturesSize()||this.iconsScaleChanged}if(!skipAdding){if(this.visibility){if(features.length>1){var feature;for(var i=0,len=features.length;i<len;i++){if(i!=(features.length-1)){this.renderer.locked=true}else{this.renderer.locked=false}feature=features[i];if(this.geometryType&&!(feature.geometry instanceof this.geometryType)){var throwStr=OpenLayers.i18n("componentShouldBe",{geomType:this.geometryType.prototype.CLASS_NAME});throw throwStr}this.features.push(feature);feature.layer=this;if(!feature.style&&this.style){feature.style=OpenLayers.Util.extend({},this.style)}if(mobileNavigator){if(notify||notifyAdd||(feature.attributes&&feature.attributes.priority&&(feature.attributes.priority==1))){if(this.events.triggerEvent("beforefeatureadded",{feature:feature})===false){continue}this.preFeatureInsert(feature)}}else{if(notify||notifyAdd){if(this.events.triggerEvent("beforefeatureadded",{feature:feature})===false){continue}this.preFeatureInsert(feature)}}if(scaleFeatures){this.scaleFeature(this.features.length-1)}this.drawFeature(feature);if(notify){this.events.triggerEvent("featureadded",{feature:feature});this.onFeatureInsert(feature)}}}else{if(features.length>0){this.renderer.locked=false;feature=features[0];if(this.geometryType&&!(feature.geometry instanceof this.geometryType)){var throwStr=OpenLayers.i18n("componentShouldBe",{geomType:this.geometryType.prototype.CLASS_NAME});throw throwStr}this.features.push(feature);feature.layer=this;if(!feature.style&&this.style){feature.style=OpenLayers.Util.extend({},this.style)}if(mobileNavigator){if(notify||notifyAdd||(feature.attributes&&feature.attributes.priority&&(feature.attributes.priority==1))){if(this.events.triggerEvent("beforefeatureadded",{feature:feature})===false){}this.preFeatureInsert(feature)}}else{if(notify||notifyAdd){if(this.events.triggerEvent("beforefeatureadded",{feature:feature})===false){}this.preFeatureInsert(feature)}}if(scaleFeatures){this.scaleFeature(this.features.length-1)}this.drawFeature(feature);if(notify){this.events.triggerEvent("featureadded",{feature:feature});this.onFeatureInsert(feature)}}}}else{if(features.length>1){for(var i=0,len=features.length;i<len;i++){this.features.push(features[i]);this.features[this.features.length-1].layer=this}}else{if(features.length>0){this.features.push(features[0]);this.features[this.features.length-1].layer=this}}}}if(notify){this.events.triggerEvent("featuresadded",{features:features,layerLoading:this,notifyEvent:skipAdding})}};singlePoiLayer.moveTo=function(bounds,zoomChanged,dragging){OpenLayers.Layer.prototype.moveTo.apply(this,arguments);var coordSysUnchanged=true;if(!dragging){this.renderer.root.style.visibility="hidden";this.div.style.left=-parseInt(this.map.layerContainerDiv.style.left)+"px";this.div.style.top=-parseInt(this.map.layerContainerDiv.style.top)+"px";var extent=this.map.getExtent();coordSysUnchanged=this.renderer.setExtent(extent,zoomChanged);this.renderer.root.style.visibility="visible";if(navigator.userAgent.toLowerCase().indexOf("gecko")!=-1){this.div.scrollLeft=this.div.scrollLeft}if(!zoomChanged&&coordSysUnchanged){var feature;for(var i in this.unrenderedFeatures){feature=this.unrenderedFeatures[i];this.drawFeature(feature)}}}var scaleFeatures=false;var resolution=this.map.getResolution();if(!this.drawn||zoomChanged||!coordSysUnchanged){this.drawn=true;if(zoomChanged){if(this.scaleIcon){scaleFeatures=this.changeFeaturesSize();this.iconsScaleChanged=scaleFeatures}else{this.iconsScaleChanged=false}}else{this.iconsScaleChanged=false}var feature;if(navigator.appName!="Microsoft Internet Explorer"){for(var i=0,len=this.features.length;i<len;i++){this.renderer.locked=(i!==(len-1));feature=this.features[i];if(scaleFeatures){this.scaleFeature(i)}this.drawFeature(feature)}}else{if(this.features){this.recursiveFeatureDraw(this.features.length-1,scaleFeatures)}}}};singlePoiLayer.recursiveFeatureDraw=function(index,scale){if(this.features&&(this.features.length>0)&&(index<this.features.length)){if(scale){this.scaleFeature(index)}if(index!=0){this.recursiveFeatureDraw(index-1,scale)}this.renderer.locked=(index!==(this.features.length-1));feature=this.features[index];this.drawFeature(feature)}};singlePoiLayer.clone=function(obj,cloneFeatures,optionalParams){function generateFeaturePrintInfo(feature,mapResolution,mapExtent){cont=printParamsCount+obj.printInfo.postParamsCont;var pxX,pxY;if((feature.geometry.CLASS_NAME=="OpenLayers.Geometry.Point")&&(!feature.geometry.parent)){pxX=Math.round((1/mapResolution*(feature.geometry.x-mapExtent.left)));pxY=Math.round((1/mapResolution*(mapExtent.top-feature.geometry.y)));if((pxX>=0)&&(pxX<=printMapSize.width)&&(pxY>=0)&&(pxY<=printMapSize.height)){if(feature.style.externalGraphic){obj.printInfo.postParams+="&imageType_"+cont+"=MAP_LAYER_IMAGE_SYMBOL";obj.printInfo.postParams+="&imageURL_"+cont+"="+processURL(feature.style.externalGraphic,"http");width=pxX-(feature.style.graphicWidth/2);height=pxY-(feature.style.graphicHeight/2);obj.printInfo.postParams+="&imagePixelX_"+cont+"="+Math.round(width);obj.printInfo.postParams+="&imagePixelY_"+cont+"="+Math.round(height);obj.printInfo.postParams+="&imageOriginalWidth_"+cont+"="+(feature.style.originalGraphicWidth?feature.style.originalGraphicWidth:feature.style.graphicWidth);obj.printInfo.postParams+="&imageOriginalHeight_"+cont+"="+(feature.style.originalGraphicHeight?feature.style.originalGraphicHeight:feature.style.graphicHeight);obj.printInfo.postParams+="&imagePrintWidth_"+cont+"="+feature.style.graphicWidth;obj.printInfo.postParams+="&imagePrintHeight_"+cont+"="+feature.style.graphicHeight}else{obj.printInfo.postParams+="&geometryType_"+cont+"=GEOMETRY_POINT";if(feature.style.graphicWidth&&feature.style.graphicHeight){obj.printInfo.postParams+="&image_Width_"+cont+"="+feature.style.graphicWidth;obj.printInfo.postParams+="&image_Height_"+cont+"="+feature.style.graphicHeight}else{if(feature.style.pointRadius){obj.printInfo.postParams+="&image_Width_"+cont+"="+parseInt(feature.style.pointRadius)*2;obj.printInfo.postParams+="&image_Height_"+cont+"="+parseInt(feature.style.pointRadius)*2}else{obj.printInfo.postParams+="&image_Width_"+cont+"=0";obj.printInfo.postParams+="&image_Height_"+cont+"=0"}}if(feature.style.printLabel){obj.printInfo.postParams+="&label_"+cont+"="+feature.style.printLabel;obj.printInfo.postParams+="&labelColor_"+cont+"="+feature.style.fontColor;obj.printInfo.postParams+="&labelFontFamily_"+cont+"="+feature.style.fontFamily;obj.printInfo.postParams+="&labelFonSize_"+cont+"="+feature.style.fontSize}obj.printInfo.postParams+="&imagePixel_X_"+cont+"="+pxX;obj.printInfo.postParams+="&imagePixel_Y_"+cont+"="+pxY;color=feature.style.fillColor;if(color.substring(0,3).toUpperCase()=="RGB"){strAux=color.substring(4,color.length-1);primaryColorVector=strAux.split(",");color=RGB2HTML(primaryColorVector[0],primaryColorVector[1],primaryColorVector[2])}obj.printInfo.postParams+="&imagePixelColor_"+cont+"="+color;var opacity=feature.style.fillOpacity*256;obj.printInfo.postParams+="&imagePixelOpacity_"+cont+"="+Math.round(opacity);obj.printInfo.postParams+="&imagePixelThickness_"+cont+"="+feature.style.strokeWidth;obj.printInfo.postParams+="&imageBorderColor_"+cont+"="+feature.style.strokeColor}obj.printInfo.postParamsCont++}}else{if(feature.geometry.CLASS_NAME=="OpenLayers.Geometry.LineString"){obj.printInfo.postParams+="&geometryType_"+cont+"=GEOMETRY_LINE";obj.printInfo.postParams+="&imagePixelLength_"+cont+"="+feature.geometry.components.length;obj.printInfo.postParams+="&imagePixelColor_"+cont+"="+feature.style.fillColor;obj.printInfo.postParams+="&imagePixelThickness_"+cont+"="+feature.style.strokeWidth;if((feature.style.strokeDashstyle!=null)&&(feature.style.strokeDashstyle!=undefined)){if(feature.style.strokeDashstyle.toUpperCase()=="DASH"){obj.printInfo.postParams+="&imageLineDash_"+cont+"=10"}else{if(feature.style.strokeDashstyle.toUpperCase()=="DOT"){obj.printInfo.postParams+="&imageLineDash_"+cont+"="+feature.style.strokeWidth+"_10"}}}for(var temp=0,componentsLength=feature.geometry.components.length;temp<componentsLength;temp++){component=feature.geometry.components[temp];pxX=Math.round((1/mapResolution*(component.x-mapExtent.left)));pxY=Math.round((1/mapResolution*(mapExtent.top-component.y)));obj.printInfo.postParams+="&imagePixel_X_"+cont+"_"+temp+"="+pxX;obj.printInfo.postParams+="&imagePixel_Y_"+cont+"_"+temp+"="+pxY}obj.printInfo.postParamsCont++}else{if(feature.geometry.CLASS_NAME=="OpenLayers.Geometry.Polygon"){obj.printInfo.postParams+="&geometryType_"+cont+"=GEOMETRY_POLYGON";obj.printInfo.postParams+="&imagePixelLength_"+cont+"="+feature.geometry.components[0].components.length;obj.printInfo.postParams+="&imagePixelColor_"+cont+"="+feature.style.fillColor;opacity=feature.style.fillOpacity*256;obj.printInfo.postParams+="&imagePixelOpacity_"+cont+"="+Math.round(opacity);obj.printInfo.postParams+="&imagePixelThickness_"+cont+"="+feature.style.strokeWidth;for(var temp=0,componentsLength=feature.geometry.components[0].components.length;temp<componentsLength;temp++){component=feature.geometry.components[0].components[temp];pxX=Math.round((1/mapResolution*(component.x-mapExtent.left)));pxY=Math.round((1/mapResolution*(mapExtent.top-component.y)));obj.printInfo.postParams+="&imagePixel_X_"+cont+"_"+temp+"="+pxX;obj.printInfo.postParams+="&imagePixel_Y_"+cont+"_"+temp+"="+pxY}obj.printInfo.postParamsCont++}}}}if(obj==null){var newOptions=this.options;if(newOptions&&newOptions.strategies){newOptions.strategies=null}if(newOptions&&newOptions.protocol){newOptions.protocol=null}obj=new OpenLayers.Layer.IAAA_GenericVector(this.name,OpenLayers.IAAA_Utils.cloneObject(newOptions))}var generatePrintInfo=false;var printMapSize=null;var printMapBaseLayer=this.map.baseLayer;var printParamsCount=0;if(optionalParams!=null){if(optionalParams.generatePrintInfo&&(optionalParams.paramsToPrintCount!=null)&&(optionalParams.paramsToPrintCount!=undefined)&&(optionalParams.printMapSize&&((optionalParams.printMapSize.height!=null)&&(optionalParams.printMapSize.height!=undefined))&&((optionalParams.printMapSize.width!=null)&&(optionalParams.printMapSize.width!=undefined)))){generatePrintInfo=true;obj.printInfo=new Object();obj.printInfo.postParams="";obj.printInfo.postParamsCont=0;printMapSize=new Object();printMapSize.height=optionalParams.printMapSize.height;printMapSize.width=optionalParams.printMapSize.width;printParamsCount=optionalParams.paramsToPrintCount}if(optionalParams.printMapBaseLayer){printMapBaseLayer=optionalParams.printMapBaseLayer}}obj.layers=[];var clonedLayer;for(var i=0,len=this.layers.length;i<len;i++){clonedLayer=this.layers[i].clone(null,cloneFeatures,optionalParams);obj.layers.push(clonedLayer);if(generatePrintInfo){optionalParams.paramsToPrintCount+=clonedLayer.printInfo.postParamsCont;obj.printInfo.postParamsCont+=clonedLayer.printInfo.postParamsCont}if(this.layers[i].getVisibility()){obj.layers[obj.layers.length-1].visibility=true}}obj.map=null;cloneFeatures=cloneFeatures&&!generatePrintInfo;var lonlat,px,width,height,color,strAux,primaryColorVector,component,opacity,cont;var textFeatureObject=null;if((this.featuresTextFormat!=null)&&(this.featuresTextFormat!=undefined)&&(this.featuresTextFormat!="")){textFeatureObject=eval("("+this.featuresTextFormat+")")}var mapRes,mapExt;mapRes=printMapBaseLayer.map.getResolution();mapExt=printMapBaseLayer.map.getExtent();if(cloneFeatures||generatePrintInfo){if((textFeatureObject==null)||((textFeatureObject!=null)&&!cloneFeatures)){for(var i=0,len=this.features.length;i<len;i++){if(cloneFeatures){this.features[i].clone=function(){clonedFeature=new OpenLayers.Feature.Vector(this.geometry?this.geometry.clone():null,null,OpenLayers.IAAA_Utils.cloneObject(this.style));for(var indx in this.attributes){if(this.attributes[indx]&&this.attributes[indx].CLASS_NAME&&(this.attributes[indx].CLASS_NAME.indexOf("Layer")!=-1)){continue}else{clonedFeature.attributes[indx]=OpenLayers.IAAA_Utils.cloneObject(this.attributes[indx])}}if(this.data){clonedFeature.data=OpenLayers.IAAA_Utils.cloneObject(this.data)}return clonedFeature};obj.features.push(this.features[i].clone())}if(generatePrintInfo){generateFeaturePrintInfo(this.features[i],mapRes,mapExt)}}}else{var featureRead,newFeature,index;for(var fIndex=0,fLen=textFeatureObject.features.length;fIndex<fLen;fIndex++){featureRead=this.protocol.format.parseFeature(textFeatureObject.features[fIndex]);obj.features.push(featureRead);index=obj.features.length-1;for(var indx in this.features[index].attributes){if(this.features[index].attributes[indx]&&this.features[index].attributes[indx].CLASS_NAME&&(this.features[index].attributes[indx].CLASS_NAME.indexOf("Layer")!=-1)){continue}else{obj.features[index].attributes[indx]=OpenLayers.IAAA_Utils.cloneObject(this.features[index].attributes[indx])}}obj.features[index].style=OpenLayers.IAAA_Utils.cloneObject(this.features[index].style);if(generatePrintInfo){generateFeaturePrintInfo(this.features[index],mapRes,mapExt)}if((this.features[index].CLASS_NAME=="OpenLayers.Feature.Vector")&&this.features[index].geometry&&(this.features[index].geometry.CLASS_NAME=="OpenLayers.Geometry.LineString")&&(this.features[index].attributes[carrilesBiciSelectorParameter]!=undefined)&&(this.features[index].attributes[carrilesBiciSelectorParameter]!=null)&&carrilesBiciStyle[this.features[index].attributes[carrilesBiciSelectorParameter]].middleLine){newFeature=new OpenLayers.Feature.Vector((textFeatureObject.features[fIndex].geometry)?this.protocol.format.parseGeometry(textFeatureObject.features[fIndex].geometry):featureRead.geometry.clone());obj.features.push(newFeature);index=obj.features.length-1;for(var indx in this.features[index].attributes){if(this.features[index].attributes[indx]&&this.features[index].attributes[indx].CLASS_NAME&&(this.features[index].attributes[indx].CLASS_NAME.indexOf("Layer")!=-1)){continue}else{obj.features[index].attributes[indx]=OpenLayers.IAAA_Utils.cloneObject(this.features[index].attributes[indx])}}obj.features[index].style=OpenLayers.IAAA_Utils.cloneObject(this.features[index].style);if(generatePrintInfo){generateFeaturePrintInfo(this.features[index],mapRes,mapExt)}}}textFeatureObject=null}}if(this.scaleIcon){obj.scaleIcon=this.scaleIcon}if(this.setIconsByScale){obj.setIconsByScale=this.setIconsByScale}if(this.iconsScalesLimits){obj.iconsScalesLimits=this.iconsScalesLimits}if(this.iconoGrandeList){obj.iconoGrandeList=this.iconoGrandeList}if(this.iconoMedioList){obj.iconoMedioList=this.iconoMedioList}if(this.iconoPeqList){obj.iconoPeqList=this.iconoPeqList}if(this.poisIconsLibraryPath){obj.poisIconsLibraryPath=this.poisIconsLibraryPath}if(this.dontCloneFeaturesInSrsChange){obj.dontCloneFeaturesInSrsChange=this.dontCloneFeaturesInSrsChange}if(this.additionalInfo){obj.additionalInfo=this.additionalInfo}return obj};singlePoiLayer.zoomControlIndex=-1;for(var i=0,len=this.map.controls.length;i<len;i++){if(map.controls[i].CLASS_NAME=="OpenLayers.Control.IAAA_ZoomBox"){singlePoiLayer.zoomControlIndex=i;break}}var onFeatureAdded=function(evt){if(evt.feature&&evt.feature.attributes&&(parseInt(evt.feature.attributes.priority)==1)){_showPopup(evt.feature,true,"poisPopupPriorityFixed")}};singlePoiLayer.events.register("beforefeatureadded",this,onFeatureAdded);singlePoiLayer.iconsScalesLimits=poisIconsScalesLimits;if(singlePoiLayer.scaleIcon==true){singlePoiLayer.currentIconScale=null;singlePoiLayer.currentIconSize=null;singlePoiLayer.setIconsByScale=setIconsByScale;singlePoiLayer.getTolerance=getTolerance;singlePoiLayer.deactivateZoomEvents=deactivateZoomEvents;singlePoiLayer.activateZoomEvents=activateZoomEvents}if(parent){parent.addLayer(singlePoiLayer)}facadeVariables._poisLayers.push(singlePoiLayer)}function _clickOutFeatureMobile(feature){if(!_showTooltipControl.hover&&_showTooltipControl.clickout){_unselectAllFeaturesMobile()}}function _unselectAllFeaturesMobile(options){var layers;if(_showTooltipControl.layers){layers=_showTooltipControl.layers.concat(_showTooltipControl.layer)}else{layers=[_showTooltipControl.layer]}var layer,feature;for(var l=0;l<layers.length;++l){layer=layers[l];for(var i=layer.selectedFeatures.length-1;i>=0;--i){feature=layer.selectedFeatures[i];if(!options||options.except!=feature){_showTooltipControl.unselect(feature)}}}}function _clickFeatureMobile(feature){if(!this.hover){var selected=(OpenLayers.Util.indexOf(feature.layer.selectedFeatures,feature)>-1);if(mobileNavigator){if(feature.attributes&&feature.attributes.priority&&(feature.attributes.priority==1)&&(feature.attributes.openedOnInit)){return}}if(selected){if(this.toggleSelect()){this.unselect(feature)}else{if(!this.multipleSelect()){this.unselectAll({except:feature})}}}else{if(!this.multipleSelect()){this.unselectAll({except:feature})}this.select(feature)}}}function _addSelectFeatureControl(poisLayers){if(_showTooltipControl){if(facadeVariables.clusterStrategy){facadeVariables.clusterStrategy.deactivate({skipRedraw:true})}_showTooltipControl.setLayer(poisLayers);if(facadeVariables.clusterStrategy){facadeVariables.clusterStrategy.setLayer(_showTooltipControl.layer);vectorialLayers=_showTooltipControl.layer.layers;_showTooltipControl.layer.containsPoints=true;facadeVariables.garbageCollectionList.push(_showTooltipControl.layer);facadeVariables.clusterStrategy.setLayers(vectorialLayers.slice(0,vectorialLayers.length));facadeVariables.clusterStrategy.activate({redrawVisibleLayers:true})}return}var controlOptions;if(mobileNavigator){controlOptions={onSelect:_selectFeature,onUnselect:_unSelectFeature,hover:false,toggle:true,callbacks:{click:_clickFeatureMobile,clickout:_clickOutFeatureMobile}}}else{controlOptions={onSelect:_selectFeature,onUnselect:_unSelectFeature,hover:true,overFeature:_overFeature,outFeature:_outFeature,callbacks:{click:_handleClick}}}_showTooltipControl=new OpenLayers.Control.SelectFeature(poisLayers,controlOptions);_showTooltipControl.unselectAllFeatures=_unselectAllFeaturesMobile;facadeVariables.showTooltipControl=_showTooltipControl;if(OpenLayers.Util.isArray(poisLayers)){if(_showTooltipControl.layer){_showTooltipControl.layer.setMap=function(map){OpenLayers.Layer.Vector.RootContainer.prototype.setMap.apply(this,arguments);if(this.renderer){this.renderer.moveRoot(this.renderer);if(facadeVariables&&facadeVariables.layersOnTopList&&facadeVariables.layersOnTopList.length){var layerNode;for(var i=0,iLen=facadeVariables.layersOnTopList.length;i<iLen;i++){layerNode=document.getElementById(facadeVariables.layersOnTopList[i].div.id+"_root");if(layerNode){try{if(this.renderer.rendererRoot){this.renderer.rendererRoot.removeChild(layerNode);this.renderer.rendererRoot.appendChild(layerNode)}else{if(this.renderer.container){this.renderer.container.removeChild(layerNode);this.renderer.container.appendChild(layerNode)}}}catch(e){OpenLayers.IAAA_Utils.report("log","Error en showTooltipControl.setMap")}}}}}};_showTooltipControl.layer.handleChangeLayer=function(evt){OpenLayers.Layer.Vector.RootContainer.prototype.handleChangeLayer.apply(this,arguments);if(this.renderer){this.renderer.moveRoot(this.renderer);if(facadeVariables&&facadeVariables.layersOnTopList&&facadeVariables.layersOnTopList.length){var layerNode;for(var i=0,iLen=facadeVariables.layersOnTopList.length;i<iLen;i++){layerNode=document.getElementById(facadeVariables.layersOnTopList[i].div.id+"_root");if(layerNode){try{if(this.renderer.rendererRoot){this.renderer.rendererRoot.removeChild(layerNode);this.renderer.rendererRoot.appendChild(layerNode)}else{if(this.renderer.container){this.renderer.container.removeChild(layerNode);this.renderer.container.appendChild(layerNode)}}}catch(e){OpenLayers.IAAA_Utils.report("log","Error en showTooltipControl.handleChangeLayer")}}}}}}}}_showTooltipControl.initLayer=function(layers){OpenLayers.Control.SelectFeature.prototype.initLayer.apply(this,arguments);if(OpenLayers.Util.isArray(layers)){this.layer.handleChangeLayer=function(evt){OpenLayers.Layer.Vector.RootContainer.prototype.handleChangeLayer.apply(this,arguments);if(this.renderer){this.renderer.moveRoot(this.renderer);if(facadeVariables&&facadeVariables.layersOnTopList&&facadeVariables.layersOnTopList.length){var layerNode;for(var i=0,iLen=facadeVariables.layersOnTopList.length;i<iLen;i++){layerNode=document.getElementById(facadeVariables.layersOnTopList[i].div.id+"_root");if(layerNode){try{if(this.renderer.rendererRoot){this.renderer.rendererRoot.removeChild(layerNode);this.renderer.rendererRoot.appendChild(layerNode)}else{if(this.renderer.container){this.renderer.container.removeChild(layerNode);this.renderer.container.appendChild(layerNode)}}}catch(e){OpenLayers.IAAA_Utils.report("log","Error en showTooltipControl.initLayer")}}}}}}}};_showTooltipControl.handlers.feature.stopDown=false;_showTooltipControl.handlers.feature.handle=function(evt){if(this.feature&&!this.feature.layer){this.feature=null}var type=evt.type;var handled=false;var previouslyIn=!!(this.feature);var click=(type=="click"||type=="dblclick"||type=="touchstart");var featureTouched=false;if(!OpenLayers.IAAA_Utils.isNetscape()){if(evt.srcElement&&evt.srcElement.tagName&&evt.srcElement.tagName.toLowerCase()=="textbox"){if((type=="click")||(type=="touchstart")){if(this.feature){this.triggerCallback(type,"in",[this.feature]);this.lastFeature=this.feature}}return true}}var str="";if(mobileNavigator){var feature=null;try{var featureId=this.layer.renderer.getFeatureIdFromEvent(evt);if(featureId){if(typeof featureId==="string"){feature=this.layer.getFeatureById(featureId)}else{feature=featureId}}this.feature=feature}catch(e){OpenLayers.IAAA_Utils.report("log","Error en showTooltipControl.handlers.feature.handle")}if(feature==null){this.feature=this.layer.getFeatureFromEvent(evt)}}else{this.feature=this.layer.getFeatureFromEvent(evt)}if(this.feature&&(!this.feature.layer||(this.feature.layer&&!this.feature.layer.visibility))){this.feature=null}if(this.lastFeature&&!this.lastFeature.layer){this.lastFeature=null}if(this.feature){if(type==="touchstart"){OpenLayers.Event.stop(evt)}var inNew=(this.feature!=this.lastFeature);if(this.geometryTypeMatches(this.feature)){if(previouslyIn&&inNew){if(this.lastFeature){this.triggerCallback(type,"out",[this.lastFeature])}this.triggerCallback(type,"in",[this.feature]);featureTouched=true}else{if(!previouslyIn||click){this.triggerCallback(type,"in",[this.feature]);featureTouched=true}}this.lastFeature=this.feature;handled=true}else{if(this.lastFeature&&(previouslyIn&&inNew||click)){this.triggerCallback(type,"out",[this.lastFeature])}this.feature=null}}else{if(this.lastFeature&&(previouslyIn||click)){this.triggerCallback(type,"out",[this.lastFeature])}}try{if(mobileNavigator&&isLayerZIndexTouchSupported()&&!featureTouched){checkClickInGeorreferenceLayers(evt.xy)}}catch(e){OpenLayers.IAAA_Utils.report("log","Error en _showTooltipControl.handlers.feature.handle: \n"+e)}return handled};this.map.addControl(_showTooltipControl);_showTooltipControl.activate();if(mobileNavigator){_showTooltipControl.layer.destroyFeatures=function(features,options){var all=(features==undefined);if(all){features=this.features}if(features){try{this.removeFeatures(features,options);for(var i=features.length-1;i>=0;i--){if(features[i].popup&&features[i].popup.map){features[i].popup.map.removePopup(features[i].popup)}features[i].destroy()}}catch(e){OpenLayers.IAAA_Utils.report("error","[ERROR]: On layer.destroyFeatures:\n"+e)}}}}_showTooltipControl.layer.moveTo=function(bounds,zoomChanged,dragging){OpenLayers.Layer.prototype.moveTo.apply(this,arguments);var coordSysUnchanged=true;if(!dragging){this.renderer.root.style.visibility="hidden";this.div.style.left=-parseInt(this.map.layerContainerDiv.style.left)+"px";this.div.style.top=-parseInt(this.map.layerContainerDiv.style.top)+"px";var extent=this.map.getExtent();coordSysUnchanged=this.renderer.setExtent(extent,zoomChanged);this.renderer.root.style.visibility="visible";if(navigator.userAgent.toLowerCase().indexOf("gecko")!=-1){this.div.scrollLeft=this.div.scrollLeft}if(!zoomChanged&&coordSysUnchanged){var feature;for(var i in this.unrenderedFeatures){feature=this.unrenderedFeatures[i];this.drawFeature(feature)}}}if(!this.drawn||zoomChanged||!coordSysUnchanged){this.drawn=true;if(zoomChanged){return}var feature;for(var i=0,len=this.features.length;i<len;i++){this.renderer.locked=(i!==(len-1));feature=this.features[i];this.drawFeature(feature)}}};if(!mobileNavigator){_showTooltipControl.layer.map.events.register("zoomend",this,_hidePopups)}else{_showTooltipControl.layer.map.events.register("zoomend",this,function(){if(this.map.getZoom()!=facadeVariables.currentZoom){_hidePopups()}facadeVariables.currentZoom=this.map.getZoom()})}facadeVariables.currentZoom=this.map.getZoom()}function _addClusterStrategy(){var clusterStrategy=new OpenLayers.Strategy.IAAA_MultipleCluster();clusterStrategy.clusterStyle.cursor="pointer";clusterStrategy.clusterStyle.strokeColor="#FFFFFF";clusterStrategy.clusterStyle.strokeWidth=2;if(_showTooltipControl){_showTooltipControl.layer.strategies=[clusterStrategy];clusterStrategy.setLayer(_showTooltipControl.layer);vectorialLayers=_showTooltipControl.layer.layers;facadeVariables.clusterStrategy=clusterStrategy;facadeVariables.clusterStrategy.ignoreClusterization=false;facadeVariables.clusterStrategy.forceClusterization=false;_showTooltipControl.layer.containsPoints=true;facadeVariables.garbageCollectionList.push(_showTooltipControl.layer)}clusterStrategy.setLayers(vectorialLayers.slice(0,vectorialLayers.length-1));clusterStrategy.shouldCluster=function(cluster,feature){var shouldCluster=OpenLayers.Strategy.Cluster.prototype.shouldCluster.apply(this,arguments);var isPoint=(feature.geometry.CLASS_NAME=="OpenLayers.Geometry.Point");if((feature.attributes.clusterize!=undefined)&&(feature.attributes.clusterize!=null)){return(shouldCluster&&feature.attributes.clusterize&&isPoint)}else{return shouldCluster&&isPoint}};clusterStrategy.cacheFeatures=function(event){var propagate=true;if(!this.clustering){if(!this.features){delete this.features;this.features=new Array();this.features=[]}for(var i=0,len=event.features.length;i<len;i++){this.features.push(event.features[i]);if(event.layerLoading){this.features[this.features.length-1].layer=event.layerLoading}this.features[this.features.length-1].attributes.clustered=false}this.cluster(event);propagate=false}return propagate};clusterStrategy.activate=function(){var activated=OpenLayers.Strategy.prototype.activate.call(this);if(activated){for(var i=0,len=this.layers.length;i<len;i++){this.layers[i].events.on({featuresadded:this.cacheFeatures,visibilitychanged:this.cluster,scope:this})}this.layer.map.events.on({zoomend:this.cluster,scope:this})}this.reloadFeatures();return activated};if(!OpenLayers.IAAA_Utils.isNetscape()&&clusterStrategy.layer&&clusterStrategy.layer.renderer&&(clusterStrategy.layer.renderer.CLASS_NAME.toLowerCase().indexOf("vml")!=-1)){clusterStrategy.layer.renderer.drawText=function(featureId,style,location){var label=this.nodeFactory(featureId+this.LABEL_ID_SUFFIX,"olv:rect");var textbox=this.nodeFactory(featureId+this.LABEL_ID_SUFFIX+"_textbox","olv:textbox");var resolution=this.getResolution();label.style.left=(location.x/resolution-this.offset.x).toFixed()+"px";label.style.top=(location.y/resolution-this.offset.y).toFixed()+"px";label.style.flip="y";textbox.innerText=style.label;if(style.fillColor){textbox.style.color=style.fontColor}if(style.fontFamily){textbox.style.fontFamily=style.fontFamily}if(style.fontSize){textbox.style.fontSize=style.fontSize}if(style.fontWeight){textbox.style.fontWeight=style.fontWeight}if(style.cursor){textbox.style.cursor="pointer"}textbox.style.whiteSpace="nowrap";textbox.inset="1px,0px,0px,0px";if(!label.parentNode){label.appendChild(textbox);this.textRoot.appendChild(label)}var align=style.labelAlign||"cm";var xshift=textbox.clientWidth*(OpenLayers.Renderer.VML.LABEL_SHIFT[align.substr(0,1)]);var yshift=textbox.clientHeight*(OpenLayers.Renderer.VML.LABEL_SHIFT[align.substr(1,1)]);label.style.left=parseInt(label.style.left)-xshift-1+"px";label.style.top=parseInt(label.style.top)+yshift+"px"};clusterStrategy.setClusterStyle=function(cluster){cluster.style=OpenLayers.Util.extend({},this.clusterStyle);cluster.style.pointRadius=cluster.style.pointRadius+this.resizeFactor(cluster.cluster.length,this.layer.map.getActualScale());cluster.style.label=cluster.attributes.count;cluster.style.printLabel=cluster.attributes.count;if(!OpenLayers.IAAA_Utils.isNetscape()){cluster.style.cursor="pointer"}}}clusterStrategy.layer.moveTo=function(bounds,zoomChanged,dragging){OpenLayers.Layer.prototype.moveTo.apply(this,arguments);var coordSysUnchanged=true;if(!dragging){this.renderer.root.style.visibility="hidden";this.div.style.left=-parseInt(this.map.layerContainerDiv.style.left)+"px";this.div.style.top=-parseInt(this.map.layerContainerDiv.style.top)+"px";var extent=this.map.getExtent();coordSysUnchanged=this.renderer.setExtent(extent,zoomChanged);this.renderer.root.style.visibility="visible";if(navigator.userAgent.toLowerCase().indexOf("gecko")!=-1){this.div.scrollLeft=this.div.scrollLeft}if(!zoomChanged&&coordSysUnchanged){var feature;for(var i in this.unrenderedFeatures){feature=this.unrenderedFeatures[i];this.drawFeature(feature)}}}var resolution=this.map.getResolution();if(!this.drawn||zoomChanged||!coordSysUnchanged){this.drawn=true;if(zoomChanged&&!this.map.moveToFromUpdateSize){return}var feature;for(var i=0,len=this.features.length;i<len;i++){this.renderer.locked=(i!==(len-1));feature=this.features[i];this.drawFeature(feature)}}};clusterStrategy.activate();clusterStrategy.checkFeatureState=function(feature,originalLayer){if(!feature||!originalLayer){return}if(originalLayer.iconsScalesLimits&&(originalLayer.iconsScalesLimits.length>=2)&&originalLayer.scaleIcon){if(originalLayer.map){if((feature.geometry)&&(feature.geometry.CLASS_NAME=="OpenLayers.Geometry.Point")){var currentScale=originalLayer.map.getActualScale();var scaleLimit0=originalLayer.iconsScalesLimits[0];var scaleLimit1=originalLayer.iconsScalesLimits[1];var poisIconsHeights=poisIconsSizes;var poisIconsWidths=poisIconsSizes;if(feature.style.poisIconsHeights){poisIconsHeights=feature.style.poisIconsHeights}if(feature.style.poisIconsWidths){poisIconsWidths=feature.style.poisIconsWidths}var height=originalLayer.getTolerance(originalLayer.map,poisIconsScalesLimits,poisIconsHeights,poisIconDefaultHeight);var width=originalLayer.getTolerance(originalLayer.map,poisIconsScalesLimits,poisIconsWidths,poisIconDefaultWidth);if(feature.style){if((feature.style.graphicHeight==height)&&(feature.style.graphicWidth==width)){return}feature.style.graphicHeight=poisIconDefaultHeight;feature.style.graphicWidth=poisIconDefaultWidth;if(feature.style.backgroundHeight){feature.style.backgroundHeight=parseInt(poisIconDefaultHeight*1.2)}if(feature.style.backgroundWidth){feature.style.backgroundWidth=parseInt(poisIconDefaultWidth*1.2)}feature.style.originalGraphicHeight=height;feature.style.originalGraphicWidth=width}}}}}}function _updateRenderLayerDiv(){if(_showTooltipControl&&_showTooltipControl.layer){facadeVariables.renderLayerDiv=_showTooltipControl.layer.div;if((navigator.appName!="Microsoft Internet Explorer")&&(facadeVariables.streetLocationLayerDiv!=null)){if(mobileNavigator&&(_showTooltipControl.layer.renderer.CLASS_NAME=="OpenLayers.Renderer.SVG")){facadeVariables.streetLocationLayerDiv.style.zIndex=parseInt(facadeVariables.renderLayerDiv.style.zIndex)-1;facadeVariables.streetLocationLayerDiv=null}else{facadeVariables.streetLocationLayerDiv.style.zIndex=parseInt(facadeVariables.renderLayerDiv.style.zIndex)+1;facadeVariables.streetLocationLayerDiv=null}}if((navigator.appName!="Microsoft Internet Explorer")&&(facadeVariables.markerLayerDivList!=null)){var count=0;for(var i in facadeVariables.markerLayerDivList){count++;if(mobileNavigator&&(_showTooltipControl.layer.renderer.CLASS_NAME=="OpenLayers.Renderer.SVG")){facadeVariables.markerLayerDivList[i].style.zIndex=parseInt(facadeVariables.renderLayerDiv.style.zIndex)-count;facadeVariables.markerLayerDivList[i]=undefined}else{facadeVariables.markerLayerDivList[i].style.zIndex=parseInt(facadeVariables.renderLayerDiv.style.zIndex)+count;facadeVariables.markerLayerDivList[i]=undefined}}}}}function _selectFeature(feature){try{if(feature){if(!feature.cluster){_showPopup(feature,false,null,this)}else{_showClusterPopup(feature)}}}catch(e){}}function _unSelectFeature(feature){try{if(feature){_hidePopups(feature)}}catch(e){}}function _handleClick(feature){if(feature){if(feature.cluster){var bounds;var top=null;var left=null;var right=null;var bottom=null;for(var i=0,ilen=feature.cluster.length;i<ilen;i++){if(feature.cluster[i].geometry&&feature.cluster[i].geometry.getBounds()){bounds=feature.cluster[i].geometry.getBounds()}else{bounds=new OpenLayers.Bounds(feature.cluster[i].lonlat.lon,feature.cluster[i].lonlat.lat,feature.cluster[i].lonlat.lon,feature.cluster[i].lonlat.lat)}if((left==null)||(left>bounds.left)){left=bounds.left}if((top==null)||(top<bounds.top)){top=bounds.top}if((right==null)||(right<bounds.right)){right=bounds.right}if((bottom==null)||(bottom>bounds.bottom)){bottom=bounds.bottom}}if(left&&top&&right&&bottom){var newExtent=new OpenLayers.Bounds(left,bottom,right,top);var mapExtent=this.map.getExtent();var centerLonLat=newExtent.getCenterLonLat();var zoom=this.map.getZoomForExtent(newExtent,true);var newExtent2=this.map.calculateBounds(centerLonLat,this.map.getResolutionForZoom(zoom));if((newExtent2.left>newExtent.left)||(newExtent2.right<newExtent.right)||(newExtent2.bottom>newExtent.bottom)||(newExtent2.top<newExtent.top)){zoom--}if((minClusterDetailedZoomLevel!=null)&&(zoom<minClusterDetailedZoomLevel)){zoom=minClusterDetailedZoomLevel}this.map.setCenter(centerLonLat,zoom)}}else{_openFeatureLink(feature)}}}function _openFeatureLink(feature){if(feature.attributes.link){window.open(feature.attributes.link)}else{if(feature.attributes.url){window.open(feature.attributes.url)}}}function _showClusterPopup(feature){var mapa=this.map;if(!mapa){mapa=getMap();if(!mapa){return}}if(mobileNavigator&&getFacade()&&getFacade().deshabilitarRedimensionMapa){getFacade().deshabilitarRedimensionMapa()}try{if(feature.layer&&feature.layer.zoomControlIndex&&(feature.layer.zoomControlIndex!=-1)){var control=feature.layer.map.controls[feature.layer.zoomControlIndex];if((control.active)&&!((control.handler)&&(control.handler.zoomBox))){control.deactivate();feature.layer.reactivateZoom=true}}}catch(e){}var contentHTML="";var lineHeight=0;var maxCharactersPerLine=clusterClientStyle.maxCharactersPerLine;var fontSizeHeight=clusterClientStyle.textSizeHeight;if(((minClusterDetailedZoomLevel==null)||(mapa.getZoom()<minClusterDetailedZoomLevel))&&((feature.cluster!=undefined)&&(feature.cluster!=null)&&(feature.cluster.length!=undefined)&&(feature.cluster.length!=null)&&(feature.cluster.length>maxFeaturesInDetailedCluster))){var categoriesLayerIconUrl=new Array();categoriesLayerIconUrl=[];var layerFeatureCounter=new Array();layerFeatureCounter=[];var undefinedNameCounter=0;var layer;var layerName;var useCategoriesHeader=new Array();categoriesCounter=0;var showingCategoriesWithHeader=false;for(var i=0,len=feature.cluster.length;i<len;i++){if(feature.cluster[i].attributes.originalLayer){layer=feature.cluster[i].attributes.originalLayer;layerName=(layer.title?layer.title:(layer.name?layerName:"undefined"+undefinedCounter++));while(layer.parent){layer=layer.parent}categoryName=layer.name;if(categoryName!=null){if(!categoriesLayerIconUrl[categoryName]){categoriesLayerIconUrl[categoryName]=new Array();categoriesCounter++}if((!useCategoriesHeader[categoryName])&&feature.cluster[i].attributes.originalLayer.parent){useCategoriesHeader[categoryName]=true;showingCategoriesWithHeader=true}if(!categoriesLayerIconUrl[categoryName][layerName]){categoriesLayerIconUrl[categoryName][layerName]=feature.cluster[i].attributes.icon}if(!layerFeatureCounter[layerName]){layerFeatureCounter[layerName]=0}layerFeatureCounter[layerName]++}}}var contentTableHTML='<table class="clusterContentTableStyle"><tbody>';var lineCounter=0;var counter=0;for(var category in categoriesLayerIconUrl){if(useCategoriesHeader[category]){contentTableHTML+='<tr><td colspan="6"><font class="clusterPopupStyleTextCategory">'+category+":</font></td></tr>"}for(var layerName in categoriesLayerIconUrl[category]){if(categoriesLayerIconUrl[category][layerName]){contentTableHTML+="<tr>";if(useCategoriesHeader[category]){contentTableHTML+='<td colspan="2"><font class="clusterPopupStyleText"> </font></td><td><table><tbody><tr>'}contentTableHTML+='<td><font class="clusterPopupStyleText">- </td><td><img class="clusterPopupStyleCategoryImg" src="'+categoriesLayerIconUrl[category][layerName]+'"></td>'}else{contentTableHTML+="<tr>"+((useCategoriesHeader[category])?'<td colspan="2"><font class="clusterPopupStyleText"> </font></td>':"")+'<td><font class="clusterPopupStyleText">- </font></td>'}contentTableHTML+='<td colspan="2"><font class="clusterPopupStyleText">'+layerName+"</font></td>";if(useCategoriesHeader[category]){contentTableHTML+="</tr></tbody></table></td>"}contentTableHTML+='<td><font class="clusterPopupStyleText">(<font class="clusterPopupStyleTextHighlight">'+layerFeatureCounter[layerName]+"</font>)</font></td></tr>";lineCounter++}counter++;lineCounter++}contentTableHTML+="</tbody></table>";if(lineCounter>clusterClientStyle.popupMaxContentLines){if(!mobileNavigator){if(OpenLayers.IAAA_Utils.isNetscape()){contentHTML='<div class="clusterContentDivStyle">'+contentHTML}else{contentHTML='<div class="clusterContentDivStyleIE">'+contentHTML}}else{contentHTML='<div class="clusterContentDivStyle">'+contentHTML}}contentHTML+=contentTableHTML;if(lineCounter>clusterClientStyle.popupMaxContentLines){contentHTML+="</div>"}delete categoriesLayerIconUrl;delete layerFeatureCounter}else{var categoriesLayerIconUrl=new Array();categoriesLayerIconUrl=[];var layerLinkList=new Array();layerLinkList=[];var layerLinkListCounter=new Array();layerLinkListCounter=[];var layer;var layerName;var useCategoriesHeader=new Array();var layersInCategoryCounter=new Object();var categoriesCounter=0;for(var i=0,len=feature.cluster.length;i<len;i++){if(feature.cluster[i].attributes.originalLayer){layer=feature.cluster[i].attributes.originalLayer;layerName=(layer.title?layer.title:(layer.name?layerName:"undefined"+undefinedCounter++));while(layer.parent){layer=layer.parent}categoryName=layer.name;if(categoryName!=null){var title=((feature.cluster[i].data&&feature.cluster[i].data.title)?feature.cluster[i].data.title:feature.cluster[i].attributes.title);var link=((feature.cluster[i].data&&feature.cluster[i].data.link)?feature.cluster[i].data.link:feature.cluster[i].attributes.link);if(!categoriesLayerIconUrl[categoryName]){categoriesLayerIconUrl[categoryName]=new Array();categoriesCounter++;layersInCategoryCounter[categoryName]=0}if((!useCategoriesHeader[categoryName])&&feature.cluster[i].attributes.originalLayer.parent){useCategoriesHeader[categoryName]=true}if(!categoriesLayerIconUrl[categoryName][layerName]){categoriesLayerIconUrl[categoryName][layerName]=feature.cluster[i].attributes.icon;layersInCategoryCounter[categoryName]++}if(!layerLinkList[layerName]){layerLinkList[layerName]=""}layerLinkList[layerName]+='<li class="clusterPopupStyleLi">';if(link){layerLinkList[layerName]+='<a href="'+feature.cluster[i].data.link+'" target="_blank" style="color:'+clusterClientStyle.textLinkColor+';text-decoration:none;">'}layerLinkList[layerName]+='<font class="clusterPopupStyleTextHighlight">'+(title?title:link)+"</font>";if(link){layerLinkList[layerName]+="</a>"}layerLinkList[layerName]+="</li>";if(!layerLinkListCounter[layerName]){layerLinkListCounter[layerName]=0}layerLinkListCounter[layerName]++}}}var contentTableHTML='<table class="clusterContentTableStyle"><tbody>';var lineCounter=0;var counter=0;for(var category in categoriesLayerIconUrl){if(useCategoriesHeader[category]){contentTableHTML+='<tr><td colspan="6"><font class="clusterPopupStyleTextCategory">'+category+":</font></td></tr>";lineCounter++}for(var layerName in categoriesLayerIconUrl[category]){if(categoriesLayerIconUrl[category][layerName]){contentTableHTML+="<tr>";if(useCategoriesHeader[category]){contentTableHTML+='<td colspan="2"><font class="clusterPopupStyleText"> </font></td><td><table><tbody><tr>'}contentTableHTML+='<td><font class="clusterPopupStyleText">- </td><td><img class="clusterPopupStyleCategoryImg" src="'+categoriesLayerIconUrl[category][layerName]+'"></td>'}else{contentTableHTML+="<tr>"+((useCategoriesHeader[category])?'<td colspan="2"><font class="clusterPopupStyleText"> </font></td>':"")+'<td><font class="clusterPopupStyleText">- </font></td>'}contentTableHTML+='<td colspan="2"><font class="clusterPopupStyleText">'+layerName+":</font></td>";if(useCategoriesHeader[category]){contentTableHTML+="</tr></tbody></table></td>"}contentTableHTML+="</tr>";contentTableHTML+="<tr>";contentTableHTML+='<td colspan="2"><font class="clusterPopupStyleText"> </font></td><td><table><tbody>';contentTableHTML+='<tr><td width="12px">&nbsp</td>';contentTableHTML+='<td><ul class="clusterPopupStyleUl">'+layerLinkList[layerName]+"</ul>";contentTableHTML+="</td></tr>";contentTableHTML+="</td></tr></tbody></table></td></tr>";lineCounter+=(layerLinkListCounter[layerName]+2)}counter++}contentTableHTML+="</tbody></table>";if(lineCounter>clusterClientStyle.popupMaxContentLines){if(!mobileNavigator){if(OpenLayers.IAAA_Utils.isNetscape()){contentHTML='<div class="clusterContentDivStyle">'+contentHTML}else{contentHTML='<div class="clusterContentDivStyleIE">'+contentHTML}}else{contentHTML='<div class="clusterContentDivStyle">'+contentHTML}}contentHTML+=contentTableHTML;if(lineCounter>clusterClientStyle.popupMaxContentLines){contentHTML+="</div>"}delete categoriesLayerIconUrl;delete layerLinkList}contentHTML='<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1"/><div class="clusterContainer">'+contentHTML;contentHTML+="</div>";var anchor={size:clusterClientStyle.popupAnchorSize,offset:clusterClientStyle.popupAnchorOffset};var center=feature.geometry.getCentroid();var lonlat=new OpenLayers.LonLat(feature.geometry.x,feature.geometry.y);var popupOptions=new Object();for(var att in facadeVariables.popupOptions){popupOptions[att]=facadeVariables.popupOptions[att]}if(clusterClientStyle.stemSize){popupOptions.stemSize=clusterClientStyle.stemSize}if(clusterClientStyle.stemImageOffset){popupOptions.stemImageOffset=clusterClientStyle.stemImageOffset}if(clusterClientStyle.stemDivOffset){popupOptions.stemDivOffset=clusterClientStyle.stemDivOffset}if(clusterClientStyle.popupDivOffset){popupOptions.popupDivOffset=clusterClientStyle.popupDivOffset}if(clusterClientStyle.stemOffsetRight){popupOptions.stemSizeOffsetRight=poisClientStyle.stemSizeOffsetRight}if(clusterClientStyle.stemSizeOffsetLeft){popupOptions.stemSizeOffsetLeft=poisClientStyle.stemSizeOffsetLeft}if(clusterClientStyle.imageSize){popupOptions.imageSize=clusterClientStyle.imageSize}if(clusterClientStyle.maxSize){popupOptions.maxSize=clusterClientStyle.maxSize}if(clusterClientStyle.blockPositionRightOffset){popupOptions.blockPositionRightOffset=clusterClientStyle.blockPositionRightOffset}if(clusterClientStyle.blockOpacity){if(navigatorInfo){if((navigatorInfo[0]=="msie")&&(parseInt(navigatorInfo[1])<=6)){popupOptions.blockOpacity={stem:1}}else{popupOptions.blockOpacity=clusterClientStyle.blockOpacity}}else{popupOptions.blockOpacity={stem:1}}}popupOptions.popupImageSrc=facadeVariables.popupOptions.popupImageVector.poisPopupNoPriority;if((feature.layer.popupOpacity!=undefined)&&(feature.layer.popupOpacity!=null)){popupOptions.opacity=feature.layer.popupOpacity}else{popupOptions.opacity=facadeVariables.defaultPopupOpacity}popupOptions.showLogo=false;popupOptions.logoImgSrc=undefined;popupOptions.logoSize=undefined;if((popupOptions.updateZIndex!=undefined)&&(popupOptions.updateZIndex!=null)&&(popupOptions.updateZIndex!=false)){if(mapa&&mapa.popups&&(mapa.popups.length>0)){var newZindex=mapa.popups[mapa.popups.length-1].contentDiv.style.zIndex;if((newZindex!=null)&&(newZindex!=undefined)&&(mapa.popups[mapa.popups.length-1].zIndexChange!=null)){if(!mobileNavigator){popupOptions.zIndexChange=mapa.popups[mapa.popups.length-1].contentDiv.style.zIndex}else{popupOptions.zIndexChange=Number(mapa.popups[mapa.popups.length-1].zIndexChange)+1}}else{popupOptions.zIndexChange=facadeVariables.popupOptions.zIndexBase+1}}else{popupOptions.zIndexChange=facadeVariables.popupOptions.zIndexBase+1}}var hideContent="none";if(mobileNavigator&&((screen.width<=maxWidthToShowExpandedPopup)||((screen.height<=maxWidthToShowExpandedPopup)&&(screen.width>=screen.height)))){hideContent=checkPopupContent(null,contentHTML,true,true)}var popupDescription="";var popupFullDescription=contentHTML;var enableViewFullContentOnClick=false;if(hideContent!="none"){popupDescription='<div><font class="clusterPopupStyleText">Pulsar para ver info</font></div>';enableViewFullContentOnClick=true}else{popupDescription=contentHTML}if(mobileNavigator){popupOptions.panMapIfOutOfView=false}feature.popup=new OpenLayers.Popup.IAAA_FramedCloud(feature.id+"_popup",lonlat,clusterClientStyle.popupSize,popupDescription,anchor,false,null,popupOptions);updatePopup(feature.popup,popupOptions);feature.popup.setBorder=function(border){return;if(border!=undefined){this.border=border}if(this.div!=null){try{this.div.style.border=this.border}catch(e){this.div.style.setAttribute("border",this.border)}}};feature.popup.poisPopup=true;feature.popup.border=0;feature.popup.div.className="poisPopupNoPriority";feature.popup.events.registerPriority("mouseover",feature.popup.div,function(evt){OpenLayers.Event.stop(evt);return false});feature.popup.events.register("mousemove",feature.popup.div,function(evt){OpenLayers.Event.stop(evt);return false});if(mobileNavigator){if(enableViewFullContentOnClick){feature.popup.div.docParent=parent;feature.popup.div.setAttribute("fullContent",popupFullDescription);feature.popup.events.register("click",feature.popup.div,function(evt){var contentDiv="";contentDiv=this.getAttribute("fullContent");var contentLogo="";if(this.children[0]&&this.children[0].children[this.id+"_FrameLogoDiv"]){contentLogo=this.children[0].children[this.id+"_FrameLogoDiv"].innerHTML}_showExpandedPopup(contentDiv,contentLogo);return false})}}mapa.addPopup(feature.popup,false,{updateZIndex:popupOptions.updateZIndex,addToDiv:facadeVariables.renderLayerDiv});if((navigator.userAgent.indexOf("Firefox/2.")>=0)){feature.popup.div.style.zIndex=popupOptions.zIndexChange}try{if(feature.layer&&feature.layer.zoomControlIndex&&(feature.layer.zoomControlIndex!=-1)){var control=mapa.controls[feature.layer.zoomControlIndex];if((!control.active)&&feature.layer.reactivateZoom){control.activate();feature.layer.reactivateZoom=false}}}catch(e){}if(mobileNavigator&&getFacade()&&getFacade().habilitarRedimensionMapa){getFacade().habilitarRedimensionMapa()}}function _setPopupWindowContent(){if(facadeVariables&&facadeVariables.popupWindow&&facadeVariables.popupWindow.setContent&&facadeVariables.popupWindowContent){facadeVariables.popupWindow.setContent(facadeVariables.popupWindowContent,facadeVariables.popupWindowLogo);facadeVariables.popupWindowContent=null;facadeVariables.popupWindowLogo=null;facadeVariables.popupWindow=null}}function _hidePopups(feature){if(mobileNavigator){if(feature&&feature.CLASS_NAME&&(feature.CLASS_NAME.indexOf("OpenLayers.Feature")!=-1)){if(feature.popup){try{feature.popup.feature=null;feature.popup.destroy();feature.popup=null;feature.attributes.openedOnInit=false}catch(e){feature.popup=null;feature.attributes.openedOnInit=false}}}else{if(this.map&&this.map.popups){for(var i=this.map.popups.length-1;i>=0;i--){if(!this.map.popups[i].closeDiv){if(this.map.popups[i].feature){this.map.popups[i].feature.popup=null;this.map.popups[i].feature.attributes.openedOnInit=false;this.map.popups[i].feature=null}this.map.popups[i].destroy()}}}}}else{if(this.map&&this.map.popups){for(var i=this.map.popups.length-1;i>=0;i--){if(!this.map.popups[i].closeDiv){this.map.popups[i].destroy()}}}}}function _updateLayerPopups(layer){var visibilidad=layer.visibility;if(!visibilidad&&layer.features){for(var j=0,l2=layer.features.length;j<l2;j++){if(layer.features[j].popup){try{if(mobileNavigator&&layer.features[j].popup.feature){layer.features[j].popup.feature.attributes.openedOnInit=false;layer.features[j].popup.feature=null}layer.features[j].popup.destroy();layer.features[j].popup=null}catch(e){}}}}else{for(var j=0,l2=layer.features.length;j<l2;j++){var feature=layer.features[j];if(feature.attributes&&(parseInt(feature.attributes.priority)==1)){_showPopup(feature,true,"poisPopupPriorityFixed");feature.attributes.openedOnInit=true}}}}function _pintaTramosTrafico(){if(facadeVariables.capaTrafico&&facadeVariables.tramos&&facadeVariables.estadoTramos){var features=new Array();features=[];var scale=this.map.getActualScale();for(var i=0,l=facadeVariables.tramos.length;i<l;i++){var feature;var obj=facadeVariables.tramos[i];var style=null;if((obj.id!=null)&&(facadeVariables.estadoTramos.length>parseInt(obj.id))){var state;if(navigator.appName!="Microsoft Internet Explorer"){state=facadeVariables.estadoTramos[parseInt(obj.id)]}else{state=facadeVariables.estadoTramos.charAt(parseInt(obj.id))}var color=null;var traficoLineWidth=2;var strokeDashstyle="solid";var attributes={id:obj.id,name:obj.name};if(trafficStyle&&trafficStyle[state]){color=trafficStyle[state].lineColor;if(trafficStyle[state].lineWidth){attributes.lineWidth=trafficStyle[state].lineWidth;for(var ind in trafficStyle[state].lineWidth){if(ind>scale){traficoLineWidth=trafficStyle[state].lineWidth[ind]}}}if(trafficStyle[state].strokeDashstyle){attributes.strokeDashstyle=trafficStyle[state].strokeDashstyle;for(var ind in trafficStyle[state].strokeDashstyle){if(ind>scale){strokeDashstyle=trafficStyle[state].strokeDashstyle[ind]}}}}if(color!=null){style={fillColor:color,fillOpacity:0.4,hoverFillColor:"white",hoverFillOpacity:0.8,strokeColor:color,strokeOpacity:1,strokeWidth:traficoLineWidth,strokeLinecap:"round",strokeDashstyle:strokeDashstyle,hoverStrokeColor:"red",hoverStrokeOpacity:1,hoverStrokeWidth:0.2,pointRadius:6,hoverPointRadius:1,hoverPointUnit:"%",pointerEvents:"visiblePainted",cursor:"inherit"};var points=[];for(var j=0,l2=obj.points.length;j<l2;j++){var pt=null;if(this.map.projection!=facadeVariables.capaTrafico.coordsFileSRS){pt=coordTransform(facadeVariables.capaTrafico.coordsFileSRS,this.map.projection,obj.points[j].lon,obj.points[j].lat)}else{pt=[obj.points[j].lon,obj.points[j].lat]}points.push(new OpenLayers.Geometry.Point(pt[0],pt[1]))}feature=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.LineString(points),attributes,style);var tramoShadow=feature.clone();tramoShadow.style=OpenLayers.Util.extend({},feature.style);tramoShadow.style.strokeColor=facadeVariables.capaTrafico.lineShadowColor;tramoShadow.style.fillColor=facadeVariables.capaTrafico.lineShadowColor;tramoShadow.style.strokeWidth=parseInt(feature.style.strokeWidth)+facadeVariables.capaTrafico.lineShadowWidthInc;tramoShadow.attributes.shadow=true;features.push(tramoShadow);features.push(feature)}}}facadeVariables.capaTrafico.addFeatures(features);facadeVariables.capaTrafico.setVisibility(true);facadeVariables.capaTrafico.events.triggerEvent("loadend");facadeVariables.capaTrafico.lineStringVectorLayer=true;this.map.events.register("moveend",facadeVariables.capaTrafico,setIconsByScale);this.map.events.register("removelayer",this,function(evt){if(evt.layer.id==facadeVariables.capaTrafico.id){this.map.events.unregister("moveend",facadeVariables.capaTrafico,setIconsByScale)}});delete features}}function _setTrafficRequestTimeout(){if(!facadeVariables.mapDestroyed){if((facadeVariables.traficoTiempoActualizacion!=null)&&(facadeVariables.traficoTiempoActualizacion!=undefined)&&(facadeVariables.traficoTiempoActualizacion!=0)){if(facadeVariables.traficoRequestTimeOut!=null){_removeTrafficRequestTimeout()}facadeVariables.traficoRequestTimeOut=setTimeout(_forzarRefrescoTrafico,facadeVariables.traficoTiempoActualizacion)}}}function _removeTrafficRequestTimeout(){if((facadeVariables.traficoRequestTimeOut!=null)&&(facadeVariables.traficoRequestTimeOut!=undefined)){clearTimeout(facadeVariables.traficoRequestTimeOut);facadeVariables.traficoRequestTimeOut=null}}function _forzarRefrescoTrafico(){if((!facadeVariables.mapDestroyed)&&facadeVariables.capaTrafico.getVisibility()){if(!facadeVariables.traficoLoadedOnce){facadeVariables.capaTrafico.events.triggerEvent("loadstart")}var requestManager;var localTrafficRequestId=null;if(useServlet){requestManager=new OpenLayers.IAAA_Request(null,getHost()+servlet,"GET");var params={urlWFS:facadeVariables.capaTrafico.estadoTramosUrl,outputType:1,xmlRequest:false};requestManager.setRequestParams(params)}else{requestManager=new OpenLayers.IAAA_Request(null,facadeVariables.capaTrafico.estadoTramosUrl,"GET")}requestManager.events.register("loaddata",this,function(evt){if(evt&&evt.object&&evt.object.response){if((!facadeVariables.mapDestroyed)&&facadeVariables.capaTrafico.getVisibility()){successTrafficStateRequest(evt.object.response);_setTrafficRequestTimeout();if(!facadeVariables.traficoLoadedOnce){facadeVariables.capaTrafico.events.triggerEvent("loadend")}facadeVariables.traficoLoadedOnce=true}}else{failure();_setTrafficRequestTimeout()}});requestManager._onLoad=function(ajaxRequest){if((this.timeStampMainRequestId!=facadeVariables.currentTrafficRequest)&&(this.timeStampId!=facadeVariables.currentTrafficStateRequest)){return}if(this.responseType=="text"){this.response=ajaxRequest.responseText}else{this.response=ajaxRequest.responseXML}if(!facadeVariables.mapDestroyed){this.events.triggerEvent("loaddata")}};requestManager._onFail=function(ajaxRequest){if((this.timeStampMainRequestId!=facadeVariables.currentTrafficRequest)&&(this.timeStampId!=facadeVariables.currentTrafficStateRequest)){return}if(this.responseType=="text"){this.response=ajaxRequest.responseText}else{this.response=ajaxRequest.responseXML}if(!facadeVariables.mapDestroyed){this.events.triggerEvent("faildata")}};var timeStamp=new Date();facadeVariables.currentTrafficStateRequest=timeStamp.getTime();requestManager.timeStampId=facadeVariables.currentTrafficStateRequest;requestManager.timeStampMainRequestId=localTrafficRequestId;requestManager.doRequest()}var successTrafficStateRequest=function(response){var parsedResp;eval("parsedResp = "+response);var stateString=parsedResp.estados;facadeVariables.estadoTramos=stateString;if(facadeVariables.tramos&&facadeVariables.estadoTramos){if(facadeVariables.capaTrafico.features.length>0){facadeVariables.capaTrafico.removeFeatures(facadeVariables.capaTrafico.features,{silent:true})}_pintaTramosTrafico()}};var failure=function(){facadeVariables.tramos=null;facadeVariables.estadoTramos=null;OpenLayers.IAAA_Utils.report("error","[ERROR]: "+messages.trafficDataError);if(!facadeVariables.mapDestroyed){facadeVariables.capaTrafico.events.triggerEvent("loadend")}}}function getTolerance(map,scaleList,toleranceList,defaultValue){for(var i=0;i<scaleList.length;i++){if(i==(scaleList.length-1)){if(map.getActualScale()<scaleList[i]){if(toleranceList[i]){return toleranceList[i]}else{return defaultValue}}}else{if((map.getActualScale()<scaleList[i])&&(map.getActualScale()>scaleList[i+1])){if(toleranceList[i]){return toleranceList[i]}else{return defaultValue}}}}return defaultValue}function setIconsByScale(){if((this.iconsScalesLimits&&(this.iconsScalesLimits.length>=2)&&this.scaleIcon)||this.lineStringVectorLayer){var currentScale=this.map.getActualScale();var height,width;if(this.iconsScalesLimits&&(this.iconsScalesLimits.length>=2)&&this.scaleIcon&&this.getTolerance){if((this.currentIconScale!=null)&&(this.currentIconScale!=undefined)&&(this.currentIconScale==currentScale)){return}else{this.currentIconScale=currentScale}var scaleLimit0=this.iconsScalesLimits[0];var scaleLimit1=this.iconsScalesLimits[1];var newIconSize="";var height,width,realIconSize;height=this.getTolerance(this.map,poisIconsScalesLimits,poisIconsSizes,poisIconDefaultHeight);width=this.getTolerance(this.map,poisIconsScalesLimits,poisIconsSizes,poisIconDefaultWidth);var newIconSize=new OpenLayers.Size(width,height);if((this.currentIconSize!=null)&&(this.currentIconSize!=undefined)&&(this.currentIconSize==newIconSize)){return}else{this.currentIconSize=newIconSize}}else{if(this.lineStringVectorLayer){if((this.currentIconScale!=null)&&(this.currentIconScale!=undefined)&&(this.currentIconScale==currentScale)){return}else{this.currentIconScale=currentScale}}}this.eraseFeatures(this.features);var currentInd,index;for(var key=0,len=this.features.length;key<len;key++){if(this.features[key].style&&this.features[key].geometry&&(this.features[key].geometry.CLASS_NAME=="OpenLayers.Geometry.Point")){if(height!=null){this.features[key].style.graphicHeight=height}if(width!=null){this.features[key].style.graphicWidth=width}this.features[key].style.originalGraphicHeight=poisOriginalGraphicHeight;this.features[key].style.originalGraphicWidth=poisOriginalGraphicWidth}else{if(this.features[key].style&&this.features[key].geometry&&(this.features[key].geometry.CLASS_NAME=="OpenLayers.Geometry.LineString")){var lineWidth=null;var strokeDashstyle="solid";if(this.features[key].attributes){if(this.features[key].attributes.lineWidth){currentInd=null;for(var ind in this.features[key].attributes.lineWidth){index=parseInt(ind);if(index>currentScale){if((currentInd!=null)&&(currentInd<index)){break}lineWidth=this.features[key].attributes.lineWidth[ind];currentInd=index}}}if(this.features[key].attributes.strokeDashstyle){currentInd=null;for(var ind in this.features[key].attributes.strokeDashstyle){index=parseInt(ind);if(index>currentScale){if((currentInd!=null)&&(currentInd<index)){break}strokeDashstyle=this.features[key].attributes.strokeDashstyle[ind];currentInd=index}}}}this.features[key].style.strokeWidth=lineWidth;this.features[key].style.strokeDashstyle=strokeDashstyle;if(this.features[key].attributes.shadow){this.features[key].style.strokeWidth=parseInt(this.features[key].style.strokeWidth)+facadeVariables.capaTrafico.lineShadowWidthInc}}}this.drawFeature(this.features[key])}}}function deactivateZoomEvents(){if(!this.reactivateZoomBox){for(var j in this.map.controls){if((this.map.controls[j].CLASS_NAME=="OpenLayers.Control.IAAA_ZoomBox")&&this.map.controls[j].active){this.reactivateZoomBox=true;this.controlIndexAux=j;if(this.map.controls[j].disableClick){this.map.controls[j].disableClick(true)}}}}}function activateZoomEvents(){if(this.reactivateZoomBox){if(this.controlIndexAux&&this.map.controls[this.controlIndexAux]&&this.map.controls[this.controlIndexAux].disableClick){this.map.controls[j].disableClick(false)}this.reactivateZoomBox=false}}function _overFeature(feature){if(feature&&feature.layer&&feature.layer.deactivateZoomEvents){feature.layer.deactivateZoomEvents()}if(feature&&feature.layer&&feature.layer.containsPoints){OpenLayers.Control.SelectFeature.prototype.overFeature.apply(this,arguments)}}function _outFeature(feature){if(feature&&feature.layer&&feature.layer.containsPoints){OpenLayers.Control.SelectFeature.prototype.outFeature.apply(this,arguments)}if(feature&&feature.layer&&feature.layer.activateZoomEvents){feature.layer.activateZoomEvents()}}this.deshabilitarRedimensionMapa=function(){try{if(!this.map){return}}catch(e){return}try{this.map.events.unregister("movestart",this.map,this.map.updateSize)}catch(e){}if(this.map.updateSizeDestroy){OpenLayers.Event.stopObserving(window,"resize",this.map.updateSizeDestroy)}else{this.map.events.unregister("resize",this.map,this.map.updateSize)}facadeVariables.currentMapSize=this.map.getCurrentSize();if(isNaN(facadeVariables.currentMapSize.w)||isNaN(facadeVariables.currentMapSize.h)){facadeVariables.currentMapSize=this.map.getSize()}facadeVariables.mapResizeDisabled=true};this.habilitarRedimensionMapa=function(updateSize){try{if(!this.map){return}}catch(e){return}if(facadeVariables&&facadeVariables.mapResizeDisabled){if(updateSize){if(facadeVariables&&facadeVariables.currentMapSize){this.map.updateSize(facadeVariables.currentMapSize)}else{this.map.updateSize()}}if(OpenLayers.String.contains(navigator.appName,"Microsoft")){this.map.events.register("resize",this.map,this.map.updateSize)}else{this.map.updateSizeDestroy=OpenLayers.Function.bind(this.map.updateSize,this.map);OpenLayers.Event.observe(window,"resize",this.map.updateSizeDestroy)}facadeVariables.mapResizeDisabled=false}};function _borrarCapaJSON(layerName){if(!facadeVariables.layersOnTopList||!getMap()){return}else{var forceRecluster=false;if(facadeVariables.clusterStrategy&&facadeVariables.clusterStrategy.features){forceRecluster=true}var newPoisLayers=[];var poisLayerCounter=0;var newLayersOnTop=[];var layer;var newLegendNamesList=[];for(var i=0,iLen=facadeVariables.layersOnTopList.length;i<iLen;i++){layer=facadeVariables.layersOnTopList[i];if(layer.name==layerName){facadeVariables.layersOnTopList[i].setVisibility(false);facadeVariables.layersOnTopList[i].removeAllFeatures();getMap().removeLayer(facadeVariables.layersOnTopList[i]);facadeVariables._poisVisibleCount--;for(var j=poisLayerCounter,jLen=facadeVariables._poisLayers.length;j<jLen;j++){if(facadeVariables.layersOnTopList[i].name!=facadeVariables._poisLayers[j].name){newPoisLayers=newPoisLayers.concat(facadeVariables._poisLayers[j])}else{poisLayerCounter=j+1;break}}delete facadeVariables.layerLegendInfo[layerName];newLegendNamesList=[];for(var z=0,zLen=facadeVariables.legendLayerNamesList.length;z<zLen;z++){if(layerName!=facadeVariables.legendLayerNamesList[z]){newLegendNamesList.push(facadeVariables.legendLayerNamesList[z])}}facadeVariables.legendLayerNamesList=newLegendNamesList}else{newLayersOnTop.push(layer)}}this.contadorCapasVisibles=this.contadorCapasVisibles-1;facadeVariables._poisLayers=newPoisLayers;var selectLayers=facadeVariables._poisLayers;if(facadeVariables.capaTrafico){selectLayers=selectLayers.concat([facadeVariables.capaTrafico])}selectLayers=selectLayers.concat(newLayersOnTop);if(facadeVariables.showTooltipControl){facadeVariables.showTooltipControl.unselectAllFeatures()}facadeVariables.layersOnTopList=newLayersOnTop;_addSelectFeatureControl(selectLayers);if(forceRecluster){facadeVariables.clusterStrategy.cluster()}}}}function checkClickInGeorreferenceLayerElements(g,l){if(g&&l){var f={x:l.x,y:l.y};var h=false;var d;var b=null;var k=null;if(facadeVariables._georreferenceLayers[g]&&facadeVariables._georreferenceLayers[g].visibility&&facadeVariables._georreferenceLayers[g].markers&&facadeVariables._georreferenceLayers[g].markers.length){for(var c=0,a=facadeVariables._georreferenceLayers[g].markers.length;c<a;c++){d=facadeVariables._georreferenceLayers[g].markers[c];b=d.lonlat&&getMap().getViewPortPxFromLonLat(d.lonlat);markerOffset=(d&&d.icon&&d.icon.offset)||{x:0,y:0};b={x:b.x+markerOffset.x,y:b.y+markerOffset.y};k=(d&&d.icon&&d.icon.size)||{w:0,h:0};if(b&&k&&(f.x>=b.x)&&(f.x<=(b.x+k.w))&&(f.y>=b.y)&&(f.y<=(b.y+k.h))){if(d.handlePopup){d.handlePopup()}return true}}}}return false}function checkClickInGeorreferenceLayers(a){try{if(a){if(facadeVariables.geoLocationLayerTitle){if(!checkClickInGeorreferenceLayerElements(facadeVariables.geoLocationLayerTitle,a)){if(facadeVariables.searchLocationLayerTitle){checkClickInGeorreferenceLayerElements(facadeVariables.searchLocationLayerTitle,a)}}}else{if(facadeVariables.searchLocationLayerTitle){checkClickInGeorreferenceLayerElements(facadeVariables.searchLocationLayerTitle,a)}}}}catch(b){OpenLayers.IAAA_Utils.report("log","Error en checkClickInGeorreferenceLayers: \n"+b)}}function checkPopupContent(y,p,o,b,g){var w=this.map;if(!w){w=getMap();if(!w){return}}var h=document.getElementById("contentCheckContainer");b=(((b!=undefined)&&(b!=null))?b:false);if(h==null){h=document.createElement("DIV");document.getElementById("map").appendChild(h);h.style.position="absolute";h.style.top=0;h.style.left=0;h.style.zIndex="0"}else{h.style.display="block"}if(w&&w.screenPopupLimit&&w.screenPopupLimit.w&&w.size&&w.size.w){h.style.width=parseInt(Math.floor(w.size.w*w.screenPopupLimit.w)-((o)?(checkContentLogoWidth+checkContentLogoPadding):checkContentLogoPadding)-checkContentPaddingWidth)+"px"}else{if(!o){h.style.width=(100-((checkContentPaddingWidth)*100/screen.width))+"%"}else{h.style.width=(100-((checkContentLogoWidth+checkContentLogoPadding+checkContentPaddingWidth)*100/screen.width))+"%"}}var m,c;if(y){m=document.createElement("DIV");m.className="titulo";m.innerHTML=y;h.appendChild(m)}if(p){c=document.createElement("DIV");c.className="maptipDescripcion";c.innerHTML=(y?'<font class="tituloGap"><br/></font>':"")+p;h.appendChild(c)}var u;var n;var l=false;if(p){n=c.getElementsByTagName("img");var z;for(var q=0,r=n.length;q<r;q++){z=n[q];if(z.width==0||z.height==0||!z.complete){l=true;break}}}if(w&&w.screenPopupLimit&&w.screenPopupLimit.h&&w.size&&w.size.h){u=parseInt(Math.floor(w.size.h*w.screenPopupLimit.h))}else{if(w.size&&w.size.h){u=parseInt(w.size.h)}else{u=parseInt(screen.height)}}u=u-popupHeightCheckSafeMargin;u-=30;var d=((y)?parseInt(m.clientHeight)+popupHeightGapPaddingSafeMargin:0);var t=((p)?parseInt(c.clientHeight):0);var x="none";if(((d+t)>=u)||l){if(d>t){x="title"}else{var f=messages.maptipclicktoseeinfo;if(g&&g.attributes&&g.attributes.hasSemanticInfo){f=messages.maptipclicktoseeinfosemantic}c.innerHTML=(y?'<font class="tituloGap"><br/></font>':"")+f;var k=((p)?parseInt(c.clientHeight):0);if((d+k)>=u){x="title_description"}else{x="description"}}}else{if(b){var v;if(w&&w.screenPopupLimit&&w.screenPopupLimit.w&&w.size&&w.size.w){v=parseInt(Math.floor(w.size.w*w.screenPopupLimit.w))}else{if(w.size&&w.size.w){v=parseInt(w.size.w)}else{v=parseInt(screen.width)}}v=v-popupWidthCheckSafeMargin;var a=((y)?parseInt(m.clientWidth):0);var s=0;if(p){if(c&&c.children){if(c.children[0].nodeName.toLowerCase()!="meta"){s=parseInt(c.children[0].clientWidth)}else{s=parseInt(c.children[1].clientWidth)}}}if((a+s)>=v){if(a>s){x="title"}else{var f=messages.maptipclicktoseeinfo;if(g&&g.attributes&&g.attributes.hasSemanticInfo){f=messages.maptipclicktoseeinfosemantic}c.innerHTML=(y?'<font class="tituloGap"><br/></font>':"")+f;var k=((p)?parseInt(c.clientHeight):0);if((d+k)>=u){x="title_description"}else{x="description"}}}}}if(m){h.removeChild(m)}if(c){h.removeChild(c)}h.style.display="none";return x}function _showPopup(k,D,a,c){var H=this.map;if(!H){H=getMap();if(!H){return}}if((!k.popup||(k.popup&&!k.popup.div))&&((((k.attributes.title!="Sin_nombre")&&(k.attributes.title!=null))||(k.attributes.description!=null))||(k.attributes.routeElement))){if(mobileNavigator&&facade&&facade.deshabilitarRedimensionMapa){facade.deshabilitarRedimensionMapa()}try{if(k.layer&&k.layer.zoomControlIndex&&(k.layer.zoomControlIndex!=-1)){var t=H.controls[k.layer.zoomControlIndex];if((t.active)&&!((t.handler)&&(t.handler.zoomBox))){t.deactivate();k.layer.reactivateZoom=true}}}catch(E){}var q={size:k.layer.popupAnchorSize,offset:k.layer.popupAnchorOffset};var b=(k.layer.name==facadeVariables.geoLocationLayerTitle)||(k.layer.name==facadeVariables.searchLocationLayerTitle);var G,s;if((k.geometry.CLASS_NAME!="OpenLayers.Geometry.LineString")&&(k.geometry.CLASS_NAME!="OpenLayers.Geometry.Polygon")){G=k.geometry.getCentroid();s=new OpenLayers.LonLat(G.x,G.y)}else{if((c!=null)&&(c!=undefined)&&(c.handlers!=null)&&(c.handlers!=undefined)&&(c.handlers.feature!=null)&&(c.handlers.feature!=undefined)&&(c.handlers.feature.evt!=null)&&(c.handlers.feature.evt!=undefined)){s=H.getLonLatFromPixel(c.handlers.feature.evt.xy)}else{G=k.geometry.getCentroid();s=new OpenLayers.LonLat(G.x,G.y)}}var f=(D)?function(i){OpenLayers.Event.stop(i);if(mobileNavigator&&this.feature){this.feature.popup=null;this.feature.attributes.openedOnInit=false;this.feature=null}this.destroy();return false}:null;var A=new Object();for(var y in facadeVariables.popupOptions){A[y]=facadeVariables.popupOptions[y]}if((a!=null)&&(a!=undefined)){A.popupImageSrc=facadeVariables.popupOptions.popupImageVector[a]}else{if((parseInt(k.attributes.priority)==1)){A.popupImageSrc=facadeVariables.popupOptions.popupImageVector.poisPopupPriority}else{A.popupImageSrc=facadeVariables.popupOptions.popupImageVector.poisPopupNoPriority}}if((k.layer.popupOpacity!=undefined)&&(k.layer.popupOpacity!=null)){A.opacity=k.layer.popupOpacity}else{A.opacity=facadeVariables.defaultPopupOpacity}if(facadeVariables.popupOptions&&facadeVariables.popupOptions.showLogo&&((k.attributes.showLogo==undefined)||(k.attributes.showLogo==true))){A.logoImgSrc=k.attributes.icon;if(facadeVariables.popupOptions.logoWidth&&facadeVariables.popupOptions.logoHeight){A.logoSize=new OpenLayers.Size(facadeVariables.popupOptions.logoWidth,facadeVariables.popupOptions.logoHeight)}}if((k.layer.logoPosition!=undefined)&&(k.layer.logoPosition!=null)){A.logoPosition=k.layer.logoPosition;if(A.logoPosition==1){A.useLogoMarginWidth=false}}if((A.updateZIndex!=undefined)&&(A.updateZIndex!=null)&&(A.updateZIndex!=false)){if(H&&H.popups&&(H.popups.length>0)){var w=H.popups[H.popups.length-1].contentDiv.style.zIndex;if((w!=null)&&(w!=undefined)&&(H.popups[H.popups.length-1].zIndexChange!=null)){if(!mobileNavigator){A.zIndexChange=H.popups[H.popups.length-1].contentDiv.style.zIndex}else{A.zIndexChange=Number(H.popups[H.popups.length-1].zIndexChange)+1}}else{if(a){A.zIndexChange=facadeVariables.popupOptions.zIndexBase}else{A.zIndexChange=facadeVariables.popupOptions.zIndexBase+1}}}else{if(a){A.zIndexChange=facadeVariables.popupOptions.zIndexBase}else{A.zIndexChange=facadeVariables.popupOptions.zIndexBase+1}}}if(!b){if(poisClientStyle.stemSize){A.stemSize=poisClientStyle.stemSize}if(poisClientStyle.stemImageOffset){A.stemImageOffset=poisClientStyle.stemImageOffset}if(poisClientStyle.stemDivOffset){A.stemDivOffset=poisClientStyle.stemDivOffset}if(poisClientStyle.popupDivOffset){A.popupDivOffset=poisClientStyle.popupDivOffset}if(poisClientStyle.stemOffsetRight){A.stemSizeOffsetRight=poisClientStyle.stemSizeOffsetRight}if(poisClientStyle.stemSizeOffsetLeft){A.stemSizeOffsetLeft=poisClientStyle.stemSizeOffsetLeft}if(poisClientStyle.imageSize){A.imageSize=poisClientStyle.imageSize}if(poisClientStyle.maxSize){A.maxSize=poisClientStyle.maxSize}if(poisClientStyle.blockPositionRightOffset){A.blockPositionRightOffset=poisClientStyle.blockPositionRightOffset}if(poisClientStyle.blockOpacity){if(navigatorInfo){if((navigatorInfo[0]=="msie")&&(parseInt(navigatorInfo[1])<=6)){A.blockOpacity={stem:1}}else{A.blockOpacity=poisClientStyle.blockOpacity}}else{A.blockOpacity={stem:1}}}}else{if((k.layer.name==facadeVariables.searchLocationLayerTitle)){for(var z in streetLocationStyle){A[z]=streetLocationStyle[z]}}else{for(var z in geoLocationStyle){A[z]=geoLocationStyle[z]}}}var C="none";if(mobileNavigator&&((screen.width<=maxWidthToShowExpandedPopup)||((screen.height<=maxWidthToShowExpandedPopup)&&(screen.width>=screen.height)))){C=checkPopupContent(k.attributes.title,k.attributes.description,true,k)}var r="";var p="";var o=false;var x=false;if(mobileNavigator&&k.attributes.link){x=true}if(C!="none"){if((C!="title")&&(C!="title_description")){if((k.attributes.title!="Sin_nombre")&&(k.attributes.title!=null)){if(k.attributes.title!="Ver detalle"){r+='<div class="titulo">'+k.attributes.title+"</div>"}var g;if(x){g='<a class="titulo" href="'+k.attributes.link+'" target="_blank">'+k.attributes.title+"</a>"}else{g=k.attributes.title}p+='<div class="titulo">'+g+"</div>"}}else{var g,m;if(x){g='<a class="titulo" href="'+k.attributes.link+'" target="_blank">'+k.attributes.title+"</a>"}else{g=k.attributes.title}m=k.attributes.title.substring(0,10)+"...";r+='<div class="titulo">'+m+"</div>";p+='<div class="titulo">'+g+"</div>"}var v='<div class="maptipDescripcion">';if(r!=""){v+='<font class="tituloGap"><br/></font>'}var h=messages.maptipclicktoseeinfo;if(k&&k.attributes&&k.attributes.hasSemanticInfo){h=messages.maptipclicktoseeinfosemantic}v+=h+"</div>";r+=v;v='<div class="maptipDescripcion">';if(r!=""){v+='<font class="tituloGap"><br/></font>'}v+=k.attributes.description;if(k.attributes.disableAsDestination!=true){var F=[];if(k.geometry.CLASS_NAME=="OpenLayers.Geometry.Point"){F.push(k.geometry.x);F.push(k.geometry.y)}F.push((k.attributes.name?k.attributes.name:"destino"));F.push(true);if(F.length>=2){v+="<div class='maptipDescripcion directionsLink' onclick='javascript:getDirections("+F.toString()+");return false;'>"+messages.directions+"</div>";v+="<br><br>"}}v+="</div>";p+=v;o=true}else{if(k.attributes.routeElement){r+="<table class='routeElementTable' cellpadding='0' cellspacing='2'><tbody>";r+="<tr>";var l="";var B=k.attributes.routeDetails;if(B.routeSummary){if(B.directions){l+=B.directions+"<br>"}l+=messages.routeDuration+": <b>"+B.routeSummary.duration+"</b>. "+messages.routeDistance+": <b>"+B.routeSummary.distance+".</b>"}else{if(B.directions){l+=B.directions}else{if(B.lineNumber&&B.stopName){if(B.transfer){l+=messages.routeChange+" "+messages["transport_"+B.transitMode]+":<br>"}else{if(B.departure){l+=messages.routeTake+" "+messages["transport_"+B.transitMode]+":<br>"}else{l+=messages.routeTakeoff+" "+messages["transport_"+B.transitMode]+":<br>"}}l+=messages.routeLine+" <b>"+B.lineNumber+"</b>";if(B.lineHeadsign){l+=", "+messages.routeDirection.toLowerCase()+" <b>"+B.lineHeadsign+"</b><br>"}else{l+="<br>"}l+=messages.routeStop+" <b>"+B.stopName+"</b>"}else{if(B.lineNumber){l+=messages.routeLine+" <b>"+B.lineNumber+"</b><br>";if(B.lineHeadsign){l+=messages.routeDirection+" <b>"+B.lineHeadsign+"</b>"}}}}}if(l!=""){r+="<td>"+l+"</td>"}else{return}if(B.origin!=true){var n=(k.style.externalGraphic||k.attributes.externalGraphic);var d=(k.style.originalGraphicWidth||k.attributes.originalGraphicWidth);var u=(k.style.originalGraphicHeight||k.attributes.originalGraphicHeight);r+="<td style='width: "+(d+10)+"; text-align: center;'>";r+="<img style='width: "+d+"; height: "+u+";' src='"+n+"'/>";r+="</td>"}r+="</tr>";r+="</tbody></table>"}else{if((k.attributes.title!="Sin_nombre")&&(k.attributes.title!=null)){var g;if(x){g='<a class="titulo" href="'+k.attributes.link+'" target="_blank">'+k.attributes.title+"</a>"}else{g=k.attributes.title}r+='<div class="titulo">'+g+"</div>"}if(k.attributes.description!=null){r+='<div class="maptipDescripcion">';if(r!=""){r+='<font class="tituloGap"><br/></font>'}r+=k.attributes.description+"</div>"}if(k.attributes.disableAsDestination!=true){var F=[];if(k.geometry.CLASS_NAME=="OpenLayers.Geometry.Point"){F.push(k.geometry.x);F.push(k.geometry.y)}if(k.attributes.name){F.push(k.attributes.name)}if(F.length>=2){r+="<div class='maptipDescripcion directionsLink' onclick='javascript:getDirections("+F.toString()+");return false;'>"+messages.directions+"</div>"}r="<div class="+(mobileNavigator?'"maptipMobileContentDivStyle"':'"maptipContentDivStyle"')+">"+r+"</div>"}}}if(mobileNavigator){A.panMapIfOutOfView=false}k.popup=new OpenLayers.Popup.IAAA_FramedCloud(k.id+"_popup",s,k.data.popupSize,r,q,D,f,A);updatePopup(k.popup,A);k.popup.setBorder=function(i){return;if(i!=undefined){this.border=i}if(this.div!=null){try{this.div.style.border=this.border}catch(I){this.div.style.setAttribute("border",this.border)}}};k.popup.poisPopup=true;k.popup.border=0;k.popup.div.className=(a)?a:"poisPopup"+((parseInt(k.attributes.priority)==1)?"":"No")+"Priority";k.popup.events.registerPriority("mouseover",k.popup.div,function(i){OpenLayers.Event.stop(i);return false});k.popup.events.register("mousemove",k.popup.div,function(i){OpenLayers.Event.stop(i);return false});if(mobileNavigator){if(o){k.popup.div.docParent=parent;k.popup.div.setAttribute("fullContent",p);if("touchend" in document){k.popup.events.register("touchend",k.popup.div,function(i){OpenLayers.Event.stop(i);return false})}k.popup.events.register(("touchstart" in document)?"touchstart":"click",k.popup.div,function(i){OpenLayers.Event.stop(i);var J="";J=this.getAttribute("fullContent");var I="";if(this.children[0]&&this.children[0].children[this.id+"_FrameLogoDiv"]){I=this.children[0].children[this.id+"_FrameLogoDiv"].innerHTML}_showExpandedPopup(J,I);return false});if("touchstart" in document){k.popup.events.register("click",k.popup.div,function(i){OpenLayers.Event.stop(i);return false})}}}H.addPopup(k.popup,false,{updateZIndex:A.updateZIndex,addToDiv:facadeVariables.renderLayerDiv});if(mobileNavigator){k.popup.feature=k}if((navigator.userAgent.indexOf("Firefox/2.")>=0)){k.popup.div.style.zIndex=A.zIndexChange}try{if(k.layer&&k.layer.zoomControlIndex&&(k.layer.zoomControlIndex!=-1)){var t=H.controls[k.layer.zoomControlIndex];if((!t.active)&&k.layer.reactivateZoom){t.activate();k.layer.reactivateZoom=false}}}catch(E){}if(mobileNavigator&&getFacade()&&getFacade().habilitarRedimensionMapa){getFacade().habilitarRedimensionMapa()}}}function _showExpandedPopup(h,d){var b=getWindowWidth(this);var a=getWindowHeight(this);popupWindowLeft="0";popupWindowTop="0";popupWindowWidth=b;popupWindowHeight=a;var f=document.createElement("DIV");f.setAttribute("UNSELECTABLE","on");f.id="expandedPopup";f.style.position="absolute";f.style.top=0;f.style.left=0;f.style.height="100%";f.style.width="100%";f.style.zIndex="1000000000";var k=document.createElement("DIV");k.style.position="absolute";k.style.top="5%";k.style.right="5%";k.style.zIndex="11000";k.innerHTML='<img src="img/others/close_black_white.png"/>';expandedPopupContainerBackground=document.createElement("DIV");expandedPopupContainerBackground.setAttribute("UNSELECTABLE","on");expandedPopupContainerBackground.id="expandedPopupContainerBackground";expandedPopupContainerBackground.style.position="absolute";expandedPopupContainerBackground.style.top=0;expandedPopupContainerBackground.style.left=0;expandedPopupContainerBackground.style.height="100%";expandedPopupContainerBackground.style.width="100%";expandedPopupContainerBackground.style.zIndex="11001";expandedPopupContainerBackground.style.backgroundColor=expandedPopupBackgroundColor;expandedPopupContainerBackground.style.opacity="0.8";expandedPopupContainer=document.createElement("DIV");expandedPopupContainer.setAttribute("UNSELECTABLE","on");expandedPopupContainer.id="expandedPopupContainer";expandedPopupContainer.style.position="absolute";expandedPopupContainer.style.top="5%";expandedPopupContainer.style.left="5%";expandedPopupContainer.style.height="90%";expandedPopupContainer.style.width="90%";expandedPopupContainer.style.zIndex="11001";expandedPopupContainer.style.backgroundColor=expandedPopupBackgroundColor;expandedPopupContainerContent=document.createElement("DIV");expandedPopupContainerContent.setAttribute("UNSELECTABLE","on");expandedPopupContainerContent.id="expandedPopupContainerContent";expandedPopupContainerContent.style.position="absolute";expandedPopupContainerContent.style.top="5%";expandedPopupContainerContent.style.left="5%";expandedPopupContainerContent.style.height="85%";expandedPopupContainerContent.style.width="75%";expandedPopupContainerContent.style.zIndex="11002";if(mobileNavigator&&(navigator.appName.toLowerCase().indexOf("opera")!=-1)){expandedPopupContainerContent.innerHTML='<div id="expandedPopupContent" style="position:relative; top:10px; left:10px; height:100%; width:100%;opacity:1.0; background-color: '+expandedPopupBackgroundColor+'; overflow:hidden;"><div id="innerContent" style="position:relative; height:100%;width:100%;">'+h+"</div></div>"}else{expandedPopupContainerContent.innerHTML='<div id="expandedPopupContent" style="margin-top: 10px; margin-left: 10px; position:relative; top:0; left:0; height:100%;opacity:1.0; background-color: '+expandedPopupBackgroundColor+'; overflow:auto;">'+h+"</div>"}expandedPopupContainerScrollUp=document.createElement("DIV");expandedPopupContainerScrollUp.setAttribute("UNSELECTABLE","on");expandedPopupContainerScrollUp.id="expandedPopupContainerScrollUp";expandedPopupContainerScrollUp.style.position="absolute";try{var i=parseInt(1700/parseInt(a));expandedPopupContainerScrollUp.style.top=(i+10)+"%"}catch(g){expandedPopupContainerScrollUp.style.top="20%"}expandedPopupContainerScrollUp.style.right="5%";expandedPopupContainerScrollUp.innerHTML='<img src="img/others/scroll_up_black_white.png"/>';expandedPopupContainerScrollUp.style.zIndex="1000001003";expandedPopupContainerScrollDown=document.createElement("DIV");expandedPopupContainerScrollDown.setAttribute("UNSELECTABLE","on");expandedPopupContainerScrollDown.id="expandedPopupContainerScrollDown";expandedPopupContainerScrollDown.style.position="absolute";if(d!=""){try{var c=parseInt(3100/parseInt(a));expandedPopupContainerScrollDown.style.bottom=(c+10)+"%"}catch(g){expandedPopupContainerScrollDown.style.bottom="20%"}}else{expandedPopupContainerScrollDown.style.bottom="20%"}expandedPopupContainerScrollDown.style.right="5%";expandedPopupContainerScrollDown.innerHTML='<img src="img/others/scroll_down_black_white.png"/>';expandedPopupContainerScrollDown.style.zIndex="11003";expandedPopupContainer.appendChild(expandedPopupContainerScrollUp);expandedPopupContainer.appendChild(expandedPopupContainerScrollDown);expandedPopupContainer.appendChild(expandedPopupContainerContent);if(d!=""){expandedPopupContainerLogo=document.createElement("DIV");expandedPopupContainerLogo.setAttribute("UNSELECTABLE","on");expandedPopupContainerLogo.id="expandedPopupContainerContentLogo";expandedPopupContainerLogo.style.position="absolute";expandedPopupContainerLogo.style.bottom="5%";expandedPopupContainerLogo.style.right="5%";expandedPopupContainerLogo.style.height="26px";expandedPopupContainerLogo.style.width="26px";expandedPopupContainerLogo.style.zIndex="11002";expandedPopupContainerLogo.innerHTML='<div id="popupLogo" style="overflow: hidden;background: url(\'img/others/logoBackground_26x26.png\') no-repeat scroll right top transparent;width: 26px; height: 26px; position: absolute; bottom: 5px; right: 5px; opacity:1.0;background-color: '+expandedPopupBackgroundColor+';">'+d+"</div>";expandedPopupContainer.appendChild(expandedPopupContainerLogo)}expandedPopupContainer.appendChild(k);f.appendChild(expandedPopupContainerBackground);f.appendChild(expandedPopupContainer);if(mobileNavigator&&parent&&parent.getFacade){if(parent.getFacade().ocultaInterfaz){parent.getFacade().ocultaInterfaz(true)}else{if(parent.getFacade().deshabilitaBotones){parent.getFacade().deshabilitaBotones()}}}k.parentRef=parent;k.setAttribute("parentRef",parent);k.innerHTML='<a href=#" onclick="javascript:closeExpandedPopup();return false;">'+k.innerHTML+"</a>";expandedPopupContainerScrollUp.innerHTML='<a href=#" onclick="javascript:scrollUpPopupContent();return false;">'+expandedPopupContainerScrollUp.innerHTML+"</a>";expandedPopupContainerScrollDown.innerHTML='<a href=#" onclick="javascript:scrollDownPopupContent();return false;">'+expandedPopupContainerScrollDown.innerHTML+"</a>";if(document.getElementById("expandedPopupDiv")){document.getElementById("expandedPopupDiv").appendChild(f);document.getElementById("expandedPopupDiv").style.display="block";document.getElementById("expandedPopupDiv").style.visibility="visible"}}function updatePopup(b,d){if(b.addLogo){if(b.logoDiv&&b.imgLogoDiv){var a=(window.location.protocol+"").slice(0,(window.location.protocol+"").length-1);var c;if(d.logoImgSrc.slice(0,4)!="http"){if(d.logoImgSrc.slice(0,2)!="//"){c=processURL(OpenLayers.Util.getImagesLocation()+d.logoImgSrc,a.slice(0,a.length))}else{c=processURL(d.logoImgSrc,a.slice(0,a.length))}}else{c=processURL(d.logoImgSrc,a.slice(0,a.length))}b.imgLogoDiv.src=c}}}function getDirections(a,d,c,b){if(b){closeExpandedPopup()}if(parent&&parent.getFacade&&parent.getFacade().comoLlegar){parent.getFacade().comoLlegar(a,d,c)}}function changeMarkerBehaviour(a){if((navigator.appName=="Microsoft Internet Explorer")&&((a.drawMarkerChanged==null)||(a.drawMarkerChanged==undefined)||(a.drawMarkerChanged=false))){a.drawMarker=function(b){OpenLayers.Layer.Markers.prototype.drawMarker.apply(this,arguments);if(facadeVariables&&facadeVariables.renderLayerDiv){var c=b.icon.imageDiv;if(c.parentNode.id.toLowerCase().indexOf("vector.root")==-1){this.div.removeChild(c);if(this.map.popups&&(this.map.popups.length>0)){if(this.map.popups[0]){try{var f=this.map.popups[0].div;facadeVariables.renderLayerDiv.insertBefore(c,f)}catch(d){OpenLayers.IAAA_Utils.report("error","[ERROR] Insertando nodos en renderlayer")}}}else{facadeVariables.renderLayerDiv.appendChild(c)}}else{if(this.map.popups&&(this.map.popups.length>0)){try{facadeVariables.renderLayerDiv.removeChild(c)}catch(d){OpenLayers.IAAA_Utils.report("error","[ERROR] Borrando nodos de renderlayer div")}try{if(this.map.popups[0]){var f=this.map.popups[0].div;facadeVariables.renderLayerDiv.insertBefore(c,f)}}catch(d){OpenLayers.IAAA_Utils.report("error","[ERROR] Insertando nodos en renderlayerdiv")}}}if(b.icon&&b.icon.imageDiv&&b.icon.imageDiv.parentNode&&b.icon.imageDiv.parentNode.style&&b.icon.imageDiv.parentNode.style.left){b.basePositionLeft=parseInt(b.icon.imageDiv.style.left)}else{b.basePositionLeft=null}if(b.icon&&b.icon.imageDiv&&b.icon.imageDiv.parentNode&&b.icon.imageDiv.parentNode.style&&b.icon.imageDiv.parentNode.style.top){b.basePositionTop=parseInt(b.icon.imageDiv.style.top)}else{b.basePositionTop=null}if((b.updateDivPosition==null)||(b.updateDivPosition==undefined)){b.moveTo=function(h,g,i){OpenLayers.Marker.prototype.moveTo.apply(this,arguments);this.basePositionLeft=parseInt(this.icon.imageDiv.style.left);this.basePositionTop=parseInt(this.icon.imageDiv.style.top)};b.updateDivPosition=function(){if(this.map){if(this.basePositionLeft&&this.basePositionTop){var h=0;var g=0;if(this.icon&&this.icon.imageDiv&&this.icon.imageDiv.parentNode&&this.icon.imageDiv.parentNode.style&&this.icon.imageDiv.parentNode.style.left){h=parseInt(this.icon.imageDiv.parentNode.style.left);this.icon.imageDiv.style.left=(this.basePositionLeft-h)+"px"}if(this.icon&&this.icon.imageDiv&&this.icon.imageDiv.parentNode&&this.icon.imageDiv.parentNode.style&&this.icon.imageDiv.parentNode.style.top){g=parseInt(this.icon.imageDiv.parentNode.style.top);this.icon.imageDiv.style.top=(this.basePositionTop-g)+"px"}}}};b.map.events.register("moveend",b,b.updateDivPosition);b.map.events.register("resizeend",b,b.updateDivPosition);b.destroy=function(){if(facadeVariables.renderLayerDiv&&(this.updateDivPosition!=null)&&(this.updateDivPosition!=undefined)){this.map.events.unregister("moveend",this,this.updateDivPosition);this.map.events.unregister("resizeend",this,this.updateDivPosition)}OpenLayers.Marker.prototype.destroy.apply(this,arguments)}}}};a.drawMarkerChanged=true}}function moveLayerToTopZIndex(c,f){var a=null;if((f!=undefined)&&(f!=null)){a=parseInt(f)}else{if(getMap()){var d=getMap().getControlsByClass("OpenLayers.Control.SelectFeature");if(d.length!=0){var b=d[0].layer;a=parseInt(b.getZIndex())+1}}}if(a!=null){c.setZIndex(a)}}function updateLayerZindex(a,c){if(!getMap()){return}var b;if(a.map&&a.map.popups&&(a.map.popups.length>0)){if(facadeVariables.renderLayerDiv){b=(c?parseInt(c):parseInt(facadeVariables.renderLayerDiv.style.zIndex));if(!c){if(navigator.appName!="Microsoft Internet Explorer"){if(mobileNavigator&&(facadeVariables.showTooltipControl.layer.renderer.CLASS_NAME=="OpenLayers.Renderer.SVG")){if(a.name=="streetMapMarkerLayer"){b++}else{b--}}else{b++}}}a.div.style.zIndex=b}else{if((a.map.popups[0].div.style.zIndex!=null)&&(a.map.popups[0].div.style.zIndex!=undefined)&&(a.map.popups[0].div.style.zIndex!="")){a.div.style.zIndex=parseInt(a.map.popups[0].div.style.zIndex)-1}else{a.div.style.zIndex=parseInt(a.map.popups[0].contentDiv.style.zIndex)-2}}}else{if(facadeVariables.renderLayerDiv){b=(c?parseInt(c):parseInt(facadeVariables.renderLayerDiv.style.zIndex));if(navigator.appName!="Microsoft Internet Explorer"){if(!c){if(mobileNavigator&&(facadeVariables.showTooltipControl.layer.renderer.CLASS_NAME=="OpenLayers.Renderer.SVG")){if(a.name=="streetMapMarkerLayer"){b++}else{b--}}else{b++}}}a.div.style.zIndex=b}else{if(navigator.appName!="Microsoft Internet Explorer"){if(facadeVariables.markerLayerDivList==null){facadeVariables.markerLayerDivList={}}facadeVariables.markerLayerDivList[a.name]=a.div}}}}function ie11(){var a=navigator.userAgent;var b=new RegExp("Trident/.*rv:([0-9]{1,}[.0-9]{0,})");if(b.exec(a)!=null){return true}return false}function parseParamValue(a){return a.replace(new RegExp("%3D","g"),"=")};