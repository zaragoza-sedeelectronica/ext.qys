function IDEZarOL(b,n,j,p){this.map=b;this.facade=n;this.facadeVariables=j;this.currentPOIs=[];this.lastPOI=null;this.defaultProjection=((p&&p.projection)?p.projection:b.getProjection());this.defaultPOIsLayerName=((p&&p.layerName)?p.layerName:"POI");this.defaultPOIsStyle=((p&&p.style)?p.style:null);this.defaultPOIsSelectedStyle=((p&&p.selectedStyle)?p.selectedStyle:null);this.POI=c;this.addPOIs=f;this.centreMap=l;this.centreMapInPOIs=i;this.loadGeoJSON=o;this.getPOIs=g;this.deletePOIs=m;this.addNearbyResources=e;this.getNearbyResources=a;this.deleteNearbyResources=d;this._getScaleForZoom=k;this._log=h;function c(B,z,r,q,s,t){B=parseFloat(B);z=parseFloat(z);if(this.defaultProjection!=this.map.getProjection()){var w=coordTransform(this.defaultProjection,this.map.getProjection(),B,z);B=w[0];z=w[1]}var D=new OpenLayers.Geometry.Point(B,z);var A={description:(q?q:"")};for(var C in t){A[C]=t[C]}if(s!=null){A.title=s}if(r==null){r=OpenLayers.Util.extend({},this.defaultPOIsStyle)}if(r.graphicWidth){r.poisIconsWidths=[r.graphicWidth*0.5,r.graphicWidth*0.66,r.graphicWidth*0.8,r.graphicWidth]}if(r.graphicHeight){r.poisIconsHeights=[r.graphicHeight*0.5,r.graphicHeight*0.66,r.graphicHeight*0.8,r.graphicHeight]}var u=new OpenLayers.Feature.Vector(D,A,r);var v={feature:u};if(s){v.name=s}if(q){v.maptip=q}return v}function f(x,w,A,C){if(!(OpenLayers.Util.isArray(x))){x=[x]}if((w==null)||(w=="")){w=this.defaultPOIsLayerName}this._log("Añadiendo "+x.length+" punto(s) de interés a la capa '"+w+"'...");var q=null;for(var u=0,y=this.map.layers.length;u<y;u++){var v=this.map.layers[u];if((typeof v.title!="undefined")&&(v.title!="")&&(v.title==w)){q=v;break}}var s=(w=="editable");var r=[];for(var u=0,y=x.length;u<y;u++){if(w!=this.defaultPOIsLayerName){if(x[u].feature.attributes.title==null){if(typeof A=="string"){x[u].feature.attributes.title=x[u].feature.attributes[A]}else{x[u].feature.attributes.title=w}}}if(s){x[u].feature.style.cursor="pointer"}x[u].layerName=w;r.push(x[u].feature)}this.currentPOIs.push.apply(this.currentPOIs,x);this.lastPOI=this.currentPOIs[this.currentPOIs.length-1];if(q!=null){q.addFeatures(r)}else{if(this.facade){this._log("Creando capa '"+w+"'...");var t=this.map.layers.length;var z={title:w,id:t+""};this.facade.addPoiLayer(this.map,z,"",[t]);for(var u=0,y=r.length;u<y;u++){r[u].attributes.clusterize=(C==true)}q=this.map.layers[this.map.layers.length-1];q.addFeatures(r);q.setVisibility(true);q.containsPoints=true;if(this.facadeVariables){if(s){var B=new OpenLayers.Control.ModifyFeature(q);q.events.register("featureselected",this,function(D){D.feature.style.originalExternalGraphic=D.feature.style.externalGraphic;D.feature.style.externalGraphic=this.defaultPOIsSelectedStyle.externalGraphic;D.feature.layer.redraw()});q.events.register("featureunselected",this,function(D){D.feature.style.externalGraphic=D.feature.style.originalExternalGraphic;D.feature.layer.redraw()});this.map.addControl(B);B.activate()}else{this.facade.refreshSelectFeatureControl(this.facadeVariables._poisLayers)}}}else{this._log("ERROR: Capa '"+w+"' no encontrada")}}}function l(q,t,r){if(this.facade){q=parseFloat(q);t=parseFloat(t);if(this.defaultProjection!=this.map.getProjection()){var s=coordTransform(this.defaultProjection,this.map.getProjection(),q,t);q=s[0];t=s[1]}this.facade.centrarMapa(q,t,null,null,null,this._getScaleForZoom(r))}else{this._log("ERROR: No hay conexión con el Facade del mapa")}}function i(){if(this.facade){this.facade.centrarMapa(null,null,null,null,null,null,true)}else{this._log("ERROR: No hay conexión con el Facade del mapa")}}function o(q,x,r,u,z){if(q.features!=null){var B=[];var A=null;if(r!=null){A=r}for(var w=0,y=q.features.length;w<y;w++){var D=q.features[w];if(D.geometry&&(D.geometry.type=="Point")){var t=D.geometry.coordinates[0];var C=D.geometry.coordinates[1];var v=null;if((typeof u=="function")){v=u(D)}var s=IDEZarOLAPI.POI(t,C,A,v,null,D.properties);B.push(s)}}x=(x?x:(q.properties?q.properties.title:null));if(x==null){x=this.defaultPOIsLayerName}this.addPOIs(B,x,z,true);if(this.facadeVariables){this.facadeVariables.clusterStrategy.cluster()}}else{this._log("ERROR: Formato de GeoJSON incorrecto")}}function g(){var s=[];for(var t=0,r=this.currentPOIs.length;t<r;t++){var q=this.currentPOIs[t].feature.geometry.x;var w=this.currentPOIs[t].feature.geometry.y;if(this.map.getProjection()!=this.defaultProjection){var v=coordTransform(this.map.getProjection(),this.defaultProjection,q,w);q=v[0];w=v[1]}var u={longitude:q,latitude:w,layerName:this.currentPOIs[t].layerName};if(this.currentPOIs[t].name){u.name=this.currentPOIs[t].name}if(this.currentPOIs[t].feature.attributes.title){u.title=this.currentPOIs[t].feature.attributes.title}if(this.currentPOIs[t].maptip){u.maptip=this.currentPOIs[t].maptip}s.push(u)}return s}function m(s){var r=null;for(var u=0,q=this.map.layers.length;u<q;u++){var t=this.map.layers[u];if((typeof t.title!="undefined")&&(t.title!="")&&(t.title==s)){r=t;break}}if(r!=null){r.setVisibility(false);r.removeAllFeatures();if(this.facadeVariables){this.facadeVariables.clusterStrategy.reloadFeatures()}r.setVisibility(true)}for(var u=this.currentPOIs.length-1;u>=0;u--){if(s==this.currentPOIs[u].layerName){this.currentPOIs.splice(u,1)}}}function e(s,r){if((s>0)&&(this.lastPOI!=null)){var q=this.lastPOI.feature.geometry;this.facade.buscarRecursosCercanos(q.x,q.y,this.map.getProjection(),s,r)}else{this._log("ERROR: Debe añadirse un POI previamente e indicarse la distancia de búsqueda")}}function a(){var x=[];var u=this.facade.currentResources;if(u!=null){var w=this.map.getProjection();for(var t=0,q=u.length-1;t<=q;t++){var s=u[t];var v={};for(var r in s.attributes){v[r]=s.attributes[r]}v.x=s.geometry.x;v.y=s.geometry.y;v.srs=w;x.push(v)}}return x}function d(){this.facade.eliminarRecursosCercanos()}function k(s){if((s>=0)&&(s<this.map.baseLayer.resolutions.length)){var r=this.map.baseLayer.resolutions[s];var q=this.map.baseLayer.units;return OpenLayers.Util.getScaleFromResolution(r,q)}else{this._log("ERROR: Nivel de zoom no soportado (desde 0 a "+(this.map.baseLayer.resolutions.length-1)+")");return this.map.getScale()}}function h(q){if((typeof console!="undefined")&&console.log){console.log(q)}}};